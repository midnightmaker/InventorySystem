@model InventorySystem.ViewModels.CreateExpenseItemViewModel
@using InventorySystem.Helpers
@using InventorySystem.Models.Enums
@{
    ViewData["Title"] = "Add Expense Item";
    var expenseTypeDisplay = Model.ItemType switch
    {
        ItemType.Expense => "Operating Expense",
        ItemType.Utility => "Utility Expense", 
        ItemType.Subscription => "Subscription",
        _ => "Expense Item"
    };
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-plus"></i> Add @expenseTypeDisplay</h1>
        <small class="text-muted">Create a new @expenseTypeDisplay.ToLower() for expense tracking and financial reporting</small>
    </div>
    <div class="btn-group">
        <a href="/Items?itemTypeFilter=@Model.ItemType" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to @Model.ItemType.ToString()s
        </a>
        <a href="/Expenses/Reports" class="btn btn-outline-info">
            <i class="fas fa-chart-bar"></i> Expense Reports
        </a>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <div class="col-md-8">
        <form asp-action="CreateExpense" asp-controller="Items" enctype="multipart/form-data" method="post" id="createExpenseForm">

            <!-- Basic Information Card -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="PartNumber" class="form-label">
                                    <i class="fas fa-hashtag text-primary"></i>
                                    Expense Code <span class="text-danger">*</span>
                                </label>
                                <input asp-for="PartNumber" class="form-control" required placeholder="e.g., EXP-001, UTIL-001" />
                                <span asp-validation-for="PartNumber" class="text-danger"></span>
                                <div class="form-text">Unique identifier for this expense item</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Version" class="form-label">
                                    <i class="fas fa-code-branch text-info"></i>
                                    Version <span class="text-danger">*</span>
                                </label>
                                <input asp-for="Version" class="form-control" placeholder="A" />
                                <span asp-validation-for="Version" class="text-danger"></span>
                                <div class="form-text">Version for tracking changes (A, B, C, etc.)</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">
                            <i class="fas fa-file-text text-success"></i>
                            Description <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Description" class="form-control" required placeholder="Brief description of the expense item" />
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Comments" class="form-label">
                            <i class="fas fa-comment text-muted"></i>
                            Comments
                        </label>
                        <textarea asp-for="Comments" class="form-control" rows="3" placeholder="Additional details, notes, or specifications"></textarea>
                        <span asp-validation-for="Comments" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Expense Properties Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-cog"></i> Expense Properties</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="ItemType" class="form-label">
                                    <i class="fas fa-tags text-warning"></i>
                                    Expense Type <span class="text-danger">*</span>
                                </label>
                                <select asp-for="ItemType" class="form-select" id="expenseTypeSelect">
                                    <option value="5" selected="@(Model.ItemType == ItemType.Expense)">Expense - General operating expenses</option>
                                    <option value="7" selected="@(Model.ItemType == ItemType.Utility)">Utility - Electricity, water, internet, etc.</option>
                                    <option value="6" selected="@(Model.ItemType == ItemType.Subscription)">Subscription - Recurring software/services</option>
                                    <option value="2" selected="@(Model.ItemType == ItemType.Service)">Service - Professional services, consulting, labor</option>
                                    <option value="3" selected="@(Model.ItemType == ItemType.Virtual)">Virtual - Digital assets, licenses, software</option>
                                </select>
                                <span asp-validation-for="ItemType" class="text-danger"></span>
                                <div class="form-text">Type of expense for proper categorization and reporting</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UnitOfMeasure" class="form-label">
                                    <i class="fas fa-ruler-combined text-info"></i>
                                    Unit of Measure <span class="text-danger">*</span>
                                </label>
                                <select asp-for="UnitOfMeasure" class="form-select">
                                    <option value="0">Each (EA) - Individual items/services</option>
                                    <option value="1">Month (MO) - Monthly recurring</option>
                                    <option value="2">Year (YR) - Annual services</option>
                                    <option value="3">Hour (HR) - Time-based services</option>
                                    <option value="4">Day (DA) - Daily rates</option>
                                </select>
                                <span asp-validation-for="UnitOfMeasure" class="text-danger"></span>
                                <div class="form-text">How this expense is measured/billed</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="TaxCategory" class="form-label">
                                    <i class="fas fa-calculator text-secondary"></i>
                                    Tax Category
                                </label>
                                <select asp-for="TaxCategory" class="form-select">
                                    <option value="">-- Select Tax Category --</option>
                                    @foreach (var category in Model.AvailableTaxCategories)
                                    {
                                        <option value="@category" selected="@(category == Model.TaxCategory)">@category</option>
                                    }
                                </select>
                                <span asp-validation-for="TaxCategory" class="text-danger"></span>
                                <div class="form-text">Tax classification for reporting purposes</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="AccountCode" class="form-label">
                                    <i class="fas fa-code text-primary"></i>
                                    Account Code
                                </label>
                                <input asp-for="AccountCode" class="form-control" placeholder="e.g., 6100, UTIL-01" />
                                <span asp-validation-for="AccountCode" class="text-danger"></span>
                                <div class="form-text">Accounting system reference code</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recurring Expense Section -->
                    <div class="row" id="recurringSection">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input asp-for="IsRecurring" class="form-check-input" type="checkbox" id="isRecurringCheckbox" />
                                <label asp-for="IsRecurring" class="form-check-label">
                                    <i class="fas fa-sync-alt text-info"></i>
                                    This is a recurring expense
                                </label>
                                <div class="form-text">Check if this expense occurs regularly</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3" id="frequencyDiv" style="display: none;">
                                <label asp-for="RecurringFrequency" class="form-label">
                                    <i class="fas fa-calendar text-warning"></i>
                                    Frequency
                                </label>
                                <select asp-for="RecurringFrequency" class="form-select">
                                    <option value="">-- Select Frequency --</option>
                                    @foreach (var frequency in Model.AvailableFrequencies)
                                    {
                                        <option value="@frequency" selected="@(frequency == Model.RecurringFrequency)">@frequency</option>
                                    }
                                </select>
                                <span asp-validation-for="RecurringFrequency" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vendor Information Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-building"></i> Vendor Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="PreferredVendorId" class="form-label">
                                    <i class="fas fa-star text-warning"></i>
                                    Preferred Vendor
                                </label>
                                <div class="input-group">
                                    <select asp-for="PreferredVendorId" class="form-select" asp-items="ViewBag.PreferredVendors">
                                        <option value="">-- Select Vendor --</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-info" onclick="openCreateVendorModal()" title="Create New Vendor">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="PreferredVendorId" class="text-danger"></span>
                                <div class="form-text">The company/vendor that provides this expense service</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="VendorPartNumber" class="form-label">
                                    <i class="fas fa-barcode text-info"></i>
                                    Vendor Reference Number
                                </label>
                                <input asp-for="VendorPartNumber" class="form-control" placeholder="Vendor's reference or account number" />
                                <span asp-validation-for="VendorPartNumber" class="text-danger"></span>
                                <div class="form-text">Account number, service ID, or vendor reference</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Optional: Image Upload Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-image"></i> Attachment (Optional)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label asp-for="ImageFile" class="form-label">
                            <i class="fas fa-upload text-primary"></i>
                            Upload Image
                        </label>
                        <input asp-for="ImageFile" class="form-control" type="file" accept="image/*" id="imageFile" />
                        <span asp-validation-for="ImageFile" class="text-danger"></span>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i>
                            Upload invoice, receipt, or documentation (JPG, PNG, GIF, BMP - Max 5MB)
                        </div>
                    </div>

                    <div id="imagePreview" style="display: none;">
                        <label class="form-label">Image Preview:</label>
                        <div>
                            <img id="previewImg" src="#" alt="Image preview"
                                 style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px; padding: 5px;" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="card mt-3">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save"></i> Create @expenseTypeDisplay
                    </button>
                    <a href="/Items?itemTypeFilter=@Model.ItemType" class="btn btn-outline-secondary btn-lg ms-2">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Right Column - Help and Quick Info -->
    <div class="col-md-4">
        <!-- Expense Type Guide -->
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Expense Type Guide</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-danger me-2">EXP</span>
                            <div>
                                <strong>Operating Expenses</strong>
                                <small class="text-muted d-block">General business expenses, supplies, services</small>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-warning text-dark me-2">UTI</span>
                            <div>
                                <strong>Utilities</strong>
                                <small class="text-muted d-block">Electricity, water, gas, internet, phone</small>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-info me-2">SUB</span>
                            <div>
                                <strong>Subscriptions</strong>
                                <small class="text-muted d-block">Software licenses, cloud services, recurring services</small>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success me-2">SRV</span>
                            <div>
                                <strong>Services</strong>
                                <small class="text-muted d-block">Professional services, consulting, labor costs</small>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-secondary me-2">VIR</span>
                            <div>
                                <strong>Virtual</strong>
                                <small class="text-muted d-block">Digital assets, licenses, software purchases</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tax Categories Guide -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-calculator"></i> Tax Categories</h6>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <strong>Common Tax Categories:</strong>
                </small>
                <ul class="list-unstyled mt-2">
                    <li><small><i class="fas fa-chevron-right text-muted"></i> Office Expenses</small></li>
                    <li><small><i class="fas fa-chevron-right text-muted"></i> Utilities</small></li>
                    <li><small><i class="fas fa-chevron-right text-muted"></i> Software & Technology</small></li>
                    <li><small><i class="fas fa-chevron-right text-muted"></i> Professional Services</small></li>
                    <li><small><i class="fas fa-chevron-right text-muted"></i> Travel & Entertainment</small></li>
                    <li><small><i class="fas fa-chevron-right text-muted"></i> Rent & Facilities</small></li>
                </ul>
                <small class="text-info">
                    <i class="fas fa-lightbulb"></i>
                    Proper categorization helps with tax reporting and financial analysis.
                </small>
            </div>
        </div>

        <!-- Quick Tips -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb"></i> Quick Tips</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <small>
                            <i class="fas fa-check-circle text-success"></i>
                            Use descriptive expense codes (EXP-RENT, UTIL-ELECTRIC)
                        </small>
                    </li>
                    <li class="mb-2">
                        <small>
                            <i class="fas fa-check-circle text-success"></i>
                            Set up recurring expenses for automatic tracking
                        </small>
                    </li>
                    <li class="mb-2">
                        <small>
                            <i class="fas fa-check-circle text-success"></i>
                            Upload receipts/invoices for better documentation
                        </small>
                    </li>
                    <li class="mb-2">
                        <small>
                            <i class="fas fa-check-circle text-success"></i>
                            Assign vendors for easier expense tracking
                        </small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Create Expense Item page loaded');

            // Handle recurring expense checkbox
            const isRecurringCheckbox = document.getElementById('isRecurringCheckbox');
            const frequencyDiv = document.getElementById('frequencyDiv');

            if (isRecurringCheckbox && frequencyDiv) {
                isRecurringCheckbox.addEventListener('change', function () {
                    if (this.checked) {
                        frequencyDiv.style.display = 'block';
                    } else {
                        frequencyDiv.style.display = 'none';
                        const frequencySelect = frequencyDiv.querySelector('select');
                        if (frequencySelect) {
                            frequencySelect.value = '';
                        }
                    }
                });

                // Initial state
                if (isRecurringCheckbox.checked) {
                    frequencyDiv.style.display = 'block';
                }
            }

            // Handle image preview
            const imageFileInput = document.getElementById('imageFile');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            if (imageFileInput && imagePreview && previewImg) {
                imageFileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            previewImg.src = e.target.result;
                            imagePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.style.display = 'none';
                    }
                });
            }

            // Form validation
            const form = document.getElementById('createExpenseForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    const partNumber = document.querySelector('input[name="PartNumber"]').value.trim();
                    const description = document.querySelector('input[name="Description"]').value.trim();

                    if (!partNumber || !description) {
                        e.preventDefault();
                        alert('Please fill in the required fields: Expense Code and Description');
                        return false;
                    }

                    return true;
                });
            }

            // Function to open create vendor modal
            window.openCreateVendorModal = function() {
                if (confirm('This will open the vendor creation page in a new tab. Continue?')) {
                    window.open('/Vendors/Create', '_blank');
                }
            };
        });
    </script>
}