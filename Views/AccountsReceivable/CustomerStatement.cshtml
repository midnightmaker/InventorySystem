@model InventorySystem.ViewModels.CustomerStatementViewModel
@using InventorySystem.Models.Enums
@{
    ViewData["Title"] = $"Customer Statement - {Model.Customer.PrimaryDisplayName}";
    var ledger = Model.GetActivityLedger();
    var hasActivity = ledger.Any() || Model.OpeningBalance != 0;
}

<div class="d-print-none d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-file-invoice-dollar"></i> Customer Statement
        <small class="text-muted fs-6 ms-2">@Model.StatementNumber</small>
    </h1>
    <div class="btn-group">
        <a href="@Url.Action("Details", "Customers", new { id = Model.Customer.Id })" class="btn btn-outline-secondary">
            <i class="fas fa-user"></i> Customer Details
        </a>
        <a href="@Url.Action("CustomerStatements")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> All Statements
        </a>
        <button class="btn btn-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Print Statement
        </button>
    </div>
</div>

@* Date Range Filter *@
<div class="card mb-4 d-print-none">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-end">
            <input type="hidden" name="id" value="@Model.Customer.Id" />
            <div class="col-auto">
                <label class="form-label mb-0 small">Statement Period Start</label>
                <input type="date" name="startDate" class="form-control form-control-sm"
                       value="@Model.StatementStartDate.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-auto">
                <label class="form-label mb-0 small">Through</label>
                <input type="text" class="form-control form-control-sm" value="@Model.StatementDate.ToString("MM/dd/yyyy")" readonly />
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-filter"></i> Apply
                </button>
                <a href="@Url.Action("CustomerStatement", new { id = Model.Customer.Id })" class="btn btn-sm btn-outline-secondary ms-1">
                    Reset (YTD)
                </a>
            </div>
        </form>
    </div>
</div>

@* ===== PRINTABLE STATEMENT AREA ===== *@
<div class="card shadow-sm" id="statementDocument">
    @* Statement Header *@
    <div class="card-header bg-dark text-white">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h4 class="mb-0"><i class="fas fa-file-invoice-dollar"></i> Account Statement</h4>
                <small>Statement #: @Model.StatementNumber</small>
            </div>
            <div class="col-md-6 text-md-end">
                <div><strong>Statement Date:</strong> @Model.StatementDate.ToString("MMMM dd, yyyy")</div>
                <div><strong>Period:</strong> @Model.StatementStartDate.ToString("MM/dd/yyyy") &ndash; @Model.StatementDate.ToString("MM/dd/yyyy")</div>
            </div>
        </div>
    </div>

    <div class="card-body">

        @* Customer & Remittance Info *@
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="text-uppercase text-muted fw-bold mb-2">Bill To</h6>
                <div class="border rounded p-3 bg-light">
                    @if (!string.IsNullOrEmpty(Model.Customer.CompanyName))
                    {
                        <div class="fw-bold fs-5">@Model.Customer.CompanyName</div>
                        <div class="text-muted">@Model.Customer.CustomerName</div>
                    }
                    else
                    {
                        <div class="fw-bold fs-5">@Model.Customer.CustomerName</div>
                    }
                    @if (!string.IsNullOrEmpty(Model.Customer.BillingAddress))
                    {
                        <div class="mt-1">@Model.Customer.BillingAddress</div>
                        <div>@Model.Customer.BillingCity@(!string.IsNullOrEmpty(Model.Customer.BillingCity) && !string.IsNullOrEmpty(Model.Customer.BillingState) ? ", " : "")@Model.Customer.BillingState @Model.Customer.BillingZipCode</div>
                    }
                    <div class="mt-1 text-muted small">@Model.Customer.Email</div>
                    @if (!string.IsNullOrEmpty(Model.Customer.Phone))
                    {
                        <div class="text-muted small">@Model.Customer.Phone</div>
                    }
                </div>
            </div>
            <div class="col-md-6 text-md-end">
                <h6 class="text-uppercase text-muted fw-bold mb-2">Account Summary</h6>
                <div class="border rounded p-3">
                    <table class="table table-borderless table-sm mb-0 text-end">
                        <tr>
                            <td class="text-muted">Total Invoiced (period):</td>
                            <td class="fw-bold">@Model.TotalInvoiced.ToString("C")</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Total Payments (period):</td>
                            <td class="fw-bold text-success">(@Model.TotalPaid.ToString("C"))</td>
                        </tr>
                        @if (Model.TotalAdjustments > 0)
                        {
                            <tr>
                                <td class="text-muted">Total Adjustments (period):</td>
                                <td class="fw-bold text-warning">(@Model.TotalAdjustments.ToString("C"))</td>
                            </tr>
                        }
                        <tr class="border-top">
                            <td class="fw-bold fs-6">Amount Due:</td>
                            <td class="fw-bold fs-5 @(Model.TotalOutstanding > 0 ? "text-danger" : "text-success")">
                                @Model.TotalOutstanding.ToString("C")
                            </td>
                        </tr>
                    </table>
                    @if (Model.Customer.CreditLimit > 0)
                    {
                        <div class="mt-2 pt-2 border-top text-muted small">
                            Credit Limit: @Model.Customer.CreditLimit.ToString("C") &nbsp;|&nbsp;
                            Available: @Model.Customer.CreditAvailable.ToString("C")
                        </div>
                    }
                </div>
            </div>
        </div>

        @* Summary KPI Cards *@
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white text-center py-2">
                    <div class="fw-bold fs-4">@Model.AllInvoices.Count</div>
                    <div class="small">Invoices This Period</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark text-center py-2">
                    <div class="fw-bold fs-4">@Model.UnpaidInvoices.Count</div>
                    <div class="small">Unpaid Invoices</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white text-center py-2">
                    <div class="fw-bold fs-4">@Model.Payments.Count</div>
                    <div class="small">Payments Received</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card @(Model.TotalOutstanding > 0 ? "bg-danger" : "bg-success") text-white text-center py-2">
                    <div class="fw-bold fs-4">@Model.TotalOutstanding.ToString("C")</div>
                    <div class="small">Current Balance Due</div>
                </div>
            </div>
        </div>

        @* Activity Ledger *@
        <h5 class="mb-3"><i class="fas fa-list-alt"></i> Transaction History</h5>
        @if (hasActivity)
        {
            <div class="table-responsive">
                <table class="table table-sm table-hover border">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Reference</th>
                            <th>Description</th>
                            <th class="text-end">Charges</th>
                            <th class="text-end">Credits</th>
                            <th class="text-end">Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.OpeningBalance != 0)
                        {
                            <tr class="table-light text-muted fst-italic">
                                <td>@Model.StatementStartDate.ToString("MM/dd/yyyy")</td>
                                <td><span class="badge bg-secondary">Opening</span></td>
                                <td colspan="2">Balance forward (prior to statement period)</td>
                                <td class="text-end">
                                    @if (Model.OpeningBalance > 0)
                                    {
                                        @Model.OpeningBalance.ToString("C")
                                    }
                                </td>
                                <td class="text-end text-success">
                                    @if (Model.OpeningBalance < 0)
                                    {
                                        <text>(@(Math.Abs(Model.OpeningBalance).ToString("C")))</text>
                                    }
                                </td>
                                <td class="text-end fw-bold @(Model.OpeningBalance > 0 ? "text-danger" : "text-success")">
                                    @Model.OpeningBalance.ToString("C")
                                </td>
                            </tr>
                        }
                        @foreach (var line in ledger)
                        {
                            <tr class="@(line.Type == StatementLineItemType.Payment ? "table-success" : line.Type == StatementLineItemType.Adjustment ? "table-warning" : "")">
                                <td class="text-nowrap">@line.Date.ToString("MM/dd/yyyy")</td>
                                <td><span class="badge @line.TypeBadgeClass">@line.TypeLabel</span></td>
                                <td>
                                    @if (line.Type == StatementLineItemType.Invoice && line.SaleId.HasValue)
                                    {
                                        <a href="/Sales/Details/@line.SaleId" class="text-decoration-none d-print-none">@line.Reference</a>
                                        <span class="d-none d-print-inline">@line.Reference</span>
                                    }
                                    else
                                    {
                                        @line.Reference
                                    }
                                </td>
                                <td>
                                    @line.Description
                                    @if (line.Type == StatementLineItemType.Invoice && line.PaymentStatus.HasValue)
                                    {
                                        var statusClass = line.PaymentStatus switch {
                                            PaymentStatus.Paid => "success",
                                            PaymentStatus.Overdue => "danger",
                                            PaymentStatus.PartiallyPaid => "info",
                                            _ => "secondary"
                                        };
                                        <span class="badge bg-@statusClass ms-1 d-print-none">@line.PaymentStatus</span>
                                    }
                                </td>
                                <td class="text-end text-nowrap">
                                    @if (line.Charges > 0)
                                    {
                                        @line.Charges.ToString("C")
                                    }
                                </td>
                                <td class="text-end text-nowrap">
                                    @if (line.Credits > 0)
                                    {
                                        <span class="text-success">(@line.Credits.ToString("C"))</span>
                                    }
                                </td>
                                <td class="text-end text-nowrap fw-bold @(line.RunningBalance > 0 ? "text-danger" : "text-success")">
                                    @line.RunningBalance.ToString("C")
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-secondary fw-bold">
                        <tr>
                            <td colspan="4" class="text-end">Totals:</td>
                            <td class="text-end">@Model.TotalInvoiced.ToString("C")</td>
                            <td class="text-end text-success">(@((Model.TotalPaid + Model.TotalAdjustments).ToString("C")))</td>
                            <td class="text-end @(Model.TotalOutstanding > 0 ? "text-danger" : "text-success")">
                                @Model.TotalOutstanding.ToString("C")
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-4 text-muted">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p>No transactions found for the selected period.</p>
            </div>
        }

        @* Aging Breakdown for outstanding invoices *@
        @if (Model.UnpaidInvoices.Any())
        {
            <div class="mt-4">
                <h5 class="mb-3"><i class="fas fa-exclamation-circle text-warning"></i> Outstanding Invoice Detail</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-warning">
                            <tr>
                                <th>Invoice #</th>
                                <th>Invoice Date</th>
                                <th>Due Date</th>
                                <th>Days Overdue</th>
                                <th>Status</th>
                                <th class="text-end">Original Amount</th>
                                <th class="text-end">Amount Due</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var inv in Model.UnpaidInvoices.OrderBy(i => i.PaymentDueDate))
                            {
                                var daysOverdue = (DateTime.Today - inv.PaymentDueDate).Days;
                                var rowClass = daysOverdue > 90 ? "table-danger" : daysOverdue > 60 ? "table-warning" : "";
                                var amountDue = Model.GetAmountDue(inv);
                                <tr class="@rowClass">
                                    <td>
                                        <a href="/Sales/Details/@inv.Id" class="text-decoration-none d-print-none fw-bold">@inv.SaleNumber</a>
                                        <span class="d-none d-print-inline fw-bold">@inv.SaleNumber</span>
                                    </td>
                                    <td>@inv.SaleDate.ToString("MM/dd/yyyy")</td>
                                    <td>@inv.PaymentDueDate.ToString("MM/dd/yyyy")</td>
                                    <td>
                                        @if (daysOverdue <= 0)
                                        {
                                            <span class="text-success">Current (@Math.Abs(daysOverdue) days remaining)</span>
                                        }
                                        else
                                        {
                                            @($"{daysOverdue} days")
                                            if (daysOverdue > 90)
                                            {
                                                <span class="badge bg-danger ms-1">90+</span>
                                            }
                                            else if (daysOverdue > 60)
                                            {
                                                <span class="badge bg-warning text-dark ms-1">60+</span>
                                            }
                                            else if (daysOverdue > 30)
                                            {
                                                <span class="badge bg-info ms-1">30+</span>
                                            }
                                        }
                                    </td>
                                    <td>
                                        @{
                                            var sc = inv.PaymentStatus switch {
                                                PaymentStatus.Overdue => "danger",
                                                PaymentStatus.PartiallyPaid => "info",
                                                _ => "secondary"
                                            };
                                        }
                                        <span class="badge bg-@sc">@inv.PaymentStatus</span>
                                    </td>
                                    <td class="text-end">@inv.TotalAmount.ToString("C")</td>
                                    <td class="text-end fw-bold text-danger">@amountDue.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-dark fw-bold">
                            <tr>
                                <td colspan="6" class="text-end">Total Amount Due:</td>
                                <td class="text-end text-danger fs-6">@Model.TotalOutstanding.ToString("C")</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                @* Aging Summary *@
                <div class="row mt-3">
                    <div class="col-md-8 offset-md-4">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark fw-bold">Aging Summary</div>
                            <div class="card-body p-0">
                                <table class="table table-sm mb-0">
                                    <tbody>
                                        @{
                                            var current    = Model.UnpaidInvoices.Where(i => (DateTime.Today - i.PaymentDueDate).Days <= 0) .Sum(i => Model.GetAmountDue(i));
                                            var days1to30  = Model.UnpaidInvoices.Where(i => { var d = (DateTime.Today - i.PaymentDueDate).Days; return d >= 1  && d <= 30; }).Sum(i => Model.GetAmountDue(i));
                                            var days31to60 = Model.UnpaidInvoices.Where(i => { var d = (DateTime.Today - i.PaymentDueDate).Days; return d >= 31 && d <= 60; }).Sum(i => Model.GetAmountDue(i));
                                            var days61to90 = Model.UnpaidInvoices.Where(i => { var d = (DateTime.Today - i.PaymentDueDate).Days; return d >= 61 && d <= 90; }).Sum(i => Model.GetAmountDue(i));
                                            var over90     = Model.UnpaidInvoices.Where(i => (DateTime.Today - i.PaymentDueDate).Days > 90) .Sum(i => Model.GetAmountDue(i));
                                        }
                                        <tr><td>Current (not yet due)</td><td class="text-end">@current.ToString("C")</td></tr>
                                        <tr><td>1-30 Days Overdue</td><td class="text-end">@days1to30.ToString("C")</td></tr>
                                        <tr class="@(days31to60 > 0 ? "table-warning" : "")"><td>31-60 Days Overdue</td><td class="text-end">@days31to60.ToString("C")</td></tr>
                                        <tr class="@(days61to90 > 0 ? "table-warning" : "")"><td>61-90 Days Overdue</td><td class="text-end">@days61to90.ToString("C")</td></tr>
                                        <tr class="@(over90 > 0 ? "table-danger text-white" : "")"><td>Over 90 Days Overdue</td><td class="text-end fw-bold">@over90.ToString("C")</td></tr>
                                        <tr class="table-dark fw-bold"><td>Total Outstanding</td><td class="text-end">@Model.TotalOutstanding.ToString("C")</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-success mt-4">
                <i class="fas fa-check-circle"></i> <strong>Account is current!</strong> No outstanding invoices for this customer.
            </div>
        }

        @* Statement Footer *@
        <div class="mt-5 pt-3 border-top text-muted small">
            <div class="row">
                <div class="col-md-6">
                    <p>
                        This statement reflects account activity from
                        <strong>@Model.StatementStartDate.ToString("MMMM dd, yyyy")</strong> to
                        <strong>@Model.StatementDate.ToString("MMMM dd, yyyy")</strong>.
                        Please contact us if you have any questions regarding this statement.
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>Generated: @DateTime.Now.ToString("MM/dd/yyyy h:mm tt")</p>
                    <p>Statement #: @Model.StatementNumber</p>
                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
<script>
    // Highlight amounts due over 90 days
    document.querySelectorAll('.table-danger td').forEach(td => {
        td.style.fontWeight = '600';
    });
</script>
}

<style>
    @@media print {
        .d-print-none { display: none !important; }
        .d-none.d-print-inline { display: inline !important; }
        body { font-size: 12px; }
        .card { box-shadow: none !important; border: 1px solid #dee2e6 !important; }
        .card-header.bg-dark { background-color: #343a40 !important; color: white !important; -webkit-print-color-adjust: exact; }
        .badge { -webkit-print-color-adjust: exact; }
        .table-danger { background-color: #f8d7da !important; -webkit-print-color-adjust: exact; }
        .table-warning { background-color: #fff3cd !important; -webkit-print-color-adjust: exact; }
        .table-success { background-color: #d1e7dd !important; -webkit-print-color-adjust: exact; }
        h1 { font-size: 1.5rem; }
        .fs-4 { font-size: 1rem !important; }
    }
</style>
