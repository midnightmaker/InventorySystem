@model InventorySystem.ViewModels.EnhancedCreateSaleViewModel
@{
  ViewData["Title"] = "Create Sale with Items";
}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-shopping-cart"></i> Create Sale with Items</h1>
  <div class="btn-group">
    <a href="/Sales" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Back to Sales
    </a>
    <a href="/Sales/Create" class="btn btn-outline-info">
      <i class="fas fa-plus"></i> Quick Create (2-Step)
    </a>
  </div>
</div>

<div class="alert alert-info">
  <i class="fas fa-info-circle"></i>
  <strong>Enhanced Sale Creation:</strong> Create a complete sale with line items and optional discounts in a single step.
</div>

@if (TempData["ErrorMessage"] != null)
{
  <div class="alert alert-danger alert-dismissible fade show">
    @TempData["ErrorMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
}

<form asp-action="CreateEnhanced" method="post" id="enhancedSaleForm">

  <!-- Customer & Sale Information Section -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6><i class="fas fa-user"></i> Customer & Sale Information</h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="customerSearch" class="form-label">Customer *</label>
            <div class="position-relative">
              <div class="input-group">
                <span class="input-group-text">
                  <i id="customerSearchIcon" class="fas fa-search"></i>
                  <div id="customerSearchSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </span>
                <input type="text" id="customerSearch" class="form-control"
                       placeholder="Type to search customers..." autocomplete="off" />
                <button type="button" class="btn btn-outline-secondary" id="clearCustomerSelection" style="display:none;">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <!-- Search Results Dropdown -->
              <div class="dropdown-menu w-100" id="customerSearchResults" style="max-height: 300px; overflow-y: auto; z-index: 1050;">
                <!-- Results will be populated here via JavaScript -->
              </div>
            </div>

            <!-- THE MAIN CUSTOMER ID FIELD - This is the one that gets submitted -->
            <input asp-for="CustomerId" type="hidden" />
            <span asp-validation-for="CustomerId" class="text-danger"></span>

            <!-- Selected Customer Display -->
            <div id="selectedCustomerDisplay" class="mt-2" style="display:none;">
              <div class="alert alert-success py-2">
                <i class="fas fa-check-circle"></i>
                <strong>Selected:</strong> <span id="selectedCustomerInfo"></span>
              </div>
            </div>

            <!-- Search Instructions -->
            <div class="form-text">
              <i class="fas fa-info-circle"></i>
              Type to search for customers. Can't find the customer?
              <a href="@Url.Action("Create", "Customers")" target="_blank">Create a new customer</a> first.
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <label asp-for="SaleDate" class="form-label">Sale Date</label>
              <input asp-for="SaleDate" class="form-control" type="date"
                     onchange="updateDueDate()" />
              <span asp-validation-for="SaleDate" class="text-danger"></span>
            </div>
            <div class="col-md-6">
              <label asp-for="OrderNumber" class="form-label">Order Number</label>
              <input asp-for="OrderNumber" class="form-control" placeholder="Optional..." />
              <span asp-validation-for="OrderNumber" class="text-danger"></span>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <label asp-for="Terms" class="form-label">Payment Terms</label>
              <select asp-for="Terms" class="form-select" onchange="updateDueDate()">
                <option value="@((int)PaymentTerms.COD)">COD (Cash on Delivery)</option>
                <option value="@((int)PaymentTerms.Net10)">Net 10</option>
                <option value="@((int)PaymentTerms.Net15)">Net 15</option>
                <option value="@((int)PaymentTerms.Net30)" selected>Net 30</option>
                <option value="@((int)PaymentTerms.Net60)">Net 60</option>
                
              </select>
              <span asp-validation-for="Terms" class="text-danger"></span>
            </div>
            <div class="col-md-6">
              <label asp-for="PaymentDueDate" class="form-label">Payment Due Date</label>
              <input asp-for="PaymentDueDate" class="form-control" type="date" />
              <span asp-validation-for="PaymentDueDate" class="text-danger"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6><i class="fas fa-shipping-fast"></i> Shipping & Payment</h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label asp-for="ShippingAddress" class="form-label">Shipping Address</label>
            <textarea asp-for="ShippingAddress" class="form-control" rows="2"
                      placeholder="Will auto-fill from customer selection..."></textarea>
            <span asp-validation-for="ShippingAddress" class="text-danger"></span>
          </div>

          <div class="row">
            <div class="col-md-6">
              <label asp-for="PaymentMethod" class="form-label">Payment Method</label>
              <select asp-for="PaymentMethod" class="form-select">
                <option value="">-- Select Method --</option>
                <option value="Cash">Cash</option>
                <option value="Check">Check</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Account Credit">Account Credit</option>
              </select>
              <span asp-validation-for="PaymentMethod" class="text-danger"></span>
            </div>
            <div class="col-md-6">
              <label asp-for="SaleStatus" class="form-label">Sale Status</label>
              <select asp-for="SaleStatus" class="form-select">
                <option value="@((int)SaleStatus.Processing)" selected>Processing</option>
                <option value="@((int)SaleStatus.Backordered)">Backordered</option>
                <option value="@((int)SaleStatus.Shipped)">Shipped</option>
                <option value="@((int)SaleStatus.Delivered)">Delivered</option>
              </select>
              <span asp-validation-for="SaleStatus" class="text-danger"></span>
            </div>
          </div>

          <div class="mt-3">
            <label asp-for="Notes" class="form-label">Notes</label>
            <textarea asp-for="Notes" class="form-control" rows="2"
                      placeholder="Optional sale notes..."></textarea>
            <span asp-validation-for="Notes" class="text-danger"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Line Items Section (Static 10 rows) -->
  <div class="card mb-4">
    <div class="card-header">
      <h5><i class="fas fa-list"></i> Sale Items</h5>
      <small class="text-muted">Select items for the rows you want to include in the sale. Leave unused rows empty.</small>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="lineItemsTable">
          <thead>
            <tr>
              <th style="min-width: 300px;">Product</th>
              <th width="100" class="text-center">Qty</th>
              <th width="140">Unit Price</th>
              <th width="120" class="text-end">Line Total</th>
            </tr>
          </thead>
          <tbody id="lineItemsBody">
            @for (int i = 0; i < 10; i++)
            {
              <tr class="line-item-row" id="lineItem_@i">
                <td>
                  <div class="row g-2">
                    <div class="col-auto">
                      <select name="LineItems[@i].ProductType" class="form-select form-select-sm product-type-select"
                              onchange="toggleProductSelect(@i)" style="width: 120px;">
                        <option value="Item">Item</option>
                        <option value="FinishedGood">Finished Good</option>
                      </select>
                    </div>
                    <div class="col">
                      <select name="LineItems[@i].ItemId" class="form-select item-select"
                              onchange="loadProductInfo(@i)">
                        <option value="">-- Select Item --</option>
                      </select>
                      <select name="LineItems[@i].FinishedGoodId" class="form-select finished-good-select d-none"
                              onchange="loadProductInfo(@i)">
                        <option value="">-- Select Finished Good --</option>
                      </select>
                    </div>
                  </div>
                  <small class="text-muted product-info"></small>
                  <input name="LineItems[@i].Notes" type="hidden" class="line-notes" />
                </td>
                <td class="text-center">
                  <input name="LineItems[@i].Quantity" type="number" min="1" value=""
                         class="form-control form-control-sm text-center quantity-input"
                         style="width: 80px;" onchange="calculateLineTotal(@i)" oninput="calculateLineTotal(@i)" 
                         placeholder="0" />
                </td>
                <td>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text">$</span>
                    <input name="LineItems[@i].UnitPrice" type="number" step="0.01" min="0" placeholder="0.00"
                           class="form-control text-end unit-price-input" onchange="calculateLineTotal(@i)" 
                           oninput="calculateLineTotal(@i)" />
                    <button type="button" class="btn btn-outline-info suggested-price-btn d-none"
                            onclick="useSuggestedPrice(@i)" title="Use suggested price">
                      <i class="fas fa-magic"></i>
                    </button>
                  </div>
                </td>
                <td class="text-end">
                  <span class="fw-bold line-total-display">$0.00</span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Financial Summary Section -->
  <div class="row">
    <div class="col-md-8">
      <!-- Discount Section -->
      <div class="card">
        <div class="card-header">
          <h6><i class="fas fa-percent"></i> Discount (Optional)</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <label asp-for="DiscountType" class="form-label">Discount Type</label>
              <select asp-for="DiscountType" class="form-select" onchange="toggleDiscountInputs()">
                <option value="Amount">Fixed Amount ($)</option>
                <option value="Percentage">Percentage (%)</option>
              </select>
            </div>
            <div class="col-md-4" id="discountAmountDiv">
              <label asp-for="DiscountAmount" class="form-label">Discount Amount</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input asp-for="DiscountAmount" class="form-control" type="number"
                       step="0.01" min="0" onchange="calculateTotals()" />
              </div>
              <span asp-validation-for="DiscountAmount" class="text-danger"></span>
            </div>
            <div class="col-md-4" id="discountPercentageDiv" style="display:none;">
              <label asp-for="DiscountPercentage" class="form-label">Discount Percentage</label>
              <div class="input-group">
                <input asp-for="DiscountPercentage" class="form-control" type="number"
                       step="0.01" min="0" max="100" onchange="calculateTotals()" />
                <span class="input-group-text">%</span>
              </div>
              <span asp-validation-for="DiscountPercentage" class="text-danger"></span>
            </div>
          </div>
          <div class="mt-3">
            <label asp-for="DiscountReason" class="form-label">Discount Reason</label>
            <input asp-for="DiscountReason" class="form-control"
                   placeholder="Optional reason for discount..." />
            <span asp-validation-for="DiscountReason" class="text-danger"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <!-- Live Calculation Summary -->
      <div class="card">
        <div class="card-header">
          <h6><i class="fas fa-calculator"></i> Sale Summary</h6>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <td>Subtotal:</td>
              <td class="text-end" id="subtotalDisplay">$0.00</td>
            </tr>
            <tr>
              <td>Shipping:</td>
              <td class="text-end">
                <div class="input-group input-group-sm">
                  <span class="input-group-text">$</span>
                  <input asp-for="ShippingCost" class="form-control text-end"
                         type="number" step="0.01" min="0" onchange="calculateTotals()" />
                </div>
                <span asp-validation-for="ShippingCost" class="text-danger small"></span>
              </td>
            </tr>
            <tr>
              <td>Tax:</td>
              <td class="text-end">
                <div class="input-group input-group-sm">
                  <span class="input-group-text">$</span>
                  <input asp-for="TaxAmount" class="form-control text-end"
                         type="number" step="0.01" min="0" onchange="calculateTotals()" />
                </div>
                <span asp-validation-for="TaxAmount" class="text-danger small"></span>
              </td>
            </tr>
            <tr class="discount-row" style="display:none;">
              <td><span class="text-success">Discount:</span></td>
              <td class="text-end text-success" id="discountDisplay">-$0.00</td>
            </tr>
            <tr class="table-dark">
              <td><strong>Total:</strong></td>
              <td class="text-end"><strong id="totalDisplay">$0.00</strong></td>
            </tr>
          </table>

          <hr>

          <div class="small text-muted">
            <div class="d-flex justify-content-between">
              <span>Items:</span>
              <span id="itemCountDisplay">0</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Total Qty:</span>
              <span id="totalQtyDisplay">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="d-flex justify-content-between">
        <a href="/Sales" class="btn btn-outline-secondary">
          <i class="fas fa-times"></i> Cancel
        </a>
        <button type="submit" class="btn btn-primary btn-lg" id="createSaleBtn" disabled>
          <i class="fas fa-save"></i> Create Complete Sale
        </button>
      </div>
    </div>
  </div>

</form>

@section Scripts {
  @{
    await Html.RenderPartialAsync("_ValidationScriptsPartial");
  }
  <script src="~/js/enhanced-sales-creation.js"></script>
}