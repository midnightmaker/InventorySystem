@model CreateServiceOrdersFromSaleViewModel
@{
  ViewData["Title"] = "Create Service Orders from Sale";
}

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-clipboard-list"></i> Create Service Orders</h2>
    <div class="btn-group">
      <a href="@Url.Action("Details", new { id = Model.SaleId })" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to Sale
      </a>
      <a href="@Url.Action("Details", new { id = Model.SaleId })" class="btn btn-outline-info">
        <i class="fas fa-skip-forward"></i> Skip for Now
      </a>
    </div>
  </div>

  <!-- Sale Context -->
  <div class="card mb-4 bg-light">
    <div class="card-body">
      <h5>Sale Context: @Model.Sale.SaleNumber</h5>
      <div class="row">
        <div class="col-md-6">
          <strong>Customer:</strong> @Model.CustomerName<br>
          <strong>Sale Date:</strong> @Model.Sale.SaleDate.ToString("MMMM dd, yyyy")
        </div>
        <div class="col-md-6">
          <strong>Total:</strong> @Model.Sale.TotalAmount.ToString("C")<br>
          <strong>Service Items Found:</strong> @Model.ServiceItems.Count
        </div>
      </div>
    </div>
  </div>

  <form asp-action="ProcessServiceOrdersFromSale" method="post">
    <input type="hidden" asp-for="SaleId" />

    @for (int i = 0; i < Model.ServiceItems.Count; i++)
    {
      <div class="card mb-4">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5>
              <i class="fas fa-cogs"></i> @Model.ServiceItems[i].ServiceTypeName
              <small class="text-muted">(@Model.ServiceItems[i].ItemName)</small>
            </h5>

            <!-- Check if service order already exists -->
            @{
              var existingOrder = Model.ExistingServiceOrders
              .FirstOrDefault(so => so.ServiceTypeId == Model.ServiceItems[i].ServiceTypeId);
            }

            @if (existingOrder != null)
            {
              <div class="badge bg-success">
                <i class="fas fa-check"></i> Service Order Exists:
                <a href="@Url.Action("Details", "Services", new { id = existingOrder.Id })"
                   class="text-white text-decoration-none">
                  @existingOrder.ServiceOrderNumber
                </a>
              </div>
            }
            else
            {
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox"
                       name="ServiceOrdersToCreate[@i].CreateServiceOrder"
                       id="create_@i" checked />
                <label class="form-check-label" for="create_@i">
                  Create Service Order
                </label>
              </div>
            }
          </div>
        </div>

        @if (existingOrder == null)
        {
          <div class="card-body" id="serviceForm_@i">
            <input type="hidden" name="ServiceOrdersToCreate[@i].ServiceTypeId" value="@Model.ServiceItems[i].ServiceTypeId" />

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="promised_@i" class="form-label">Promised Date <span class="text-danger">*</span></label>
                  <input type="date" name="ServiceOrdersToCreate[@i].PromisedDate"
                         id="promised_@i" class="form-control"
                         value="@Model.DefaultPromisedDate.ToString("yyyy-MM-dd")" required />
                </div>

                <div class="mb-3">
                  <label for="priority_@i" class="form-label">Priority</label>
                  <select name="ServiceOrdersToCreate[@i].Priority" id="priority_@i" class="form-select">
                    <option value="Normal">Normal</option>
                    <option value="High">High</option>
                    <option value="Urgent">Urgent</option>
                    <option value="Emergency">Emergency</option>
                  </select>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label for="technician_@i" class="form-label">Assigned Technician</label>
                  <select name="ServiceOrdersToCreate[@i].AssignedTechnician" id="technician_@i" class="form-select">
                    <option value="">Select technician...</option>
                    <option value="John Smith">John Smith</option>
                    <option value="Jane Doe">Jane Doe</option>
                    <option value="Mike Johnson">Mike Johnson</option>
                    <option value="Sarah Wilson">Sarah Wilson</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="equipment_@i" class="form-label">Equipment Details</label>
                  <input type="text" name="ServiceOrdersToCreate[@i].EquipmentDetails"
                         id="equipment_@i" class="form-control"
                         placeholder="Equipment or asset details..." />
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="serial_@i" class="form-label">Serial Number</label>
                  <input type="text" name="ServiceOrdersToCreate[@i].SerialNumber"
                         id="serial_@i" class="form-control" />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="model_@i" class="form-label">Model Number</label>
                  <input type="text" name="ServiceOrdersToCreate[@i].ModelNumber"
                         id="model_@i" class="form-control" />
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="request_@i" class="form-label">Customer Request</label>
              <textarea name="ServiceOrdersToCreate[@i].CustomerRequest" id="request_@i"
                    class="form-control" rows="2"
                    placeholder="What does the customer want us to do?">@Model.SaleReference - @Model.ServiceItems[i].Notes</textarea>
            </div>

            <div class="mb-3">
              <label for="notes_@i" class="form-label">Service Notes</label>
              <textarea name="ServiceOrdersToCreate[@i].ServiceNotes" id="notes_@i"
                    class="form-control" rows="2"
                    placeholder="Internal service notes..."></textarea>
            </div>
          </div>
        }
      </div>
    }

    <div class="d-flex justify-content-between">
      <a href="@Url.Action("Details", new { id = Model.SaleId })" class="btn btn-secondary">
        <i class="fas fa-times"></i> Cancel
      </a>
      <button type="submit" class="btn btn-success btn-lg">
        <i class="fas fa-plus"></i> Create Service Orders
      </button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Toggle service form visibility based on checkbox
      document.querySelectorAll('[id^="create_"]').forEach(function(checkbox) {
          const index = checkbox.id.split('_')[1];
          const form = document.getElementById('serviceForm_' + index);

          checkbox.addEventListener('change', function() {
              form.style.display = this.checked ? 'block' : 'none';
          });
      });
  });
</script>