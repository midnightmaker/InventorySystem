@model InventorySystem.ViewModels.SaleDetailsViewModel
@using InventorySystem.Models.Enums

@{
    var canProcessSale = (bool)ViewData["CanProcessSale"]!;
}

@if (Model.TotalShipments > 0)
{
    <div class="row mt-0">
        <div class="col-12">
            <div class="card border-info" style="border-top: none; border-top-left-radius: 0; border-top-right-radius: 0;">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-shipping-fast"></i> Shipments
                        <span class="badge bg-dark ms-2">@Model.TotalShipments shipment@(Model.TotalShipments > 1 ? "s" : "")</span>
                    </h5>
                    <div class="d-flex align-items-center gap-3">
                        @if (Model.HasMultipleShipments)
                        {
                            <small>
                                <i class="fas fa-info-circle"></i>
                                Multiple shipments: @Model.FirstShipmentDate?.ToString("MM/dd") - @Model.LastShipmentDate?.ToString("MM/dd")
                            </small>
                        }
                        @if (Model.Sale.CanShipAdditionalItems)
                        {
                            <a href="@Url.Action("CreateAdditionalShipment", new { saleId = Model.Sale.Id })"
                               class="btn btn-light btn-sm">
                                <i class="fas fa-plus"></i> Create Additional Shipment
                            </a>
                        }
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0"><i class="fas fa-boxes fa-2x text-primary"></i></div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="fw-bold">@Model.TotalItemsShipped</div>
                                    <small class="text-muted">Total Items Shipped</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0"><i class="fas fa-dollar-sign fa-2x text-success"></i></div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="fw-bold">@Model.TotalShipmentValue.ToString("C")</div>
                                    <small class="text-muted">Total Shipment Value</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0"><i class="fas fa-clock fa-2x text-info"></i></div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="fw-bold">
                                        @if (Model.HasMultipleShipments)
                                        {
                                            <span>@((Model.LastShipmentDate - Model.FirstShipmentDate)?.Days ?? 0) days</span>
                                        }
                                        else
                                        {
                                            <span>Same day</span>
                                        }
                                    </div>
                                    <small class="text-muted">Shipping Timespan</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Packing Slip</th>
                                    <th>Ship Date</th>
                                    <th>Courier</th>
                                    <th>Tracking</th>
                                    <th class="text-center">Items</th>
                                    <th class="text-end">Value</th>
                                    <th>Expected Delivery</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var shipment in Model.Shipments)
                                {
                                    @* Find the invoice for this shipment, if one exists *@
                                    var shipmentInvoice = Model.Invoices.FirstOrDefault(inv => inv.ShipmentId == shipment.Id);

                                    <tr>
                                        <td>
                                            <strong>@shipment.PackingSlipNumber</strong>
                                            <br>
                                            <small class="text-muted">by @shipment.ShippedBy</small>
                                        </td>
                                        <td>
                                            @shipment.ShipmentDate.ToString("MM/dd/yyyy")
                                            <br>
                                            <small class="text-muted">@shipment.ShipmentDate.ToString("h:mm tt")</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">@shipment.CourierService</span>
                                            @if (shipment.PackageWeight.HasValue)
                                            {
                                                <br>
                                                <small class="text-muted">@shipment.PackageWeight.Value lbs</small>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(shipment.TrackingNumber) && shipment.TrackingNumber != "N/A")
                                            {
                                                <strong>@shipment.TrackingNumber</strong>
                                                @if (shipment.CourierService == "FedEx")
                                                {
                                                    <br>
                                                    <a href="https://www.fedex.com/apps/fedextrack/?tracknumbers=@shipment.TrackingNumber"
                                                       target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-external-link-alt"></i> Track
                                                    </a>
                                                }
                                                else if (shipment.CourierService == "UPS")
                                                {
                                                    <br>
                                                    <a href="https://www.ups.com/track?tracknum=@shipment.TrackingNumber"
                                                       target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-external-link-alt"></i> Track
                                                    </a>
                                                }
                                                else if (shipment.CourierService == "USPS")
                                                {
                                                    <br>
                                                    <a href="https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=@shipment.TrackingNumber"
                                                       target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-external-link-alt"></i> Track
                                                    </a>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">Local/Pickup</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-info">@shipment.TotalItemsShipped items</span>
                                            @if (shipment.ShipmentItems.Any())
                                            {
                                                <br>
                                                <small class="text-muted">
                                                    @string.Join(", ", shipment.ShipmentItems.Take(2).Select(si => $"{si.SaleItem.ProductPartNumber} ({si.QuantityShipped})"))
                                                    @if (shipment.ShipmentItems.Count() > 2)
                                                    {
                                                        <text>...</text>
                                                    }
                                                </small>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <strong>@shipment.ShipmentItems.Sum(si => si.QuantityShipped * si.SaleItem.UnitPrice).ToString("C")</strong>
                                        </td>
                                        <td>
                                            @if (shipment.ExpectedDeliveryDate.HasValue)
                                            {
                                                @shipment.ExpectedDeliveryDate.Value.ToString("MM/dd/yyyy")
                                                var isOverdue = DateTime.Now > shipment.ExpectedDeliveryDate.Value && Model.Sale.SaleStatus != SaleStatus.Delivered;
                                                @if (isOverdue)
                                                {
                                                    <br>
                                                    <span class="badge bg-danger">Overdue</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">TBD</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm">
                                                <a href="@Url.Action("ShipmentDetails", new { id = shipment.Id })"
                                                   class="btn btn-outline-info" title="View Shipment Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="@Url.Action("PackingSlip", new { id = shipment.Id })"
                                                   target="_blank" class="btn btn-outline-primary" title="View Packing Slip">
                                                    <i class="fas fa-file-alt"></i>
                                                </a>
                                                @if (shipmentInvoice != null && shipmentInvoice.HasPdf)
                                                {
                                                    @* View invoice print-preview (same document as the stored PDF) *@
                                                    <a href="@Url.Action("ViewInvoice", new { invoiceId = shipmentInvoice.Id })"
                                                       target="_blank"
                                                       class="btn btn-outline-success"
                                                       title="View Invoice @shipmentInvoice.InvoiceNumber">
                                                        <i class="fas fa-file-invoice"></i>
                                                    </a>
                                                    @* Download the stored PDF bytes *@
                                                    <a href="@Url.Action("DownloadInvoice", new { invoiceId = shipmentInvoice.Id })"
                                                       class="btn btn-outline-secondary"
                                                       title="Download Invoice @shipmentInvoice.InvoiceNumber (PDF)">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                }
                                                else if (shipmentInvoice != null)
                                                {
                                                    @* Invoice row exists but PDF generation failed — offer view-only *@
                                                    <a href="@Url.Action("ViewInvoice", new { invoiceId = shipmentInvoice.Id })"
                                                       target="_blank"
                                                       class="btn btn-outline-warning"
                                                       title="View Invoice @shipmentInvoice.InvoiceNumber (PDF not stored)">
                                                        <i class="fas fa-file-invoice"></i>
                                                    </a>
                                                }
                                            </div>
                                            @if (shipmentInvoice != null)
                                            {
                                                <br>
                                                <small class="text-muted">@shipmentInvoice.InvoiceNumber</small>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Shipments.FirstOrDefault()?.ShippingInstructions))
                    {
                        <div class="mt-3">
                            <h6><i class="fas fa-info-circle"></i> Shipping Instructions</h6>
                            <div class="alert alert-light">
                                @Model.Shipments.FirstOrDefault()?.ShippingInstructions
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
else if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
{
    <div class="row mt-0">
        <div class="col-12">
            <div class="card border-warning" style="border-top: none; border-top-left-radius: 0; border-top-right-radius: 0;">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-clock"></i> Ready for Shipment</h5>
                </div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-md-6 offset-md-3">
                            <i class="fas fa-shipping-fast fa-3x text-warning mb-3"></i>
                            <h6>This sale is ready to be processed and shipped</h6>
                            <p class="text-muted mb-3">
                                Click the "Process & Ship" button above to create the first shipment for this sale.
                                @if (Model.Sale.HasBackorders)
                                {
                                    <br>
                                    <strong>Note:</strong>
                                    <span>This sale has backorders. A partial shipment will be created for available items.</span>
                                }
                            </p>
                            @if (canProcessSale)
                            {
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#processSaleModal">
                                    <i class="fas fa-shipping-fast"></i> Process & Ship Sale
                                </button>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    Complete all service orders before shipping this sale.
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
