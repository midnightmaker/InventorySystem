@model InventorySystem.ViewModels.SaleDetailsViewModel
@using InventorySystem.Services

@{
    var saleAdjustments = Model.Sale.RelatedAdjustments?.ToList() ?? new List<CustomerBalanceAdjustment>();
    var totalAdjustments = saleAdjustments.Sum(a => a.AdjustmentAmount);
    var effectiveAmount = Model.Sale.TotalAmount - totalAdjustments;
}

<!-- Invoice Preview Modal -->
<div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 90vw;">
        <div class="modal-content" style="height: 92vh;">
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title" id="invoicePreviewModalLabel">
                    <i class="fas fa-file-invoice-dollar me-2"></i>
                    Invoice Generated — <span id="invoicePreviewNumber"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 d-flex flex-column">
                <!-- Action bar sits above the iframe -->
                <div class="d-flex align-items-center gap-2 px-3 py-2 bg-light border-bottom flex-shrink-0">
                    <span class="text-muted small me-2">
                        <i class="fas fa-check-circle text-success"></i> Invoice saved successfully.
                        Review below and send to the customer when ready.
                    </span>
                    <div class="ms-auto d-flex gap-2">
                        <a id="invoicePreviewOpenTab"
                           href="#" target="_blank"
                           class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-external-link-alt"></i> Open in New Tab
                        </a>
                        <a id="invoicePreviewPrint"
                           href="#"
                           class="btn btn-sm btn-outline-secondary"
                           onclick="printInvoiceFrame(); return false;">
                            <i class="fas fa-print"></i> Print
                        </a>
                        <a id="invoicePreviewDownload"
                           href="#"
                           class="btn btn-sm btn-outline-success"
                           style="display:none;">
                            <i class="fas fa-download"></i> Download PDF
                        </a>
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
                <!-- Invoice rendered inside an iframe so the layout-free print view fills the space -->
                <iframe id="invoicePreviewFrame"
                        src="about:blank"
                        style="flex: 1; border: none; width: 100%;"
                        title="Invoice Preview">
                </iframe>
            </div>
        </div>
    </div>
</div>

<!-- Item Details Modal -->
<div class="modal fade" id="itemDetailsModal" tabindex="-1" aria-labelledby="itemDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemDetailsModalLabel">
                    <i class="fas fa-cube"></i> Item Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="itemDetailsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewFullItemLink" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt"></i> View Full Details
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Item Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid rounded" />
            </div>
        </div>
    </div>
</div>

<!-- Payment Recording Modal -->
@if (Model.Sale.PaymentStatus != PaymentStatus.Paid)
{
    <div class="modal fade" id="recordPaymentModal" tabindex="-1" aria-labelledby="recordPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="RecordPayment" method="post">
                    <input type="hidden" name="saleId" value="@Model.Sale.Id" />
                    <div class="modal-header">
                        <h5 class="modal-title" id="recordPaymentModalLabel">
                            <i class="fas fa-dollar-sign"></i> Record Payment - Sale @Model.Sale.SaleNumber
                            @if (totalAdjustments > 0)
                            {
                                <span class="badge bg-warning text-dark">Adjusted</span>
                            }
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Sale Total</label>
                            @if (totalAdjustments > 0)
                            {
                                <input type="text" class="form-control"
                                       value="@effectiveAmount.ToString("C") (Adjusted from @Model.Sale.TotalAmount.ToString("C"))" readonly />
                                <div class="form-text text-warning">
                                    <i class="fas fa-info-circle"></i>
                                    This sale has adjustments totaling @totalAdjustments.ToString("C")
                                </div>
                            }
                            else
                            {
                                <input type="text" class="form-control" value="@Model.Sale.TotalAmount.ToString("C")" readonly />
                            }
                        </div>

                        @if (Model.AmountPaid > 0)
                        {
                            <div class="mb-3">
                                <label class="form-label">Already Paid</label>
                                <input type="text" class="form-control text-success fw-bold"
                                       value="@Model.AmountPaid.ToString("C")" readonly />
                                @if (Model.Payments.Count > 1)
                                {
                                    <div class="form-text">@Model.Payments.Count payments recorded</div>
                                }
                            </div>
                        }

                        <div class="mb-3">
                            <label class="form-label">Remaining Balance</label>
                            <input type="text" class="form-control fw-bold @(Model.RemainingBalance > 0 ? "text-danger" : "text-success")"
                                   value="@Model.RemainingBalance.ToString("C")" readonly />
                        </div>

                        <div class="mb-3">
                            <label for="paymentAmount" class="form-label">Payment Amount *</label>
                            <input type="number" step="0.01" class="form-control" id="paymentAmount" name="paymentAmount"
                                   value="@Model.RemainingBalance" max="@Model.RemainingBalance" min="0.01" required />
                            <div class="form-text">Enter the amount received from the customer</div>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method *</label>
                            <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                                <option value="">Select payment method...</option>
                                <option value="Cash">Cash</option>
                                <option value="Check">Check</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="PayPal">PayPal</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="paymentDate" class="form-label">Payment Date *</label>
                            <input type="date" class="form-control" id="paymentDate" name="paymentDate"
                                   value="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                        </div>
                        <div class="mb-3">
                            <label for="paymentNotes" class="form-label">Payment Notes</label>
                            <textarea class="form-control" id="paymentNotes" name="paymentNotes" rows="2"
                                      placeholder="Check number, transaction ID, reference number, etc."></textarea>
                            <div class="form-text">Optional notes about this payment</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Record Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- Process Sale Confirmation Modal -->
<div class="modal fade" id="processSaleModal" tabindex="-1" aria-labelledby="processSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="/Sales/ProcessSaleWithShipping" data-requires-validation="true">
                @Html.AntiForgeryToken()
                <input type="hidden" name="SaleId" value="@Model.Sale.Id" />
                <input type="hidden" name="SaleNumber" value="@Model.Sale.SaleNumber" />
                <input type="hidden" name="CustomerName" value="@Model.Sale.Customer?.CustomerName" />

                <div class="modal-header">
                    <h5 class="modal-title" id="processSaleModalLabel">
                        <i class="fas fa-shipping-fast"></i> Process & Ship Sale @Model.Sale.SaleNumber
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-warning" id="inventoryWarning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Inventory Impact:</strong>
                        <p class="mb-2">This sale contains <span id="inventoryItemCount"></span> that will reduce inventory levels:</p>
                        <ul id="inventoryItemsList" class="mb-0"></ul>
                    </div>

                    <div class="alert alert-info" id="noInventoryInfo" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <strong>No Inventory Impact:</strong>
                        <p class="mb-0">This sale contains only finished goods and non-inventory items. No raw material inventory will be reduced.</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-truck"></i> Shipping Information</h6>
                            <div class="mb-3">
                                <label for="courierService" class="form-label">Courier Service *</label>
                                <select class="form-select" id="courierService" name="CourierService" required>
                                    <option value="">Select courier service...</option>
                                    <option value="FedEx">FedEx</option>
                                    <option value="UPS">UPS</option>
                                    <option value="USPS">USPS</option>
                                    <option value="DHL">DHL</option>
                                    <option value="OnTrac">OnTrac</option>
                                    <option value="Local Delivery">Local Delivery</option>
                                    <option value="Customer Pickup">Customer Pickup</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="trackingNumber" class="form-label">Tracking Number *</label>
                                <input type="text" class="form-control" id="trackingNumber" name="TrackingNumber"
                                       placeholder="Enter tracking number" required />
                                <div class="form-text">Leave blank if customer pickup or local delivery</div>
                            </div>
                            <div class="mb-3">
                                <label for="expectedDeliveryDate" class="form-label">Expected Delivery Date</label>
                                <input type="date" class="form-control" id="expectedDeliveryDate" name="ExpectedDeliveryDate"
                                       min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6><i class="fas fa-box"></i> Package Information</h6>
                            <div class="mb-3">
                                <label for="packageWeight" class="form-label">Package Weight (lbs)</label>
                                <input type="number" class="form-control" id="packageWeight" name="PackageWeight"
                                       step="0.1" min="0" placeholder="0.0" />
                            </div>
                            <div class="mb-3">
                                <label for="packageDimensions" class="form-label">Package Dimensions</label>
                                <input type="text" class="form-control" id="packageDimensions" name="PackageDimensions"
                                       placeholder="e.g., 12x8x6 inches" />
                            </div>
                            <div class="mb-3">
                                <label for="shippingInstructions" class="form-label">Shipping Instructions</label>
                                <textarea class="form-control" id="shippingInstructions" name="ShippingInstructions"
                                          rows="3" placeholder="Special delivery instructions..."></textarea>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <h6><i class="fas fa-dollar-sign"></i> Freight-Out Cost Tracking</h6>
                    <div class="mb-3">
                        <label class="form-label">Carrier Account <span class="text-danger">*</span></label>
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="ShippingAccountType" id="accountTypeOur"
                                       value="@ShippingAccountType.OurAccount"
                                       checked onchange="updateShippingGuidance()" />
                                <label class="form-check-label" for="accountTypeOur">
                                    <i class="fas fa-building"></i> Our Account
                                    <small class="d-block text-muted">We pay the carrier — track freight-out cost</small>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="ShippingAccountType" id="accountTypeCustomer"
                                       value="@ShippingAccountType.CustomerAccount"
                                       onchange="updateShippingGuidance()" />
                                <label class="form-check-label" for="accountTypeCustomer">
                                    <i class="fas fa-user"></i> Customer's Account
                                    <small class="d-block text-muted">Carrier bills customer directly — no cost to us</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="actualCarrierCostRow">
                        <label for="actualCarrierCost" class="form-label">
                            Actual Carrier Cost
                            <small class="text-muted">(internal — not shown to customer)</small>
                        </label>
                        <div class="input-group" style="max-width: 240px;">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="actualCarrierCost" name="ActualCarrierCost"
                                   step="0.01" min="0" placeholder="0.00" oninput="updateShippingGuidance()" />
                        </div>
                        <div class="form-text">
                            Enter the amount you will pay FedEx / UPS. No GL entry is created now — this is queued
                            for <strong>Expenses ? Record Payment</strong> when the carrier invoice arrives.
                        </div>
                    </div>

                    <div id="shippingGuidanceAlert" class="alert mb-3" role="alert" style="display:none;"></div>

                    <hr>
                    <h6><i class="fas fa-cogs"></i> Processing Options</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input type="hidden" name="GeneratePackingSlip" value="false" />
                                <input class="form-check-input" type="checkbox" id="generatePackingSlip" name="GeneratePackingSlip" value="true" checked>
                                <label class="form-check-label" for="generatePackingSlip">
                                    <i class="fas fa-file-alt"></i> Generate Packing Slip
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input type="hidden" name="PrintPackingSlip" value="false" />
                                <input class="form-check-input" type="checkbox" id="printPackingSlip" name="PrintPackingSlip" value="true">
                                <label class="form-check-label" for="printPackingSlip">
                                    <i class="fas fa-print"></i> Auto-Print Packing Slip
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input type="hidden" name="EmailCustomer" value="false" />
                                <input class="form-check-input" type="checkbox" id="emailCustomer" name="EmailCustomer" value="true" checked>
                                <label class="form-check-label" for="emailCustomer">
                                    <i class="fas fa-envelope"></i> Email Shipping Notice to Customer
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-info-circle"></i> This action will:</h6>
                        <ul class="mb-0">
                            <li>Mark the sale as <strong>Shipped</strong></li>
                            <li>Record shipping information and tracking details</li>
                            <li>Reduce inventory levels for physical items</li>
                            <li>Set shipped date to current date/time</li>
                            <li>Generate packing slip (if selected)</li>
                            <li>Send email notification (if selected)</li>
                            <li><strong>Cannot be undone</strong></li>
                        </ul>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-shipping-fast"></i> Process & Ship Sale
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Mark as Delivered Confirmation Modal -->
@if (Model.CanMarkAsDelivered)
{
    <div class="modal fade" id="markAsDeliveredModal" tabindex="-1" aria-labelledby="markAsDeliveredModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="MarkAs Delivered" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="saleId" value="@Model.Sale.Id" />

                    <div class="modal-header">
                        <h5 class="modal-title" id="markAsDeliveredModalLabel">
                            <i class="fas fa-check-circle text-success"></i> Confirm Delivery — Sale @Model.Sale.SaleNumber
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        @if (Model.HasMissingDocumentWarning)
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Note:</strong> This sale is currently <em>Partially Shipped</em> because the following
                                service type(s) are missing required documents:
                                <ul class="mb-0 mt-1">
                                    @foreach (var name in Model.MissingDocumentServiceNames)
                                    {
                                        <li><strong>@name</strong></li>
                                    }
                                </ul>
                                <hr class="my-2" />
                                You can still confirm delivery. Consider uploading the missing documents after marking as delivered.
                            </div>
                        }

                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> This action will:</h6>
                            <ul class="mb-0">
                                <li>Change the sale status to <strong>Delivered</strong></li>
                                <li>Record the confirmed delivery date (<strong>@DateTime.Today.ToString("MM/dd/yyyy")</strong>)</li>
                                <li>Append any delivery notes to the sale record</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <label for="deliveryNotes" class="form-label">Delivery Notes <span class="text-muted">(optional)</span></label>
                            <textarea class="form-control" id="deliveryNotes" name="deliveryNotes" rows="3"
                                      placeholder="e.g., Signed for by J. Smith, left at front desk, confirmed via phone..."></textarea>
                            <div class="form-text">Notes will be appended to the sale record.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Current Status</label>
                            <div>
                                <span class="badge bg-@Model.ConsolidatedStatusBadgeColor fs-6">@Model.ConsolidatedStatus</span>
                                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                                <span class="badge bg-info fs-6">Delivered</span>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check-circle"></i> Confirm Delivery
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- Delete Sale / Quotation Confirmation Modal -->
@if (Model.Sale.SaleStatus == InventorySystem.Models.Enums.SaleStatus.Processing ||
     Model.Sale.SaleStatus == InventorySystem.Models.Enums.SaleStatus.Quotation)
{
    <div class="modal fade" id="deleteSaleModal" tabindex="-1" aria-labelledby="deleteSaleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteSaleModalLabel">
                        <i class="fas fa-trash"></i>
                        @(Model.Sale.IsQuotation ? "Delete Quotation" : "Delete Sale")
                        @Model.Sale.SaleNumber
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>This action cannot be undone.</strong>
                    </div>
                    <p>
                        Are you sure you want to permanently delete
                        <strong>@(Model.Sale.IsQuotation ? "Quotation" : "Sale") @Model.Sale.SaleNumber</strong>?
                    </p>
                    <p class="text-muted small">All line items associated with this record will also be removed.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <form asp-action="Delete" asp-route-id="@Model.Sale.Id" method="post" style="display:inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Yes, Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}
