@model InventorySystem.ViewModels.SaleDetailsViewModel
@using InventorySystem.Models
@using InventorySystem.Services
@using InventorySystem.Models.Enums
@using InventorySystem.Helpers
@{
    ViewData["Title"] = Model.Sale.IsQuotation && Model.Sale.SaleStatus == SaleStatus.Quotation ? "Quotation Details" : "Sale Details";

    var hasIncompleteServiceOrders = Model.ServiceOrders.Any(so => so.Status != ServiceOrderStatus.Completed);
    var canProcessSale = !hasIncompleteServiceOrders;
    var isProformaInvoice = Model.Sale.SaleStatus != SaleStatus.Shipped && Model.Sale.SaleStatus != SaleStatus.Delivered;

    // Pass computed flags to partials via ViewData
    ViewData["CanProcessSale"] = canProcessSale;
    ViewData["IsProformaInvoice"] = isProformaInvoice;
    ViewData["HasIncompleteServiceOrders"] = hasIncompleteServiceOrders;
}

@await Html.PartialAsync("_DetailsHeader", Model)
@await Html.PartialAsync("_DetailsCustomerCard", Model)
@await Html.PartialAsync("_DetailsSaleInfoCards", Model)
@await Html.PartialAsync("_DetailsDiscountCard", Model)
@await Html.PartialAsync("_DetailsAdjustmentsCard", Model)
@await Html.PartialAsync("_DetailsSaleItemsTable", Model)
@await Html.PartialAsync("_DetailsShipmentsCard", Model)
@await Html.PartialAsync("_DetailsServiceOrdersCard", Model)
@await Html.PartialAsync("_DetailsFinancialSummary", Model)
@await Html.PartialAsync("_DetailsModals", Model)

@section Scripts {
    <script src="~/js/confirmation-dialog.js"></script>
    <script src="~/js/sales-enhanced-validation.js"></script>
    <script>
        // ── Phase 6: Freight-Out inline guidance (§7.2 of ShippingCostAccountingGuide) ──
        var saleShippingCost = @Model.Sale.ShippingCost.ToString(System.Globalization.CultureInfo.InvariantCulture);

        function updateShippingGuidance() {
            var isCustomerAccount = document.getElementById('accountTypeCustomer').checked;
            var costInput = document.getElementById('actualCarrierCost');
            var costRow = document.getElementById('actualCarrierCostRow');
            var alertDiv = document.getElementById('shippingGuidanceAlert');

            if (isCustomerAccount) {
                costRow.style.display = 'none';
                costInput.value = '';
                costInput.disabled = true;
            } else {
                costRow.style.display = '';
                costInput.disabled = false;
            }

            var alertClass = '';
            var message = '';

            if (isCustomerAccount) {
                alertClass = 'alert-info';
                message = '<i class="fas fa-info-circle me-1"></i> Shipping billed directly to customer by carrier. No freight-out expense will be recorded.';
            } else {
                var actualCost = parseFloat(costInput.value) || 0;

                if (actualCost === 0) {
                    alertClass = 'alert-warning';
                    message = '<i class="fas fa-exclamation-triangle me-1"></i> Enter the actual carrier cost so unpaid freight can be tracked.';
                } else if (saleShippingCost === 0 && actualCost > 0) {
                    alertClass = 'alert-warning';
                    message = '<i class="fas fa-exclamation-triangle me-1"></i> Free shipping to customer. Full carrier cost of '
                        + formatCurrency(actualCost) + ' will be recorded as Freight-Out when paid.';
                } else if (saleShippingCost < actualCost) {
                    var delta = actualCost - saleShippingCost;
                    alertClass = 'alert-warning';
                    message = '<i class="fas fa-exclamation-triangle me-1"></i> Under-recovery: you absorb '
                        + formatCurrency(delta) + '. Net freight-out cost: ' + formatCurrency(delta) + '.';
                } else if (saleShippingCost === actualCost) {
                    alertClass = 'alert-success';
                    message = '<i class="fas fa-check-circle me-1"></i> Exact cost recovery. No net freight-out expense.';
                } else {
                    var profit = saleShippingCost - actualCost;
                    alertClass = 'alert-info';
                    message = '<i class="fas fa-info-circle me-1"></i> Over-recovery: shipping contributes '
                        + formatCurrency(profit) + ' net revenue.';
                }
            }

            alertDiv.className = 'alert mb-3 ' + alertClass;
            alertDiv.innerHTML = message;
            alertDiv.style.display = '';
        }

        function formatCurrency(value) {
            return '$' + value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        document.getElementById('processSaleModal').addEventListener('show.bs.modal', function () {
            updateShippingGuidance();
            loadSaleInventoryInfo(@Model.Sale.Id);
        });

        @if (TempData["ToastMessage"] != null)
        {
            <text>document.body.dataset.toastMessage = @Html.Raw(Json.Serialize(TempData["ToastMessage"].ToString()));</text>
            <text>document.body.dataset.toastType = @Html.Raw(Json.Serialize(TempData["ToastType"]?.ToString() ?? "info"));</text>
        }

        @if (TempData["ServiceOrderPrompt"] != null)
        {
            <text>document.body.dataset.serviceOrderPrompt = 'true';</text>
            <text>document.body.dataset.missingServiceOrders = @Html.Raw(TempData["MissingServiceOrders"]?.ToString() ?? "[]");</text>
            <text>document.body.dataset.serviceOrderCreationUrl = @Html.Raw(Json.Serialize(TempData["ServiceOrderCreationUrl"]?.ToString() ?? ""));</text>
        }

        async function removeItemWithConfirmation(saleItemId, saleId, partNumber, productName, quantity, unitPrice) {
            const confirmed = await confirmRemove('sale item',
                `<div class="mt-2">
                    <strong>Item Details:</strong><br>
                    <div class="ps-3">
                        <div><strong>Part Number:</strong> ${partNumber}</div>
                        <div><strong>Product:</strong> ${productName}</div>
                        <div><strong>Quantity:</strong> ${quantity}</div>
                        <div><strong>Unit Price:</strong> ${unitPrice}</div>
                    </div>
                    <div class="alert alert-warning mt-2 mb-0">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Warning:</strong> This will permanently remove the item from this sale and cannot be undone.
                    </div>
                </div>`
            );

            if (confirmed) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Sales/RemoveItem';
                form.style.display = 'none';

                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token;
                form.appendChild(tokenInput);

                const saleItemInput = document.createElement('input');
                saleItemInput.type = 'hidden';
                saleItemInput.name = 'saleItemId';
                saleItemInput.value = saleItemId;
                form.appendChild(saleItemInput);

                const saleInput = document.createElement('input');
                saleInput.type = 'hidden';
                saleInput.name = 'saleId';
                saleInput.value = saleId;
                form.appendChild(saleInput);

                const button = event.target.closest('button');
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;

                document.body.appendChild(form);
                form.submit();
            }
        }

        function showItemDetails(itemId) {
            const modal = new bootstrap.Modal(document.getElementById('itemDetailsModal'));
            const content = document.getElementById('itemDetailsContent');
            const viewFullLink = document.getElementById('viewFullItemLink');

            viewFullLink.href = `/Items/Details/${itemId}`;
            content.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    <p class="mt-2">Loading item details...</p>
                </div>`;
            modal.show();

            fetch(`/Items/Details/${itemId}`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const mainContent = doc.querySelector('.card-body') || doc.querySelector('main') || doc.body;
                    if (mainContent) {
                        content.innerHTML = mainContent.innerHTML;
                        content.querySelectorAll('input, select, textarea, button').forEach(el => {
                            el.disabled = true;
                            if (el.tagName === 'BUTTON') el.style.display = 'none';
                        });
                    } else {
                        content.innerHTML = '<p class="text-danger">Error loading item details.</p>';
                    }
                })
                .catch(() => {
                    content.innerHTML = '<p class="text-danger">Error loading item details. Please try again.</p>';
                });
        }

        function showFinishedGoodDetails(finishedGoodId) {
            const modal = new bootstrap.Modal(document.getElementById('itemDetailsModal'));
            const content = document.getElementById('itemDetailsContent');
            const viewFullLink = document.getElementById('viewFullItemLink');
            const modalTitle = document.getElementById('itemDetailsModalLabel');

            modalTitle.innerHTML = '<i class="fas fa-cube"></i> Finished Good Details';
            viewFullLink.href = `/Production/FinishedGoodDetails/${finishedGoodId}`;
            content.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    <p class="mt-2">Loading finished good details...</p>
                </div>`;
            modal.show();

            fetch(`/Production/FinishedGoodDetails/${finishedGoodId}`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const mainContent = doc.querySelector('.card-body') || doc.querySelector('main') || doc.body;
                    if (mainContent) {
                        content.innerHTML = mainContent.innerHTML;
                        content.querySelectorAll('input, select, textarea, button').forEach(el => {
                            el.disabled = true;
                            if (el.tagName === 'BUTTON') el.style.display = 'none';
                        });
                    } else {
                        content.innerHTML = '<p class="text-danger">Error loading finished good details.</p>';
                    }
                })
                .catch(() => {
                    content.innerHTML = '<p class="text-danger">Error loading finished good details. Please try again.</p>';
                });
        }

        function showItemImageModal(partNumber, imageUrl) {
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            document.getElementById('imageModalLabel').textContent = `${partNumber} - Item Image`;
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('modalImage').alt = partNumber;
            modal.show();
        }

        $(document).ready(function () {
            $('#courierService').on('change', function () {
                const courier = $(this).val();
                const trackingInput = $('#trackingNumber');
                trackingInput.val('');

                switch (courier) {
                    case 'FedEx':
                        trackingInput.attr('placeholder', 'e.g., 1234 5678 9012').attr('pattern', '[0-9\\s]{12,}');
                        break;
                    case 'UPS':
                        trackingInput.attr('placeholder', 'e.g., 1Z999AA1234567890').attr('pattern', '1Z[0-9A-Z]{16}');
                        break;
                    case 'USPS':
                        trackingInput.attr('placeholder', 'e.g., 9400 1234 5678 9012 3456 78').attr('pattern', '[0-9\\s]{20,}');
                        break;
                    case 'Customer Pickup':
                    case 'Local Delivery':
                        trackingInput.val('N/A').attr('readonly', true).removeAttr('required');
                        break;
                    default:
                        trackingInput.attr('placeholder', 'Enter tracking number').removeAttr('pattern').removeAttr('readonly').attr('required', true);
                        break;
                }
            });

            $('#paymentAmount').on('change', function () {
                var paymentAmount = parseFloat($(this).val());
                var remainingBalance = @((Model.Sale.Customer?.OutstandingBalance ?? 0));
                if (paymentAmount > remainingBalance) {
                    alert('Payment amount cannot exceed remaining balance of $' + remainingBalance.toFixed(2));
                    $(this).val(remainingBalance.toFixed(2));
                }
            });
        });

        function loadSaleInventoryInfo(saleId) {
            $.get('/Sales/GetSaleInventoryInfo/' + saleId, function (data) {
                if (data.success) {
                    if (data.inventoryItemsCount > 0) {
                        $('#inventoryItemCount').text(data.inventoryItemsCount + ' item(s)');
                        var itemsList = $('#inventoryItemsList');
                        itemsList.empty();
                        data.inventoryItems.forEach(function (item) {
                            itemsList.append('<li>' + item.partNumber + ' - ' + item.description + ' (Qty: ' + item.quantity + ', Stock: ' + item.currentStock + ')</li>');
                        });
                        $('#inventoryWarning').show();
                        $('#noInventoryInfo').hide();
                    } else {
                        $('#noInventoryInfo').show();
                        $('#inventoryWarning').hide();
                    }
                }
            }).fail(function () {
                $('#noInventoryInfo').show();
                $('#inventoryWarning').hide();
            });
        }

        function checkBackorderAvailability() {
            fetch('/Sales/CheckBackorderAvailability?saleId=' + @Model.Sale.Id)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.hasAvailableItems) {
                        showBackorderNotification(data.summary);
                    }
                })
                .catch(error => console.error('Error checking backorder availability:', error));
        }

        function showBackorderNotification(summary) {
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <strong>Items Available for Shipment!</strong><br>
                ${summary.itemsAvailable} of ${summary.totalItems} backordered items are now available for shipment.
                <a href="/Sales/CreateAdditionalShipment?saleId=@Model.Sale.Id" class="btn btn-sm btn-success ms-2">
                    <i class="fas fa-shipping-fast"></i> Create Shipment
                </a>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const firstCard = document.querySelector('.card');
            if (firstCard) firstCard.parentNode.insertBefore(notification, firstCard);
        }

        @if (Model.Sale.SaleStatus == SaleStatus.Backordered)
        {
            <text>
            setTimeout(() => { checkBackorderAvailability(); }, 1000);
            </text>
        }
    </script>
}