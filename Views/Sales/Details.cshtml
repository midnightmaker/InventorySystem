@model InventorySystem.ViewModels.SaleDetailsViewModel
@using InventorySystem.Models
@using InventorySystem.Services
@using InventorySystem.Models.Enums
@using InventorySystem.Helpers
@{
    ViewData["Title"] = "Sale Details";
    var sale = Model.Sale;  // For easier reference
}

@{
  // Get adjustments for this sale using the new navigation property
  var saleAdjustments = Model.Sale.RelatedAdjustments?.ToList() ?? new List<CustomerBalanceAdjustment>();
  var totalAdjustments = saleAdjustments.Sum(a => a.AdjustmentAmount);
  var effectiveAmount = Model.Sale.TotalAmount - totalAdjustments;
  var totalCost = Model.Sale.SaleItems.Sum(si => si.TotalCost);
  var grossRevenue = Model.Sale.SubtotalAmount; // Before discount
  var netRevenue = Model.Sale.TotalAmount; // After discount but before adjustments
  var grossProfit = grossRevenue - totalCost; // Profit before discount
  var netProfit = netRevenue - totalCost; // Profit after discount
  var adjustedProfit = netProfit - totalAdjustments; // Final profit after all adjustments
  var afterDiscountAmount = Model.Sale.SubtotalAmount - Model.Sale.DiscountCalculated; // Add this line
  
  // ✅ NEW: Check if sale has service items that might need service orders
  var hasServiceItems = Model.Sale.SaleItems?.Any(si => si.Item?.ItemType == ItemType.Service) == true;
  var hasIncompleteServiceOrders = Model.ServiceOrders.Any(so => so.Status != ServiceOrderStatus.Completed);
  var canProcessSale = !hasServiceItems || !hasIncompleteServiceOrders;
  
  // ✅ NEW: Determine if adjustments can be created
  var canCreateAdjustments = Model.Sale.SaleStatus == SaleStatus.Shipped || Model.Sale.SaleStatus == SaleStatus.Delivered;
  
  // ✅ NEW: Determine invoice type
  var isProformaInvoice = Model.Sale.SaleStatus != SaleStatus.Shipped && Model.Sale.SaleStatus != SaleStatus.Delivered;
}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-shopping-cart"></i> Sale @Model.Sale.SaleNumber</h1>
  <div class="btn-group">
    <a href="/Sales" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Back to Sales
    </a>
    <a href="/Sales/Edit/@Model.Sale.Id" class="btn btn-outline-primary">
      <i class="fas fa-edit"></i> Edit
    </a>
    @* Only show Add Item button for modifiable sales *@
    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
    {
      <a href="/Sales/AddItem?saleId=@Model.Sale.Id" class="btn btn-success">
        <i class="fas fa-plus"></i> Add Item
      </a>
    }
    
    @* ✅ UPDATED: Process & Ship button with service validation *@
    @if (Model.Sale.SaleStatus == SaleStatus.Processing && Model.Sale.SaleItems?.Any() == true)
    {
      @if (canProcessSale)
      {
        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#processSaleModal">
          <i class="fas fa-shipping-fast"></i> Process & Ship
        </button>
      }
      else
      {
        <button type="button" class="btn btn-warning" disabled title="Complete all service orders before shipping">
          <i class="fas fa-shipping-fast"></i> Process & Ship
          <small class="d-block">Services Pending</small>
        </button>
      }
    }
    
    @* ✅ UPDATED: View Invoice button shows proforma status *@
    <a href="@Url.Action("InvoiceReport", new { saleId = Model.Sale.Id })"
       class="btn btn-primary">
      <i class="fas fa-file-invoice-dollar"></i> 
      @if (isProformaInvoice)
      {
        <text>View Proforma</text>
      }
      else
      {
        <text>View Invoice</text>
      }
    </a>
    
    @* ✅ ADD PACKING SLIP BUTTON for shipped sales *@
    @if (Model.Sale.SaleStatus == SaleStatus.Shipped || Model.Sale.SaleStatus == SaleStatus.Delivered)
    {
      <a href="@Url.Action("PackingSlip", new { saleId = Model.Sale.Id })" 
         target="_blank" class="btn btn-info">
        <i class="fas fa-clipboard-list"></i> Packing Slip
      </a>
    }
    
    @if (Model.Sale.PaymentStatus != PaymentStatus.Paid)
    {
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#recordPaymentModal">
        <i class="fas fa-dollar-sign"></i> Record Payment
      </button>
    }
  </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
  <div class="alert alert-success alert-dismissible fade show">
    <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
}

@if (TempData["ErrorMessage"] != null)
{
  <div class="alert alert-danger alert-dismissible fade show">
    <i class="fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
}

<!-- ✅ MOVED TO TOP: Customer Information Card - Full Width -->
@if (Model.Sale.Customer != null)
{
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-info">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-user"></i> Customer Information</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Basic customer info -->
            <div class="col-md-4">
              <dl class="row">
                <dt class="col-sm-4">Name:</dt>
                <dd class="col-sm-8">
                  <a href="/Customers/Details/@Model.Sale.Customer.Id" class="text-decoration-none">
                    @Model.Sale.Customer.CustomerName
                  </a>
                </dd>
                
                @if (!string.IsNullOrEmpty(Model.Sale.Customer.CompanyName))
                {
                  <dt class="col-sm-4">Company:</dt>
                  <dd class="col-sm-8">@Model.Sale.Customer.CompanyName</dd>
                }
                
                @if (!string.IsNullOrEmpty(Model.Sale.Customer.Email))
                {
                  <dt class="col-sm-4">Email:</dt>
                  <dd class="col-sm-8">
                    <a href="mailto:@Model.Sale.Customer.Email">@Model.Sale.Customer.Email</a>
                  </dd>
                }
                
                @if (!string.IsNullOrEmpty(Model.Sale.Customer.Phone))
                {
                  <dt class="col-sm-4">Phone:</dt>
                  <dd class="col-sm-8">@Model.Sale.Customer.Phone</dd>
                }
              </dl>
            </div>
            
            <!-- Credit information -->
            <div class="col-md-4">
              <table class="table table-sm">
                <tr class="@(Model.Sale.Customer.OutstandingBalance > 0 ? "table-warning" : "table-success")">
                  <td><strong>Outstanding Balance:</strong></td>
                  <td class="text-end"><strong>@Model.Sale.Customer.OutstandingBalance.ToString("C")</strong></td>
                </tr>
                <tr>
                  <td><strong>Credit Limit:</strong></td>
                  <td class="text-end">@Model.Sale.Customer.CreditLimit.ToString("C")</td>
                </tr>
                <tr class="@(Model.Sale.Customer.CreditAvailable > 0 ? "table-success" : "table-danger")">
                  <td><strong>Available Credit:</strong></td>
                  <td class="text-end"><strong>@Model.Sale.Customer.CreditAvailable.ToString("C")</strong></td>
                </tr>
              </table>
            </div>
            
            <!-- Customer status & alerts -->
            <div class="col-md-4">
              @if (Model.Sale.Customer.OutstandingBalance > Model.Sale.Customer.CreditLimit)
              {
                <div class="alert alert-danger mb-2">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Credit Alert:</strong><br>
                  Customer is over credit limit by @((Model.Sale.Customer.OutstandingBalance - Model.Sale.Customer.CreditLimit).ToString("C"))
                </div>
              }
              
              <div class="btn-group d-grid gap-2">
                <a href="/Customers/Details/@Model.Sale.Customer.Id" class="btn btn-outline-info btn-sm">
                  <i class="fas fa-user"></i> View Customer Details
                </a>
                @* ✅ UPDATED: Create Adjustment button with status check *@
                @if (canCreateAdjustments)
                {
                  <a href="/Accounting/CreateCustomerAdjustment?customerId=@Model.Sale.CustomerId&saleId=@Model.Sale.Id" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-adjust"></i> Create Adjustment
                  </a>
                }
                else
                {
                  <button class="btn btn-outline-secondary btn-sm" disabled title="Adjustments can only be created after sale is shipped">
                    <i class="fas fa-adjust"></i> Create Adjustment
                    <small class="d-block">Requires Shipped Status</small>
                  </button>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<!-- Sale Information Header -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <dl class="row">
              <dt class="col-sm-6">Sale Date:</dt>
              <dd class="col-sm-6">@Model.Sale.SaleDate.ToString("MM/dd/yyyy")</dd>
              <dt class="col-sm-6">Due Date:</dt>
              <dd class="col-sm-6">@Model.Sale.PaymentDueDate.ToString("MM/dd/yyyy")</dd>
              <dt class="col-sm-6">Terms:</dt>
              <dd class="col-sm-6">@Model.Sale.Terms</dd>
            </dl>
          </div>
          <div class="col-md-3">
            <dl class="row">
              <dt class="col-sm-6">Sale Status:</dt>
              <dd class="col-sm-6">
                <span class="badge bg-@BadgeHelper.GetSaleStatusBadgeColor(Model.Sale.SaleStatus)">@Model.Sale.SaleStatus</span>
              </dd>
              <dt class="col-sm-6">Payment:</dt>
              <dd class="col-sm-6">
                <span class="badge bg-@BadgeHelper.GetPaymentStatusBadgeColor(Model.Sale.PaymentStatus)">@Model.Sale.PaymentStatus</span>
              </dd>
              @if (Model.Sale.IsOverdue)
              {
                <dt class="col-sm-6">Days Overdue:</dt>
                <dd class="col-sm-6"><span class="badge bg-danger">@Model.Sale.DaysOverdue</span></dd>
              }
            </dl>
          </div>
          <div class="col-md-3">
            @if (!string.IsNullOrEmpty(Model.Sale.OrderNumber))
            {
              <dl class="row">
                <dt class="col-sm-6">Order Number:</dt>
                <dd class="col-sm-6">@Model.Sale.OrderNumber</dd>
              </dl>
            }
            @if (!string.IsNullOrEmpty(Model.Sale.PaymentMethod))
            {
              <dl class="row">
                <dt class="col-sm-6">Payment Method:</dt>
                <dd class="col-sm-6">@Model.Sale.PaymentMethod</dd>
              </dl>
            }
          </div>
          <div class="col-md-3">
            @if (!string.IsNullOrEmpty(Model.Sale.Notes))
            {
              <dl class="row">
                <dt class="col-sm-12">Notes:</dt>
                <dd class="col-sm-12"><small class="text-muted">@Model.Sale.Notes</small></dd>
              </dl>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@if (Model.Sale.HasDiscount)
{
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-info">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="fas"></i> Sales Discount Applied
            <span class="badge bg-dark ms-2">@Model.Sale.DiscountCalculated.ToString("C") </span>
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-4">Discount Type:</dt>
                <dd class="col-sm-8">
                  <span class="badge bg-secondary">@Model.Sale.DiscountType</span>
                </dd>
                @if (Model.Sale.DiscountType == "Percentage")
                {
                  <dt class="col-sm-4">Percentage:</dt>
                  <dd class="col-sm-8"><strong>@Model.Sale.DiscountPercentage%</strong></dd>
                }
                else
                {
                  <dt class="col-sm-4">Amount:</dt>
                  <dd class="col-sm-8"><strong>@Model.Sale.DiscountAmount.ToString("C")</strong></dd>
                }
                <dt class="col-sm-4">Total Savings:</dt>
                <dd class="col-sm-8"><strong class="text-success">@Model.Sale.DiscountCalculated.ToString("C")</strong></dd>
              </dl>
            </div>
            <div class="col-md-6">
              @if (!string.IsNullOrEmpty(Model.Sale.DiscountReason))
              {
                <dl class="row">
                  <dt class="col-sm-3">Reason:</dt>
                  <dd class="col-sm-9">@Model.Sale.DiscountReason</dd>
                </dl>
              }
              <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle"></i>
                <strong>Note:</strong> This discount was applied at the time of sale and is different from post-sale adjustments.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
}

@if (saleAdjustments.Any())
{
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-warning">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">
            <i class="fas fa-adjust"></i> Post-Sale Adjustments
            <span class="badge bg-dark ms-2">@saleAdjustments.Count Applied</span>
          </h5>
        </div>
        <div class="card-body">
          <!-- Adjustment Summary -->
          <div class="row mb-3">
            <div class="col-md-6">
              <h6>Financial Impact:</h6>
              <table class="table table-sm">
                <tr>
                  <td><strong>Original Invoice Amount:</strong></td>
                  <td class="text-end">@Model.Sale.TotalAmount.ToString("C")</td>
                </tr>
                <tr>
                  <td><strong>Total Adjustments:</strong></td>
                  <td class="text-end text-success">-@totalAdjustments.ToString("C")</td>
                </tr>
                <tr class="table-light">
                  <td><strong>Effective Amount:</strong></td>
                  <td class="text-end"><strong>@effectiveAmount.ToString("C")</strong></td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6>Quick Actions:</h6>
              <div class="btn-group-vertical d-grid gap-2">
                <a href="/Sales/GenerateRevisedInvoice/@Model.Sale.Id" class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-file-invoice"></i> Generate Revised Invoice
                </a>
                @if (canCreateAdjustments)
                {
                  <a href="/Accounting/CreateCustomerAdjustment?customerId=@Model.Sale.CustomerId&saleId=@Model.Sale.Id" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-plus"></i> Add New Adjustment
                  </a>
                }
              </div>
            </div>
          </div>

          <!-- Adjustments List -->
          <h6>Applied Adjustments:</h6>
          <div class="table-responsive">
            <table class="table table-hover table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Reason</th>
                  <th>Applied By</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                @foreach (var adjustment in saleAdjustments.OrderByDescending(a => a.AdjustmentDate))
                {
                  <tr>
                    <td>@adjustment.AdjustmentDate.ToString("MM/dd/yyyy")</td>
                    <td>
                      <span class="badge bg-@(adjustment.AdjustmentType == "Bad Debt Write-off" ? "danger" : "warning")">
                        @adjustment.AdjustmentType
                      </span>
                    </td>
                    <td class="text-end">
                      <strong class="text-success">@adjustment.AdjustmentAmount.ToString("C")</strong>
                    </td>
                    <td>
                      @if (adjustment.Reason.Length > 40)
                      {
                        <span title="@adjustment.Reason">
                          @adjustment.Reason.Substring(0, 40)...
                        </span>
                      }
                      else
                      {
                        @adjustment.Reason
                      }
                    </td>
                    <td>@adjustment.CreatedBy</td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm">
                        <a href="/Sales/GenerateRevisedInvoice/@Model.Sale.Id?adjustmentId=@adjustment.Id"
                           class="btn btn-outline-primary btn-sm" title="Revised Invoice for this adjustment">
                          <i class="fas fa-file-invoice"></i>
                        </a>
                        <a href="/Sales/GenerateCreditMemo?adjustmentId=@adjustment.Id"
                           class="btn btn-outline-success btn-sm" title="Generate Credit Memo">
                          <i class="fas fa-receipt"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Impact Notice -->
          <div class="alert alert-info mt-3">
            <h6><i class="fas fa-info-circle"></i> Payment Status Impact</h6>
            <p class="mb-0">
              Due to applied adjustments, the customer now owes
              <strong>@effectiveAmount.ToString("C")</strong>
              for this invoice instead of the original @Model.Sale.TotalAmount.ToString("C").
              @if (Model.Sale.PaymentStatus == PaymentStatus.Paid && effectiveAmount < Model.Sale.TotalAmount)
              {
                <span class="text-success">
                  <br><strong>Note:</strong> This invoice may be eligible for refund due to adjustments exceeding payments received.
                </span>
              }
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
}
else
{
  <!-- No Adjustments - Show Option to Create -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-light">
        <div class="card-body text-center py-3">
          <div class="text-muted mb-2">
            <i class="fas fa-info-circle"></i>
            @if (canCreateAdjustments)
            {
              <text>No adjustments have been applied to this sale.</text>
            }
            else
            {
              <text>No adjustments have been applied to this sale. Adjustments for shipping damage, missing items etc. can only be made after the sale has been processed and shipped.</text>
            }
          </div>
          @if (canCreateAdjustments)
          {
            <a href="/Accounting/CreateCustomerAdjustment?customerId=@Model.Sale.CustomerId&saleId=@Model.Sale.Id"
               class="btn btn-outline-primary btn-sm">
              <i class="fas fa-plus"></i> Apply Customer Adjustment
            </a>
          }
        </div>
      </div>
    </div>
  </div>
}

<!-- Sale Items in Full Width -->
<div class="row">
  <div class="col-12">
    <!-- Sale Items Card - Full Width -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-list"></i> Sale Items
          @if (Model.Sale.SaleItems?.Any() == true)
          {
            <span class="badge bg-primary ms-2">@Model.Sale.SaleItems.Count items</span>
          }
        </h5>
        @* Only show Add Item button for modifiable sales *@
        @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
        {
          <a href="/Sales/AddItem?saleId=@Model.Sale.Id" class="btn btn-success btn-sm">
            <i class="fas fa-plus"></i> Add Item
          </a>
        }
      </div>
      <div class="card-body">
        @if (Model.Sale.SaleItems?.Any() == true)
        {
          <div class="table-responsive">
            <table class="table table-hover" id="saleItemsTable" style="table-layout: fixed; width: 100%;">
              <colgroup>
                <col width="8%">
                <col width="12%">
                <col width="30%">
                <col width="10%">
                <col width="10%">
                <col width="15%">
                <col width="15%">
                @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                {
                  <col width="10%">
                }
              </colgroup>
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Part Number</th>
                  <th>Description</th>
                  <th>Type</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Unit Price</th>
                  <th class="text-end">Total</th>
                  @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                  {
                    <th class="text-center">Actions</th>
                  }
                </tr>
              </thead>
              <tbody>
                @foreach (var item in Model.Sale.SaleItems)
                {
                  <tr>
                    <td class="text-center">
                      @{
                        var itemId = item.ItemId ?? item.FinishedGoodId ?? 0;
                      }
                      @if (item.ItemId.HasValue)
                      {
                        <!-- Item thumbnail -->
                        <img src="/Items/GetImageThumbnail/@item.ItemId?size=40" 
                             alt="@item.ProductPartNumber"
                             class="item-thumbnail rounded"
                             style="width: 40px; height: 40px; object-fit: cover; cursor: pointer;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             onclick="showItemImageModal('@item.ProductPartNumber', '/Items/GetImage/@item.ItemId')" />
                        <div class="item-thumbnail-placeholder d-flex align-items-center justify-content-center rounded" 
                             style="width: 40px; height: 40px; background-color: #f8f9fa; border: 1px solid #dee2e6; display: none;">
                          <i class="fas fa-image text-muted" style="font-size: 16px;"></i>
                        </div>
                      }
                      else
                      {
                        <!-- Finished Good placeholder (no image support yet) -->
                        <div class="item-thumbnail-placeholder d-flex align-items-center justify-content-center rounded" 
                             style="width: 40px; height: 40px; background-color: #f8f9fa; border: 1px solid #dee2e6;">
                          <i class="fas fa-cube text-muted" style="font-size: 16px;"></i>
                        </div>
                      }
                    </td>
                    <td>
                      @if (item.ItemId.HasValue)
                      {
                        <a href="#" class="text-decoration-none" onclick="showItemDetails(@item.ItemId)" style="cursor: pointer;">
                          <code>@item.ProductPartNumber</code>
                        </a>
                      }
                      else
                      {
                        <code>@item.ProductPartNumber</code>
                      }
                      @if (item.QuantityBackordered > 0)
                      {
                        <br><span class="badge bg-warning text-dark ms-1">Backordered</span>
                      }
                    </td>
                    <td>
                      <strong>@item.ProductName</strong>
                      @if (!string.IsNullOrEmpty(item.Notes))
                      {
                        <br><small class="text-muted">@item.Notes</small>
                      }
                    </td>
                    <td>
                      <span class="badge bg-secondary">
                        @(item.ItemId.HasValue ? "Item" : "Finished Good")
                      </span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-primary">@item.QuantitySold</span>
                      @if (item.QuantityBackordered > 0)
                      {
                        <br><small class="text-warning">(@item.QuantityBackordered backord.)</small>
                      }
                    </td>
                    <td class="text-end">@item.UnitPrice.ToString("C")</td>
                    <td class="text-end"><strong>@item.TotalPrice.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td class="text-center">
                        <form method="post" action="/Sales/RemoveItem" style="display: inline;"
                              onsubmit="return confirm('Remove this item from the sale?')">
                          @Html.AntiForgeryToken()
                          <input type="hidden" name="saleItemId" value="@item.Id" />
                          <input type="hidden" name="saleId" value="@Model.Sale.Id" />
                          <button type="submit" class="btn btn-sm btn-outline-danger"
                                  title="Remove Item">
                            <i class="fas fa-trash"></i>
                          </button>
                        </form>
                      </td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
        else
        {
          <div class="text-center py-3">
            <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
            <p class="text-muted">No items added to this sale yet.</p>
            @* Only show Add First Item button for modifiable sales *@
            @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
            {
              <a href="/Sales/AddItem?saleId=@Model.Sale.Id" class="btn btn-success">
                <i class="fas fa-plus"></i> Add First Item
              </a>
            }
          </div>
        }
      </div>
    </div>
  </div>
</div>
<!-- Service Orders Section  -->
@if (Model.ServiceOrders.Any() || Model.Sale.SaleItems.Any(si => si.Item?.ItemType == ItemType.Service))
{
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-cogs"></i> Related Service Orders</h5>
            @if (Model.Sale.SaleItems.Any(si => si.Item?.ItemType == ItemType.Service))
            {
                <a href="@Url.Action("CreateServiceOrdersFromSale", new { saleId = Model.Sale.Id })" 
                   class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-plus"></i> Create Service Orders
                </a>
            }
        </div>
        <div class="card-body">
            @if (Model.ServiceOrders.Any())
            {
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Service Order</th>
                                <th>Service Type</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Promised Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var serviceOrder in Model.ServiceOrders)
                            {
                                <tr class="@(serviceOrder.Status != ServiceOrderStatus.Completed ? "table-warning" : "")">
                                    <td>
                                        <a href="@Url.Action("Details", "Services", new { id = serviceOrder.Id })">
                                            @serviceOrder.ServiceOrderNumber
                                        </a>
                                        @if (serviceOrder.Status != ServiceOrderStatus.Completed)
                                        {
                                            <br><small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Pending</small>
                                        }
                                    </td>
                                    <td>@serviceOrder.ServiceType?.ServiceName</td>
                                    <td>
                                        <span class="badge bg-@BadgeHelper.GetServiceOrderStatusBadgeColor(serviceOrder.Status)">
                                            @serviceOrder.StatusDisplay
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-@BadgeHelper.GetServicePriorityBadgeColor(serviceOrder.Priority)">
                                            @serviceOrder.PriorityDisplay
                                        </span>
                                    </td>
                                    <td>
                                        @if (serviceOrder.PromisedDate.HasValue)
                                        {
                                            <span class="@(serviceOrder.IsOverdue ? "text-danger" : "")">
                                                @serviceOrder.PromisedDate.Value.ToString("MM/dd/yyyy")
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <a href="@Url.Action("Details", "Services", new { id = serviceOrder.Id })" 
                                           class="btn btn-sm btn-outline-primary">
                                            View
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                @* ✅ NEW: Service Orders Status Summary *@
                @if (hasServiceItems)
                {
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Service Orders Status:</strong>
                        @if (hasIncompleteServiceOrders)
                        {
                            <span class="text-warning">Some service orders are still pending completion. The sale cannot be shipped until all service orders are completed.</span>
                        }
                        else
                        {
                            <span class="text-success">All service orders are completed and ready for shipment.</span>
                        }
                    </div>
                }
            }
            else if (Model.Sale.SaleItems.Any(si => si.Item?.ItemType == ItemType.Service))
            {
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Service Orders Required:</strong> This sale contains service items but no service orders have been created yet. Service orders must be created and completed before this sale can be shipped.
                    <a href="@Url.Action("CreateServiceOrdersFromSale", new { saleId = Model.Sale.Id })" 
                       class="btn btn-sm btn-primary ms-2">
                        Create Service Orders Now
                    </a>
                </div>
            }
        </div>
    </div>
}

<!-- Sale Summary Card - Perfect Column Alignment for Spreadsheet Effect -->
@if (Model.Sale.SaleItems?.Any() == true)
{
  <div class="row mt-0">
    <div class="col-12">
      <!-- Sale Summary Card with precise alignment -->
      <div class="card border-success" style="border-top: none; border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-calculator"></i> Financial Summary</h5>
        </div>
        <div class="card-body pt-2">
          <div class="table-responsive">
            <table class="table table-sm mb-0" style="table-layout: fixed; width: 100%;">
              <colgroup>
                <col width="8%">
                <col width="12%">
                <col width="30%">
                <col width="10%">
                <col width="10%">
                <col width="15%">
                <col width="15%">
                @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                {
                  <col width="10%">
                }
              </colgroup>
              <tbody>
                <!-- Financial Summary Rows -->
                <tr class="table-light">
                  <td colspan="6"><strong>Subtotal:</strong></td>
                  <td class="text-end"><strong>@Model.Sale.SubtotalAmount.ToString("C")</strong></td>
                  @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                  {
                    <td></td>
                  }
                </tr>
                
                @* Show discount if applied *@
                @if (Model.Sale.HasDiscount)
                {
                  <tr class="table-warning">
                    <td colspan="6"><strong>Discount:</strong></td>
                    <td class="text-end text-success"><strong>-@Model.Sale.DiscountCalculated.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                  <tr>
                    <td colspan="6">After Discount:</td>
                    <td class="text-end">@afterDiscountAmount.ToString("C")</td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                }
                
                <tr>
                  <td colspan="6">Tax Amount:</td>
                  <td class="text-end">@Model.Sale.TaxAmount.ToString("C")</td>
                  @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                  {
                    <td></td>
                  }
                </tr>
                <tr>
                  <td colspan="6">Shipping:</td>
                  <td class="text-end">@Model.Sale.ShippingCost.ToString("C")</td>
                  @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                  {
                    <td></td>
                  }
                </tr>
                
                @if (totalAdjustments > 0)
                {
                  <tr class="table-info">
                    <td colspan="6"><strong>Sale Total:</strong></td>
                    <td class="text-end"><strong>@Model.Sale.TotalAmount.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                  <tr class="table-warning">
                    <td colspan="6"><strong>Post-Sale Adjustments:</strong></td>
                    <td class="text-end text-success"><strong>-@totalAdjustments.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                  <tr class="table-dark">
                    <td colspan="6"><strong>Effective Total:</strong></td>
                    <td class="text-end"><strong>@effectiveAmount.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                }
                else
                {
                  <tr class="table-dark">
                    <td colspan="6"><strong>Total:</strong></td>
                    <td class="text-end"><strong>@Model.Sale.TotalAmount.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<!-- ✅ NEW: Profit Analysis Card with Header -->
@if (Model.Sale.SaleItems?.Any() == true)
{
  <div class="row mt-0">
    <div class="col-12">
      <!-- Profit Analysis Card -->
      <div class="card border-info" style="border-top: none; border-top-left-radius: 0; border-top-right-radius: 0;">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line"></i> Profit Analysis</h5>
        </div>
        <div class="card-body pt-2">
          <div class="table-responsive">
            <table class="table table-sm mb-0" style="table-layout: fixed; width: 100%;">
              <colgroup>
                <col width="8%">
                <col width="12%">
                <col width="30%">
                <col width="10%">
                <col width="10%">
                <col width="15%">
                <col width="15%">
                @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                {
                  <col width="10%">
                }
              </colgroup>
              <tbody>
                <!-- Profit Analysis Rows -->
                <tr class="table-secondary">
                  <td colspan="6"><strong>Total Cost:</strong></td>
                  <td class="text-end"><strong>@totalCost.ToString("C")</strong></td>
                  @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                  {
                    <td></td>
                  }
                </tr>
                
                @* Show gross profit calculation that accounts for discount *@
                @if (Model.Sale.HasDiscount)
                {
                  <tr class="table-secondary">
                    <td colspan="6"><strong>Gross Profit (before discount):</strong></td>
                    <td class="text-end"><strong>@grossProfit.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                  <tr class="@(netProfit >= 0 ? "table-success" : "table-danger")">
                    <td colspan="6"><strong>Net Profit (after discount):</strong></td>
                    <td class="text-end"><strong>@netProfit.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                }
                else
                {
                  <tr class="@(grossProfit >= 0 ? "table-success" : "table-danger")">
                    <td colspan="6"><strong>Gross Profit:</strong></td>
                    <td class="text-end"><strong>@grossProfit.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                }
                
                @if (totalAdjustments > 0)
                {
                  <tr class="@(adjustedProfit >= 0 ? "table-info" : "table-danger")">
                    <td colspan="6"><strong>Final Profit (after all adjustments):</strong></td>
                    <td class="text-end"><strong>@adjustedProfit.ToString("C")</strong></td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                }
                
                @* Show profit margins *@
                @if (netRevenue > 0)
                {
                  var profitMargin = (netProfit / netRevenue) * 100;
                  <tr class="table-light">
                    <td colspan="6"><strong>Profit Margin:</strong></td>
                    <td class="text-end">
                      <span class="badge bg-@(profitMargin >= 20 ? "success" : profitMargin >= 10 ? "warning" : "danger")">
                        @profitMargin.ToString("F1")%
                      </span>
                    </td>
                    @if (Model.Sale.SaleStatus == SaleStatus.Processing || Model.Sale.SaleStatus == SaleStatus.Backordered)
                    {
                      <td></td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<!-- Item Details Modal -->
<div class="modal fade" id="itemDetailsModal" tabindex="-1" aria-labelledby="itemDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="itemDetailsModalLabel">
          <i class="fas fa-cube"></i> Item Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="itemDetailsContent">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a href="#" id="viewFullItemLink" class="btn btn-primary" target="_blank">
          <i class="fas fa-external-link-alt"></i> View Full Details
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Item Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" src="" alt="" class="img-fluid rounded" />
      </div>
    </div>
  </div>
</div>

<!-- Payment Recording Modal -->
@if (Model.Sale.PaymentStatus != PaymentStatus.Paid)
{
  <div class="modal fade" id="recordPaymentModal" tabindex="-1" aria-labelledby="recordPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form asp-action="RecordPayment" method="post">
          <input type="hidden" name="saleId" value="@Model.Sale.Id" />
          <div class="modal-header">
            <h5 class="modal-title" id="recordPaymentModalLabel">
              <i class="fas fa-dollar-sign"></i> Record Payment - Sale @Model.Sale.SaleNumber
              @if (totalAdjustments > 0)
              {
                <span class="badge bg-warning text-dark">Adjusted</span>
              }
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Sale Total</label>
              @if (totalAdjustments > 0)
              {
                <input type="text" class="form-control" 
                       value="@effectiveAmount.ToString("C") (Adjusted from @Model.Sale.TotalAmount.ToString("C"))" readonly />
                <div class="form-text text-warning">
                  <i class="fas fa-info-circle"></i>
                  This sale has adjustments totaling @totalAdjustments.ToString("C")
                </div>
              }
              else
              {
                <input type="text" class="form-control" value="@Model.Sale.TotalAmount.ToString("C")" readonly />
              }
            </div>
            <div class="mb-3">
              <label for="paymentAmount" class="form-label">Payment Amount *</label>
              <input type="number" step="0.01" class="form-control" id="paymentAmount" name="paymentAmount" 
                     value="@effectiveAmount" max="@effectiveAmount" min="0.01" required />
              <div class="form-text">Enter the amount received from the customer</div>
            </div>
            <div class="mb-3">
              <label for="paymentMethod" class="form-label">Payment Method *</label>
              <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                <option value="">Select payment method...</option>
                <option value="Cash">Cash</option>
                <option value="Check">Check</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="PayPal">PayPal</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="paymentDate" class="form-label">Payment Date *</label>
              <input type="date" class="form-control" id="paymentDate" name="paymentDate" 
                     value="@DateTime.Today.ToString("yyyy-MM-dd")" required />
            </div>
            <div class="mb-3">
              <label for="paymentNotes" class="form-label">Payment Notes</label>
              <textarea class="form-control" id="paymentNotes" name="paymentNotes" rows="2" 
                        placeholder="Check number, transaction ID, reference number, etc."></textarea>
              <div class="form-text">Optional notes about this payment</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save"></i> Record Payment
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}

<!-- Process Sale Confirmation Modal - ENHANCED VERSION -->
<div class="modal fade" id="processSaleModal" tabindex="-1" aria-labelledby="processSaleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="/Sales/ProcessSaleWithShipping">
        @Html.AntiForgeryToken()
        <input type="hidden" name="SaleId" value="@Model.Sale.Id" />
        <input type="hidden" name="SaleNumber" value="@Model.Sale.SaleNumber" />
        <input type="hidden" name="CustomerName" value="@Model.Sale.Customer?.CustomerName" />
        
        <div class="modal-header">
          <h5 class="modal-title" id="processSaleModalLabel">
            <i class="fas fa-shipping-fast"></i> Process & Ship Sale @Model.Sale.SaleNumber
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <!-- Inventory Impact Section -->
          <div class="alert alert-warning" id="inventoryWarning" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Inventory Impact:</strong>
            <p class="mb-2">This sale contains <span id="inventoryItemCount"></span> that will reduce inventory levels:</p>
            <ul id="inventoryItemsList" class="mb-0"></ul>
          </div>
          
          <div class="alert alert-info" id="noInventoryInfo" style="display: none;">
            <i class="fas fa-info-circle"></i>
            <strong>No Inventory Impact:</strong>
            <p class="mb-0">This sale contains only services and virtual items. No inventory will be reduced.</p>
          </div>

          <!-- Shipping Information Section -->
          <div class="row">
            <div class="col-md-6">
              <h6><i class="fas fa-truck"></i> Shipping Information</h6>
              
              <div class="mb-3">
                <label for="courierService" class="form-label">Courier Service *</label>
                <select class="form-select" id="courierService" name="CourierService" required>
                  <option value="">Select courier service...</option>
                  <option value="FedEx">FedEx</option>
                  <option value="UPS">UPS</option>
                  <option value="USPS">USPS</option>
                  <option value="DHL">DHL</option>
                  <option value="OnTrac">OnTrac</option>
                  <option value="Local Delivery">Local Delivery</option>
                  <option value="Customer Pickup">Customer Pickup</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="trackingNumber" class="form-label">Tracking Number *</label>
                <input type="text" class="form-control" id="trackingNumber" name="TrackingNumber" 
                       placeholder="Enter tracking number" required />
                <div class="form-text">Leave blank if customer pickup or local delivery</div>
              </div>

              <div class="mb-3">
                <label for="expectedDeliveryDate" class="form-label">Expected Delivery Date</label>
                <input type="date" class="form-control" id="expectedDeliveryDate" name="ExpectedDeliveryDate" 
                       min="@DateTime.Today.ToString("yyyy-MM-dd")" />
              </div>
            </div>

            <div class="col-md-6">
              <h6><i class="fas fa-box"></i> Package Information</h6>
              
              <div class="mb-3">
                <label for="packageWeight" class="form-label">Package Weight (lbs)</label>
                <input type="number" class="form-control" id="packageWeight" name="PackageWeight" 
                       step="0.1" min="0" placeholder="0.0" />
              </div>

              <div class="mb-3">
                <label for="packageDimensions" class="form-label">Package Dimensions</label>
                <input type="text" class="form-control" id="packageDimensions" name="PackageDimensions" 
                       placeholder="e.g., 12x8x6 inches" />
              </div>

              <div class="mb-3">
                <label for="shippingInstructions" class="form-label">Shipping Instructions</label>
                <textarea class="form-control" id="shippingInstructions" name="ShippingInstructions" 
                          rows="3" placeholder="Special delivery instructions..."></textarea>
              </div>
            </div>
          </div>

          <!-- ✅ FIXED: Options Section with proper checkbox binding -->
          <hr>
          <h6><i class="fas fa-cogs"></i> Processing Options</h6>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-check mb-2">
                <input type="hidden" name="GeneratePackingSlip" value="false" />
                <input class="form-check-input" type="checkbox" id="generatePackingSlip" name="GeneratePackingSlip" value="true" checked>
                <label class="form-check-label" for="generatePackingSlip">
                  <i class="fas fa-file-alt"></i> Generate Packing Slip
                </label>
              </div>
              
              <div class="form-check mb-2">
                <input type="hidden" name="PrintPackingSlip" value="false" />
                <input class="form-check-input" type="checkbox" id="printPackingSlip" name="PrintPackingSlip" value="true">
                <label class="form-check-label" for="printPackingSlip">
                  <i class="fas fa-print"></i> Auto-Print Packing Slip
                </label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-check mb-2">
                <input type="hidden" name="EmailCustomer" value="false" />
                <input class="form-check-input" type="checkbox" id="emailCustomer" name="EmailCustomer" value="true" checked>
                <label class="form-check-label" for="emailCustomer">
                  <i class="fas fa-envelope"></i> Email Shipping Notice to Customer
                </label>
              </div>
            </div>
          </div>

          <!-- Action Summary -->
          <div class="alert alert-info mt-3">
            <h6><i class="fas fa-info-circle"></i> This action will:</h6>
            <ul class="mb-0">
              <li>Mark the sale as <strong>Shipped</strong></li>
              <li>Record shipping information and tracking details</li>
              <li>Reduce inventory levels for physical items</li>
              <li>Set shipped date to current date/time</li>
              <li>Generate packing slip (if selected)</li>
              <li>Send email notification (if selected)</li>
              <li><strong>Cannot be undone</strong></li>
            </ul>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-shipping-fast"></i> Process & Ship Sale
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

@section Scripts {
<script src="~/js/sales-enhanced-validation.js"></script>
<script>
    // Set data attributes for JavaScript
    @if (TempData["ToastMessage"] != null)
    {
        <text>document.body.dataset.toastMessage = @Html.Raw(Json.Serialize(TempData["ToastMessage"].ToString()));</text>
        <text>document.body.dataset.toastType = @Html.Raw(Json.Serialize(TempData["ToastType"]?.ToString() ?? "info"));</text>
    }
    
    @if (TempData["ServiceOrderPrompt"] != null)
    {
        <text>document.body.dataset.serviceOrderPrompt = 'true';</text>
        <text>document.body.dataset.missingServiceOrders = @Html.Raw(TempData["MissingServiceOrders"]?.ToString() ?? "[]");</text>
        <text>document.body.dataset.serviceOrderCreationUrl = @Html.Raw(Json.Serialize(TempData["ServiceOrderCreationUrl"]?.ToString() ?? ""));</text>
    }

    // ✅ NEW: Function to show item details in modal
    function showItemDetails(itemId) {
        const modal = new bootstrap.Modal(document.getElementById('itemDetailsModal'));
        const content = document.getElementById('itemDetailsContent');
        const viewFullLink = document.getElementById('viewFullItemLink');
        
        // Set the full details link
        viewFullLink.href = `/Items/Details/${itemId}`;
        
        // Show loading spinner
        content.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading item details...</p>
            </div>
        `;
        
        // Show the modal
        modal.show();
        
        // Fetch item details
        fetch(`/Items/Details/${itemId}`)
            .then(response => response.text())
            .then(html => {
                // Extract just the main content from the full page
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const mainContent = doc.querySelector('.card-body') || doc.querySelector('main') || doc.body;
                
                if (mainContent) {
                    // Create a simplified read-only view
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-12">
                                ${mainContent.innerHTML}
                            </div>
                        </div>
                    `;
                    
                    // Disable all form elements to make it read-only
                    content.querySelectorAll('input, select, textarea, button').forEach(element => {
                        element.disabled = true;
                        if (element.tagName === 'BUTTON') {
                            element.style.display = 'none';
                        }
                    });
                    
                    // Remove edit links and form actions
                    content.querySelectorAll('a[href*="Edit"], a[href*="Delete"], form').forEach(element => {
                        if (element.tagName === 'A' && (element.href.includes('Edit') || element.href.includes('Delete'))) {
                            element.style.display = 'none';
                        } else if (element.tagName === 'FORM') {
                            element.style.display = 'none';
                        }
                    });
                } else {
                    content.innerHTML = '<p class="text-danger">Error loading item details.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching item details:', error);
                content.innerHTML = '<p class="text-danger">Error loading item details. Please try again.</p>';
            });
    }
    
    // ✅ NEW: Function to show item image in modal
    function showItemImageModal(partNumber, imageUrl) {
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        const modalTitle = document.getElementById('imageModalLabel');
        const modalImage = document.getElementById('modalImage');
        
        modalTitle.textContent = `${partNumber} - Item Image`;
        modalImage.src = imageUrl;
        modalImage.alt = partNumber;
        
        modal.show();
    }
       
    // Auto-populate courier service based on common patterns
    $('#courierService').on('change', function() {
        const courier = $(this).val();
        const trackingInput = $('#trackingNumber');
        
        // Clear tracking number when courier changes
        trackingInput.val('');
        
        // Set placeholders and validation patterns based on courier
        switch(courier) {
            case 'FedEx':
                trackingInput.attr('placeholder', 'e.g., 1234 5678 9012');
                trackingInput.attr('pattern', '[0-9\\s]{12,}');
                break;
            case 'UPS':
                trackingInput.attr('placeholder', 'e.g., 1Z999AA1234567890');
                trackingInput.attr('pattern', '1Z[0-9A-Z]{16}');
                break;
            case 'USPS':
                trackingInput.attr('placeholder', 'e.g., 9400 1234 5678 9012 3456 78');
                trackingInput.attr('pattern', '[0-9\\s]{20,}');
                break;
            case 'Customer Pickup':
            case 'Local Delivery':
                trackingInput.val('N/A');
                trackingInput.attr('readonly', true);
                trackingInput.removeAttr('required');
                break;
            default:
                trackingInput.attr('placeholder', 'Enter tracking number');
                trackingInput.removeAttr('pattern');
                trackingInput.removeAttr('readonly');
                trackingInput.attr('required', true);
                break;
        }
    });

    // Load inventory info when modal opens
    $('#processSaleModal').on('show.bs.modal', function () {
        loadSaleInventoryInfo(@Model.Sale.Id);
    });

    function loadSaleInventoryInfo(saleId) {
        $.get('/Sales/GetSaleInventoryInfo/' + saleId, function(data) {
            if (data.success) {
                if (data.inventoryItemsCount > 0) {
                    $('#inventoryItemCount').text(data.inventoryItemsCount + ' item(s)');
                    
                    var itemsList = $('#inventoryItemsList');
                    itemsList.empty();
                    
                    data.inventoryItems.forEach(function(item) {
                        itemsList.append('<li>' + item.partNumber + ' - ' + item.description + ' (Qty: ' + item.quantity + ', Stock: ' + item.currentStock + ')</li>');
                    });
                    
                    $('#inventoryWarning').show();
                    $('#noInventoryInfo').hide();
                } else {
                    $('#noInventoryInfo').show();
                    $('#inventoryWarning').hide();
                }
            }
        });
    }
    
   

    // Auto-populate customer email if not already filled
    $(document).ready(function() {
        if (!$('#CustomerEmail').val() && '@Model.Sale.Customer?.Email') {
            $('#CustomerEmail').val('@Model.Sale.Customer?.Email');
        }
        
        // Payment amount validation
        $('#paymentAmount').on('change', function() {
            var paymentAmount = parseFloat($(this).val());
            var remainingBalance = @((Model.Sale.Customer?.OutstandingBalance ?? 0));
            
            if (paymentAmount > remainingBalance) {
                alert('Payment amount cannot exceed remaining balance of $' + remainingBalance.toFixed(2));
                $(this).val(remainingBalance.toFixed(2));
            }
        });
    });

</script>
}