@model InventorySystem.ViewModels.UpdatePurchaseStatusViewModel

<div class="modal fade" id="updatePurchaseStatusModal" tabindex="-1" aria-labelledby="updatePurchaseStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updatePurchaseStatusModalLabel">
                    <i class="fas fa-edit"></i> Update Purchase Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <form id="updateStatusForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="PurchaseId" value="@Model.PurchaseId" />
                
                <div class="modal-body">
                    <!-- Purchase Info -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>PO #:</strong> @Model.PurchaseOrderNumber<br>
                                <strong>Item:</strong> @Model.ItemName
                            </div>
                            <div class="col-md-6">
                                <strong>Vendor:</strong> @Model.VendorName<br>
                                <strong>Quantity:</strong> @Model.QuantityPurchased
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong>Current Status:</strong> 
                            <span class="badge bg-@(GetStatusBadgeColor(Model.CurrentStatus))">
                                @InventorySystem.ViewModels.UpdatePurchaseStatusViewModel.GetStatusDisplayName(Model.CurrentStatus)
                            </span>
                        </div>
                    </div>

                    @if (!Model.AvailableStatuses.Any())
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i>
                            No status changes are available for this purchase order.
                        </div>
                    }
                    else
                    {
                        <!-- Status Selection -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="newStatus" class="form-label">
                                        <i class="fas fa-flag"></i> New Status <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="newStatus" name="NewStatus" required onchange="handleStatusChange(this.value)">
                                        <option value="">Select new status...</option>
                                        @foreach (var status in Model.AvailableStatuses)
                                        {
                                            <option value="@status">@InventorySystem.ViewModels.UpdatePurchaseStatusViewModel.GetStatusDisplayName(status)</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="statusNotes" class="form-label">
                                        <i class="fas fa-sticky-note"></i> Notes
                                    </label>
                                    <textarea class="form-control" id="statusNotes" name="Notes" rows="3" 
                                              placeholder="Optional notes about this status change..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Status-specific fields (shown/hidden based on selection) -->
                        
                        <!-- Received Status Fields -->
                        <div id="receivedFields" class="card mt-3" style="display: none;">
                            <div class="card-header">
                                <h6><i class="fas fa-truck"></i> Receipt Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="receivedDate" class="form-label">Received Date</label>
                                            <input type="date" class="form-control" id="receivedDate" name="ReceivedDate" 
                                                   value="@DateTime.Today.ToString("yyyy-MM-dd")">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="alert alert-success">
                                            <i class="fas fa-info-circle"></i>
                                            <strong>This will:</strong>
                                            <ul class="mb-0 mt-1">
                                                <li>Add @Model.QuantityPurchased units to inventory</li>
                                                <li>Create an Accounts Payable record</li>
                                                <li>Generate accounting journal entries</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipped Status Fields -->
                        <div id="shippedFields" class="card mt-3" style="display: none;">
                            <div class="card-header">
                                <h6><i class="fas fa-shipping-fast"></i> Shipping Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="shippedDate" class="form-label">Shipped Date</label>
                                            <input type="date" class="form-control" id="shippedDate" name="ShippedDate" 
                                                   value="@DateTime.Today.ToString("yyyy-MM-dd")">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="estimatedDeliveryDays" class="form-label">Estimated Delivery (days)</label>
                                            <input type="number" class="form-control" id="estimatedDeliveryDays" 
                                                   name="EstimatedDeliveryDays" value="3" min="1" max="30">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cancelled Status Fields -->
                        <div id="cancelledFields" class="card mt-3" style="display: none;">
                            <div class="card-header">
                                <h6><i class="fas fa-times-circle"></i> Cancellation Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="cancelReason" class="form-label">
                                        Reason for Cancellation <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control" id="cancelReason" name="Reason" rows="3" 
                                              placeholder="Please provide a reason for cancelling this purchase order..."></textarea>
                                </div>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Warning:</strong> Cancelling this purchase order cannot be undone.
                                </div>
                            </div>
                        </div>
                    }
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    @if (Model.AvailableStatuses.Any())
                    {
                        <button type="button" class="btn btn-primary" id="updateStatusBtn" onclick="submitStatusUpdate()">
                            <i class="fas fa-save"></i> Update Status
                        </button>
                    }
                </div>
            </form>
        </div>
    </div>
</div>

@functions {
    private string GetStatusBadgeColor(InventorySystem.Models.Enums.PurchaseStatus status)
    {
        return status switch
        {
            InventorySystem.Models.Enums.PurchaseStatus.Pending => "warning",
            InventorySystem.Models.Enums.PurchaseStatus.Ordered => "info",
            InventorySystem.Models.Enums.PurchaseStatus.Shipped => "primary",
            InventorySystem.Models.Enums.PurchaseStatus.PartiallyReceived => "warning",
            InventorySystem.Models.Enums.PurchaseStatus.Received => "success",
            InventorySystem.Models.Enums.PurchaseStatus.Cancelled => "danger",
            InventorySystem.Models.Enums.PurchaseStatus.Returned => "secondary",
            _ => "secondary"
        };
    }
}

<script>
    function handleStatusChange(selectedStatus) {
        console.log('Handling status change to:', selectedStatus);
        
        const receivedFields = document.getElementById('receivedFields');
        const shippedFields = document.getElementById('shippedFields');
        const cancelledFields = document.getElementById('cancelledFields');
        const cancelReason = document.getElementById('cancelReason');
        
        // Hide all status-specific fields
        if (receivedFields) receivedFields.style.display = 'none';
        if (shippedFields) shippedFields.style.display = 'none';
        if (cancelledFields) cancelledFields.style.display = 'none';
        
        // Remove required attribute from cancel reason
        if (cancelReason) {
            cancelReason.removeAttribute('required');
        }

        // Show relevant fields based on selected status
        switch (selectedStatus) {
            case 'Received':
                if (receivedFields) {
                    receivedFields.style.display = 'block';
                    console.log('Showing received fields');
                }
                break;
            case 'Shipped':
                if (shippedFields) {
                    shippedFields.style.display = 'block';
                    console.log('Showing shipped fields');
                }
                break;
            case 'Cancelled':
                if (cancelledFields) {
                    cancelledFields.style.display = 'block';
                    console.log('Showing cancelled fields');
                    // Make reason required for cancellation
                    if (cancelReason) {
                        cancelReason.setAttribute('required', 'required');
                    }
                }
                break;
        }
    }

    function submitStatusUpdate() {
        // This function should be implemented in the parent page that uses this modal
        // It will handle the form submission via AJAX
        if (typeof updatePurchaseStatus === 'function') {
            updatePurchaseStatus();
        } else {
            console.error('updatePurchaseStatus function not found');
        }
    }
</script>

