@model IEnumerable<InventorySystem.Models.Purchase>
@{
    ViewData["Title"] = "Purchases";
    Layout = "~/Views/Shared/_Layout.cshtml";
    
    // Build query string for pagination links
    var queryParams = new List<string>();
    if (!string.IsNullOrEmpty(ViewBag.SearchTerm as string))
        queryParams.Add($"search={Uri.EscapeDataString(ViewBag.SearchTerm)}");
    if (!string.IsNullOrEmpty(ViewBag.VendorFilter as string))
        queryParams.Add($"vendorFilter={ViewBag.VendorFilter}");
    if (!string.IsNullOrEmpty(ViewBag.ItemTypeFilter as string))
        queryParams.Add($"itemTypeFilter={ViewBag.ItemTypeFilter}");
    if (!string.IsNullOrEmpty(ViewBag.StartDate as string))
        queryParams.Add($"startDate={ViewBag.StartDate}");
    if (!string.IsNullOrEmpty(ViewBag.EndDate as string))
        queryParams.Add($"endDate={ViewBag.EndDate}");
    if (!string.IsNullOrEmpty(ViewBag.SortOrder as string))
        queryParams.Add($"sortOrder={ViewBag.SortOrder}");
    
    var queryString = string.Join("&", queryParams);
}

<div class="row mb-3">
    <div class="col">
        <h2>
            <i class="fas fa-shopping-cart me-2"></i>
            Purchase Orders
        </h2>
    </div>
    <div class="col-auto">
        <a asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Create Purchase Order
        </a>
        <a asp-action="CreateMultiLine" class="btn btn-success">
            <i class="fas fa-list me-1"></i>Multi-Line PO
        </a>
        <a asp-action="PendingReceipts" class="btn btn-info">
            <i class="fas fa-truck me-1"></i>Pending Receipts
        </a>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="search" class="form-label">Search</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="@ViewBag.SearchTerm" placeholder="Search purchases...">
            </div>
            <div class="col-md-2">
                <label for="vendorFilter" class="form-label">Vendor</label>
                @Html.DropDownList("vendorFilter", ViewBag.VendorOptions as SelectList, 
                    "All Vendors", new { @class = "form-select" })
            </div>
            <div class="col-md-2">
                <label for="itemTypeFilter" class="form-label">Item Type</label>
                @Html.DropDownList("itemTypeFilter", ViewBag.ItemTypeOptions as SelectList, 
                    "All Types", new { @class = "form-select" })
            </div>
            <div class="col-md-2">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate" name="startDate" 
                       value="@ViewBag.StartDate">
            </div>
            <div class="col-md-2">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDate" name="endDate" 
                       value="@ViewBag.EndDate">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary w-100">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Results Table -->
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">
                    Purchase Orders 
                    <span class="badge bg-secondary">@ViewBag.TotalCount</span>
                </h5>
            </div>
            <div class="col-auto">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-sort me-1"></i>Sort
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="?sortOrder=date_desc&@queryString">Date (Newest)</a></li>
                        <li><a class="dropdown-item" href="?sortOrder=date_asc&@queryString">Date (Oldest)</a></li>
                        <li><a class="dropdown-item" href="?sortOrder=vendor_asc&@queryString">Vendor A-Z</a></li>
                        <li><a class="dropdown-item" href="?sortOrder=amount_desc&@queryString">Amount (High-Low)</a></li>
                        <li><a class="dropdown-item" href="?sortOrder=status_asc&@queryString">Status</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>PO Number</th>
                        <th>Date</th>
                        <th>Vendor</th>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Amount</th>
                        <th>Goods Status</th>
                        <th>Payment Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var purchase in Model)
                    {
                        <tr>
                            <td>
                                <a asp-action="Details" asp-route-id="@purchase.Id" class="fw-bold text-decoration-none">
                                    @purchase.PurchaseOrderNumber
                                </a>
                            </td>
                            <td>@purchase.PurchaseDate.ToString("MM/dd/yyyy")</td>
                            <td>@purchase.Vendor?.CompanyName</td>
                            <td>
                                <div>
                                    <span class="fw-bold">@purchase.Item?.PartNumber</span>
                                    <br>
                                    <small class="text-muted">@purchase.Item?.Description</small>
                                </div>
                            </td>
                            <td class="text-end">@purchase.QuantityPurchased</td>
                            <td class="text-end">@purchase.ExtendedTotal.ToString("C")</td>
                            <td>
                                <span class="badge @GetGoodsStatusBadgeClass(purchase.Status)">
                                    @purchase.Status.ToString().Replace("_", " ")
                                </span>
                            </td>
                            <td>
                                @if (purchase.PaymentStatus.HasValue)
                                {
                                    <span class="badge @GetPaymentStatusBadgeClass(purchase.PaymentStatus.Value)">
                                        @purchase.PaymentStatus.Value.ToString().Replace("_", " ")
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-light text-dark">No A/P</span>
                                }
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a asp-action="Details" asp-route-id="@purchase.Id" 
                                       class="btn btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a asp-action="Edit" asp-route-id="@purchase.Id" 
                                       class="btn btn-outline-secondary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    @if (purchase.Status == PurchaseStatus.Ordered || purchase.Status == PurchaseStatus.Shipped)
                                    {
                                        <button class="btn btn-outline-success" 
                                                onclick="openReceiveModal(@purchase.Id)" title="Receive Goods">
                                            <i class="fas fa-truck"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
@if (ViewBag.TotalPages > 1)
{
    <nav class="mt-3">
        <ul class="pagination justify-content-center">
            @if (ViewBag.HasPreviousPage)
            {
                <li class="page-item">
                    <a class="page-link" href="?page=@(ViewBag.CurrentPage - 1)&pageSize=@ViewBag.PageSize&@queryString">Previous</a>
                </li>
            }
            
            @for (int i = Math.Max(1, ViewBag.CurrentPage - 2); i <= Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2); i++)
            {
                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                    <a class="page-link" href="?page=@i&pageSize=@ViewBag.PageSize&@queryString">@i</a>
                </li>
            }
            
            @if (ViewBag.HasNextPage)
            {
                <li class="page-item">
                    <a class="page-link" href="?page=@(ViewBag.CurrentPage + 1)&pageSize=@ViewBag.PageSize&@queryString">Next</a>
                </li>
            }
        </ul>
    </nav>
}

@functions {
    string GetGoodsStatusBadgeClass(PurchaseStatus status)
    {
        return status switch
        {
            PurchaseStatus.Pending => "bg-secondary",
            PurchaseStatus.Ordered => "bg-primary",
            PurchaseStatus.Shipped => "bg-info",
            PurchaseStatus.Received => "bg-success",
            PurchaseStatus.PartiallyReceived => "bg-warning",
            PurchaseStatus.Cancelled => "bg-danger",
            _ => "bg-light text-dark"
        };
    }
    
    string GetPaymentStatusBadgeClass(PaymentStatus status)
    {
        return status switch
        {
            PaymentStatus.Pending => "bg-warning text-dark",
            PaymentStatus.PartiallyPaid => "bg-info",
            PaymentStatus.Paid => "bg-success",
            PaymentStatus.Overdue => "bg-danger",
            PaymentStatus.Failed => "bg-danger",
            PaymentStatus.Refunded => "bg-secondary",
            _ => "bg-light text-dark"
        };
    }
}

<script>
function openReceiveModal(purchaseId) {
    // Implementation for receiving goods modal
    window.location.href = '@Url.Action("GetReceiveGoodsModal")?id=' + purchaseId;
}
</script>