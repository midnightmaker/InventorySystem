@model InventorySystem.ViewModels.Accounting.FinancialYearCloseViewModel
@{
  ViewData["Title"] = "Close Financial Year";
}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-lock"></i> Close Financial Year</h1>
  <a href="@Url.Action("ManageFinancialPeriods")" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left"></i> Back to Periods
  </a>
</div>

@if (TempData["ErrorMessage"] != null)
{
  <div class="alert alert-danger alert-dismissible fade show">
    <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
}

@if (Model.CurrentPeriod != null && !Model.CurrentPeriod.IsClosed)
{
  <!-- Year-End Closing Summary -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white">
      <h5><i class="fas fa-calendar-alt"></i> Financial Year: @Model.CurrentPeriod.PeriodName</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6>Period Information</h6>
          <ul class="list-unstyled">
            <li><strong>Start Date:</strong> @Model.CurrentPeriod.StartDate.ToString("MMMM dd, yyyy")</li>
            <li><strong>End Date:</strong> @Model.CurrentPeriod.EndDate.ToString("MMMM dd, yyyy")</li>
            <li><strong>Type:</strong> @Model.CurrentPeriod.PeriodType</li>
            <li>
              <strong>Status:</strong>
              <span class="badge bg-success">Open</span>
            </li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6>Financial Summary</h6>
          <ul class="list-unstyled">
            <li><strong>Total Transactions:</strong> @Model.TotalTransactions.ToString("N0")</li>
            <li><strong>Total Debits:</strong> @Model.TotalDebits.ToString("C")</li>
            <li><strong>Total Credits:</strong> @Model.TotalCredits.ToString("C")</li>
            <li>
              <strong>Trial Balance:</strong>
              @if (Model.IsBalanced)
              {
                <span class="badge bg-success">Balanced</span>
              }
              else
              {
                <span class="badge bg-danger">Out of Balance</span>
              }
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Year-End Closing Process Summary -->
  <div class="card mb-4">
    <div class="card-header">
      <h5><i class="fas fa-cog"></i> Year-End Closing Process</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <h6><i class="fas fa-info-circle"></i> What happens during year-end closing:</h6>
        <ol class="mb-0">
          <li><strong>Revenue Account Closing:</strong> All revenue account balances will be transferred to Current Year Earnings (3200)</li>
          <li><strong>Expense Account Closing:</strong> All expense account balances will be transferred to Current Year Earnings (3200)</li>
          <li><strong>Retained Earnings Transfer:</strong> The final Current Year Earnings balance (net income/loss) will be transferred to Retained Earnings (3100)</li>
          <li><strong>Account Reset:</strong> Revenue, expense, and Current Year Earnings accounts will have zero balances for the new period</li>
          <li><strong>Period Lock:</strong> The financial period will be marked as closed and locked from future changes</li>
        </ol>
      </div>

      <!-- Validation Status -->
      <div class="row mt-4">
        <div class="col-md-4">
          <div class="card @(Model.IsBalanced ? "border-success" : "border-danger")">
            <div class="card-body text-center">
              <i class="fas fa-balance-scale fa-2x @(Model.IsBalanced ? "text-success" : "text-danger")"></i>
              <h6 class="mt-2">Trial Balance</h6>
              <span class="badge @(Model.IsBalanced ? "bg-success" : "bg-danger")">
                @(Model.IsBalanced ? "Balanced" : "Out of Balance")
              </span>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card @(Model.AllAccountsReconciled ? "border-success" : "border-warning")">
            <div class="card-body text-center">
              <i class="fas fa-check-double fa-2x @(Model.AllAccountsReconciled ? "text-success" : "text-warning")"></i>
              <h6 class="mt-2">Account Reconciliation</h6>
              @if (Model.AllAccountsReconciled)
              {
                <span class="badge bg-success">All Reconciled</span>
              }
              else
              {
                <span class="badge bg-warning">@Model.UnreconciledAccountCount Unreconciled</span>
              }
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card @(!Model.HasPendingTransactions ? "border-success" : "border-warning")">
            <div class="card-body text-center">
              <i class="fas fa-hourglass-half fa-2x @(!Model.HasPendingTransactions ? "text-success" : "text-warning")"></i>
              <h6 class="mt-2">Pending Items</h6>
              @if (!Model.HasPendingTransactions)
              {
                <span class="badge bg-success">None Pending</span>
              }
              else
              {
                <span class="badge bg-warning">@Model.PendingTransactionCount Pending</span>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Closing Form -->
  @if (Model.IsBalanced)
  {
    <div class="card">
      <div class="card-header bg-warning text-dark">
        <h5><i class="fas fa-exclamation-triangle"></i> Confirm Year-End Closing</h5>
      </div>
      <div class="card-body">
        <form asp-action="CloseFinancialYear" method="post" onsubmit="return confirmClose()">
          <input type="hidden" asp-for="CurrentPeriod.Id" />

          <div class="mb-3">
            <label class="form-label">Closing Notes <span class="text-danger">*</span></label>
            <textarea asp-for="ClosingNotes" class="form-control" rows="4"
                      placeholder="Enter notes about the year-end closing process..." required></textarea>
            <div class="form-text">These notes will be permanently recorded with the closed period.</div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input type="checkbox" asp-for="CreateNextYear" class="form-check-input" id="createNextYear" checked />
              <label class="form-check-label" for="createNextYear">
                Automatically create next financial year
              </label>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input type="checkbox" asp-for="PerformYearEndClosing" class="form-check-input" id="performClosing" checked />
              <label class="form-check-label" for="performClosing">
                <span class="text-danger">*</span> Perform automatic year-end closing entries (transfer Current Year Earnings to Retained Earnings)
              </label>
              <div class="form-text text-muted">
                <i class="fas fa-info-circle"></i> This will create the necessary journal entries to close revenue and expense accounts
              </div>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input type="checkbox" name="confirmBackup" class="form-check-input" id="confirmBackup" required />
              <label class="form-check-label" for="confirmBackup">
                <span class="text-danger">*</span> I confirm that all financial data has been properly backed up
              </label>
            </div>
          </div>

          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Warning:</strong> Closing a financial year is irreversible. Once closed:
            <ul class="mb-0 mt-2">
              <li>No new transactions can be posted to this period</li>
              <li>Account balances for this period will be locked</li>
              <li>Financial reports for this period become final</li>
              <li>Revenue and expense accounts will be closed to Retained Earnings</li>
            </ul>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="button" class="btn btn-secondary" onclick="history.back()">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="btn btn-danger">
              <i class="fas fa-lock"></i> Close Financial Year
            </button>
          </div>
        </form>
      </div>
    </div>
  }
  else
  {
    <!-- Cannot Close - Issues -->
    <div class="card border-danger">
      <div class="card-header bg-danger text-white">
        <h5><i class="fas fa-exclamation-triangle"></i> Cannot Close Financial Year</h5>
      </div>
      <div class="card-body">
        <div class="alert alert-danger">
          <h6>The following issues must be resolved before closing:</h6>
          <ul class="mb-0">
            @if (!Model.IsBalanced)
            {
              <li>Trial balance is not balanced (Difference: @((Model.TotalDebits - Model.TotalCredits).ToString("C")))</li>
            }
            @if (Model.HasPendingTransactions)
            {
              <li>@Model.PendingTransactionCount pending transactions need to be resolved</li>
            }
            @if (!Model.AllAccountsReconciled)
            {
              <li>@Model.UnreconciledAccountCount accounts need to be reconciled</li>
            }
          </ul>
        </div>

        <div class="mt-3">
          <a href="@Url.Action("TrialBalance")" class="btn btn-primary">
            <i class="fas fa-balance-scale"></i> View Trial Balance
          </a>
          <a href="@Url.Action("GeneralLedger")" class="btn btn-outline-primary">
            <i class="fas fa-book"></i> Review General Ledger
          </a>
        </div>
      </div>
    </div>
  }
}
else if (Model.CurrentPeriod?.IsClosed == true)
{
  <!-- Already Closed Notice -->
  <div class="card border-success">
    <div class="card-header bg-success text-white">
      <h5><i class="fas fa-lock"></i> Financial Year Already Closed</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <strong>Period Closed:</strong> This financial year was closed on @Model.CurrentPeriod.ClosedDate?.ToString("MMMM dd, yyyy") by @Model.CurrentPeriod.ClosedBy.
      </div>

      @if (!string.IsNullOrEmpty(Model.CurrentPeriod.ClosingNotes))
      {
        <div class="mb-3">
          <label class="form-label"><strong>Closing Notes:</strong></label>
          <div class="border p-3 bg-light rounded">
            @Model.CurrentPeriod.ClosingNotes
          </div>
        </div>
      }

      <div class="d-grid gap-2 d-md-flex">
        <a href="@Url.Action("BalanceSheet", new { period = "current-fy-end" })" class="btn btn-primary">
          <i class="fas fa-building"></i> View Final Balance Sheet
        </a>
        <a href="@Url.Action("IncomeStatement", new { period = "current-fy" })" class="btn btn-outline-primary">
          <i class="fas fa-chart-line"></i> View Final Income Statement
        </a>
      </div>
    </div>
  </div>
}

<script>
  function confirmClose() {
      return confirm(
          'Are you absolutely sure you want to close this financial year?\n\n' +
          'This action will:\n' +
          '• Close all revenue and expense accounts to Current Year Earnings\n' +
          '• Transfer Current Year Earnings to Retained Earnings\n' +
          '• Lock the period from future changes\n\n' +
          'This action CANNOT be undone!'
      );
  }
</script>