@model InventorySystem.ViewModels.Accounting.FinancialYearCloseViewModel
@{
    ViewData["Title"] = "Close Financial Year";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-lock"></i> Close Financial Year</h1>
        <p class="text-muted mb-0">Complete year-end procedures and close the financial period</p>
    </div>
    <div class="btn-group">
        <a href="@Url.Action("ManageFinancialPeriods")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Financial Periods
        </a>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Financial Year Overview -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header @(Model.CurrentPeriod.IsClosed ? "bg-danger text-white" : "bg-primary text-white")">
                <h5><i class="fas fa-calendar-alt"></i> Financial Year: @Model.CurrentPeriod.PeriodName</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">Period:</dt>
                            <dd class="col-sm-7">@Model.CurrentPeriod.FormattedPeriod</dd>
                            
                            <dt class="col-sm-5">Duration:</dt>
                            <dd class="col-sm-7">@Model.CurrentPeriod.DurationInDays days</dd>
                            
                            <dt class="col-sm-5">Type:</dt>
                            <dd class="col-sm-7">
                                <span class="badge bg-secondary">@Model.CurrentPeriod.PeriodType</span>
                            </dd>
                            
                            <dt class="col-sm-5">Status:</dt>
                            <dd class="col-sm-7">
                                <span class="badge @(Model.CurrentPeriod.IsClosed ? "bg-danger" : "bg-success")">
                                    @(Model.CurrentPeriod.IsClosed ? "Closed" : "Open")
                                </span>
                            </dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-6">Total Transactions:</dt>
                            <dd class="col-sm-6"><strong>@Model.TotalTransactions</strong></dd>
                            
                            <dt class="col-sm-6">Total Debits:</dt>
                            <dd class="col-sm-6"><strong class="text-success">@Model.TotalDebits.ToString("C")</strong></dd>
                            
                            <dt class="col-sm-6">Total Credits:</dt>
                            <dd class="col-sm-6"><strong class="text-danger">@Model.TotalCredits.ToString("C")</strong></dd>
                            
                            <dt class="col-sm-6">Balance Status:</dt>
                            <dd class="col-sm-6">
                                @if (Model.IsBalanced)
                                {
                                    <span class="badge bg-success">
                                        <i class="fas fa-check"></i> Balanced
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">
                                        <i class="fas fa-exclamation-triangle"></i> Out of Balance
                                    </span>
                                }
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Year-End Checklist -->
        @if (!Model.CurrentPeriod.IsClosed)
        {
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-tasks"></i> Year-End Checklist</h5>
                </div>
                <div class="card-body">
                    <div class="year-end-checklist">
                        <!-- Trial Balance Check -->
                        <div class="checklist-item @(Model.IsBalanced ? "completed" : "pending")">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas @(Model.IsBalanced ? "fa-check-circle text-success" : "fa-exclamation-triangle text-warning") me-3"></i>
                                    <div>
                                        <strong>Trial Balance Verification</strong>
                                        <small class="d-block text-muted">Ensure all debits equal credits</small>
                                    </div>
                                </div>
                                <div>
                                    @if (Model.IsBalanced)
                                    {
                                        <span class="badge bg-success">Complete</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">Action Required</span>
                                        <a href="@Url.Action("TrialBalance", new { period = "current-fy-end" })" class="btn btn-sm btn-outline-primary ms-2">
                                            <i class="fas fa-balance-scale"></i> View Trial Balance
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Pending Transactions Check -->
                        <div class="checklist-item @(Model.HasPendingTransactions ? "pending" : "completed")">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas @(Model.HasPendingTransactions ? "fa-exclamation-triangle text-warning" : "fa-check-circle text-success") me-3"></i>
                                    <div>
                                        <strong>Pending Transactions Review</strong>
                                        <small class="d-block text-muted">Review and finalize all pending transactions</small>
                                    </div>
                                </div>
                                <div>
                                    @if (Model.HasPendingTransactions)
                                    {
                                        <span class="badge bg-warning">@Model.PendingTransactionCount Pending</span>
                                        <a href="@Url.Action("GeneralLedger", new { period = "current-fy" })" class="btn btn-sm btn-outline-primary ms-2">
                                            <i class="fas fa-list"></i> Review
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Complete</span>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Account Reconciliation -->
                        <div class="checklist-item @(Model.AllAccountsReconciled ? "completed" : "pending")">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas @(Model.AllAccountsReconciled ? "fa-check-circle text-success" : "fa-clock text-warning") me-3"></i>
                                    <div>
                                        <strong>Account Reconciliation</strong>
                                        <small class="d-block text-muted">Ensure all accounts are reconciled</small>
                                    </div>
                                </div>
                                <div>
                                    @if (Model.AllAccountsReconciled)
                                    {
                                        <span class="badge bg-success">Complete</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">@Model.UnreconciledAccountCount Accounts</span>
                                        <a href="@Url.Action("ChartOfAccounts")" class="btn btn-sm btn-outline-primary ms-2">
                                            <i class="fas fa-list"></i> View Accounts
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Financial Reports Generation -->
                        <div class="checklist-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-alt text-info me-3"></i>
                                    <div>
                                        <strong>Year-End Financial Reports</strong>
                                        <small class="d-block text-muted">Generate and review annual financial statements</small>
                                    </div>
                                </div>
                                <div class="btn-group">
                                    <a href="@Url.Action("IncomeStatement", new { period = "current-fy" })" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-chart-line"></i> Income Statement
                                    </a>
                                    <a href="@Url.Action("BalanceSheet", new { period = "current-fy-end" })" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-building"></i> Balance Sheet
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Backup Verification -->
                        <div class="checklist-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-database text-secondary me-3"></i>
                                    <div>
                                        <strong>Data Backup</strong>
                                        <small class="d-block text-muted">Ensure financial data is properly backed up</small>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="confirmBackup()">
                                        <i class="fas fa-check"></i> Confirm Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Close Financial Year Form -->
            <div class="card mt-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5><i class="fas fa-lock"></i> Close Financial Year</h5>
                </div>
                <div class="card-body">
                    @if (!Model.CanClose)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Cannot Close Financial Year</strong>
                            <p class="mb-0">Please complete all required year-end procedures before closing:</p>
                            <ul class="mb-0 mt-2">
                                @if (!Model.IsBalanced)
                                {
                                    <li>Resolve trial balance discrepancies</li>
                                }
                                @if (Model.HasPendingTransactions)
                                {
                                    <li>Review and finalize pending transactions</li>
                                }
                            </ul>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Ready to Close</strong>
                            <p class="mb-0">All year-end procedures are complete. You can now close this financial year.</p>
                        </div>

                        <form asp-action="CloseFinancialYear" method="post" id="closeYearForm">
                            <input type="hidden" name="periodId" value="@Model.CurrentPeriod.Id" />
                            
                            <div class="mb-3">
                                <label class="form-label">Closing Notes <span class="text-danger">*</span></label>
                                <textarea name="closingNotes" class="form-control" rows="3" 
                                         placeholder="Enter any notes about the year-end closing process..." required></textarea>
                                <div class="form-text">These notes will be permanently recorded with the closed period.</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" name="createNextYear" class="form-check-input" id="createNextYear" checked />
                                    <label class="form-check-label" for="createNextYear">
                                        Automatically create next financial year
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" name="confirmBackup" class="form-check-input" id="confirmBackup" required />
                                    <label class="form-check-label" for="confirmBackup">
                                        <span class="text-danger">*</span> I confirm that all financial data has been properly backed up
                                    </label>
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Warning:</strong> Closing a financial year is irreversible. Once closed:
                                <ul class="mb-0 mt-2">
                                    <li>No new transactions can be posted to this period</li>
                                    <li>Account balances for this period will be locked</li>
                                    <li>Financial reports for this period become final</li>
                                </ul>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary" onclick="history.back()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="submit" class="btn btn-danger" onclick="return confirmClose()">
                                    <i class="fas fa-lock"></i> Close Financial Year
                                </button>
                            </div>
                        </form>
                    }
                </div>
            </div>
        }
        else
        {
            <!-- Already Closed Notice -->
            <div class="card mt-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5><i class="fas fa-lock"></i> Financial Year Closed</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Period Closed:</strong> This financial year was closed on @Model.CurrentPeriod.ClosedDate?.ToString("MMMM dd, yyyy") by @Model.CurrentPeriod.ClosedBy.
                    </div>
                    
                    @if (!string.IsNullOrEmpty(Model.CurrentPeriod.ClosingNotes))
                    {
                        <div class="mb-3">
                            <label class="form-label"><strong>Closing Notes:</strong></label>
                            <div class="border p-3 bg-light rounded">
                                @Model.CurrentPeriod.ClosingNotes
                            </div>
                        </div>
                    }

                    <div class="d-grid gap-2 d-md-flex">
                        <a href="@Url.Action("IncomeStatement", new { period = "custom", startDate = Model.CurrentPeriod.StartDate.ToString("yyyy-MM-dd"), endDate = Model.CurrentPeriod.EndDate.ToString("yyyy-MM-dd") })" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-chart-line"></i> View Final Income Statement
                        </a>
                        <a href="@Url.Action("BalanceSheet", new { asOfDate = Model.CurrentPeriod.EndDate.ToString("yyyy-MM-dd") })" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-building"></i> View Final Balance Sheet
                        </a>
                        <a href="@Url.Action("TrialBalance", new { asOfDate = Model.CurrentPeriod.EndDate.ToString("yyyy-MM-dd") })" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-balance-scale"></i> View Final Trial Balance
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Quick Actions Sidebar -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-lightning-bolt"></i> Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="@Url.Action("TrialBalance", new { period = "current-fy-end" })" class="btn btn-outline-primary">
                        <i class="fas fa-balance-scale"></i> Trial Balance
                    </a>
                    <a href="@Url.Action("IncomeStatement", new { period = "current-fy" })" class="btn btn-outline-success">
                        <i class="fas fa-chart-line"></i> Income Statement
                    </a>
                    <a href="@Url.Action("BalanceSheet", new { period = "current-fy-end" })" class="btn btn-outline-info">
                        <i class="fas fa-building"></i> Balance Sheet
                    </a>
                    <a href="@Url.Action("GeneralLedger", new { period = "current-fy" })" class="btn btn-outline-secondary">
                        <i class="fas fa-book"></i> General Ledger
                    </a>
                </div>
            </div>
        </div>

        <!-- Next Financial Year Preview -->
        @if (!Model.CurrentPeriod.IsClosed && Model.NextFinancialYear != null)
        {
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h6><i class="fas fa-forward"></i> Next Financial Year</h6>
                </div>
                <div class="card-body">
                    <h6>@Model.NextFinancialYear.PeriodName</h6>
                    <p class="text-muted small">@Model.NextFinancialYear.FormattedPeriod</p>
                    
                    @if (!Model.NextFinancialYear.IsCurrentPeriod)
                    {
                        <form asp-action="SetCurrentPeriod" method="post" class="d-inline">
                            <input type="hidden" name="periodId" value="@Model.NextFinancialYear.Id" />
                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-play"></i> Activate Next Year
                            </button>
                        </form>
                    }
                </div>
            </div>
        }
    </div>
</div>

<script>
function confirmClose() {
    return confirm(`Are you absolutely sure you want to close the financial year "${@Model.CurrentPeriod.PeriodName}"?\n\nThis action cannot be undone and will:\n- Lock all transactions for this period\n- Finalize all account balances\n- Make financial reports permanent\n\nClick OK to proceed or Cancel to abort.`);
}

function confirmBackup() {
    if (confirm('Have you verified that all financial data has been properly backed up?')) {
        document.getElementById('confirmBackup').checked = true;
        alert('Backup confirmation recorded. You can now proceed with closing the financial year.');
    }
}
</script>

<style>
.checklist-item {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.checklist-item:last-child {
    border-bottom: none;
}

.checklist-item.completed {
    background-color: #f8f9fa;
}

.checklist-item.pending {
    background-color: #fff3cd;
}
</style>