@model InventorySystem.Models.Bom
@using System.IO
@{
  ViewData["Title"] = "BOM Details";
  var totalCost = ViewBag.TotalCost as decimal? ?? 0;
}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="d-flex align-items-center">
    <h1 class="me-3"><i class="fas fa-layer-group"></i> @Model.BomNumber</h1>
    <!-- Version Dropdown -->
    @if (ViewBag.BomVersions != null)
    {
      @await Html.PartialAsync("_VersionDropdown", ViewBag.BomVersions, new ViewDataDictionary(ViewData)
      {
        ["CurrentVersion"] = Model.Version,
        ["EntityType"] = "Boms",
        ["EntityId"] = Model.BaseBomId ?? Model.Id
      })
    }
  </div>
  <div class="btn-group">
    @if (Model.IsCurrentVersion)
    {
      <a href="/Boms/Edit/@Model.Id" class="btn btn-outline-primary">
        <i class="fas fa-edit"></i> Edit
      </a>
    }
    <a href="/Boms/Visualize/@Model.Id" class="btn btn-outline-success">
      <i class="fas fa-sitemap"></i> View Diagram
    </a>
    <div class="btn-group">
      <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-dollar-sign"></i> Cost Report
      </button>
      <ul class="dropdown-menu">
        <li>
          <a class="dropdown-item" href="/Boms/CostReport/@Model.Id">
            <i class="fas fa-compress-arrows-alt me-2"></i>Standard Report
          </a>
        </li>
        <li>
          <a class="dropdown-item" href="/Boms/CostReport/@Model.Id?explodeSubAssemblies=true">
            <i class="fas fa-expand-arrows-alt me-2"></i>Exploded Report
          </a>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <a class="dropdown-item text-muted" href="#" onclick="event.preventDefault()">
            <small>Standard: Summary view<br>Exploded: All sub-assembly details</small>
          </a>
        </li>
      </ul>
    </div>
    <!-- Create New Version Button -->
    <button type="button" class="btn btn-outline-warning" onclick="showCreateVersionModal('BOM', @(Model.BaseBomId ?? Model.Id))">
      <i class="fas fa-code-branch"></i> New Version
    </button>
    @if (Model.IsCurrentVersion)
    {
      <a href="/Boms/Delete/@Model.Id" class="btn btn-outline-danger" title="Delete this BOM">
        <i class="fas fa-trash-alt"></i> Delete
      </a>
    }
  </div>
</div>

<!-- Include pending change orders alert if any exist -->
@if (ViewBag.PendingChangeOrders != null)
{
  @await Html.PartialAsync("_PendingChangeOrdersAlert", (IEnumerable<InventorySystem.Models.ChangeOrder>)ViewBag.PendingChangeOrders)
}

@if (TempData["SuccessMessage"] != null)
{
  <div class="alert alert-success alert-dismissible fade show">
    @TempData["SuccessMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
}

@if (TempData["ErrorMessage"] != null)
{
  <div class="alert alert-danger alert-dismissible fade show">
    @TempData["ErrorMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
}

<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="fas fa-info-circle"></i> BOM Details</h5>
        <!-- Version Status Badge -->
        @if (Model.IsCurrentVersion)
        {
          <span class="badge bg-success">Current Version</span>
        }
        else
        {
          <span class="badge bg-secondary">Historical Version</span>
        }
      </div>
      <div class="card-body">
        <dl class="row">
          <dt class="col-sm-3">Description:</dt>
          <dd class="col-sm-9">@Model.Description</dd>

          <!-- Version Information -->
          <dt class="col-sm-3">Version:</dt>
          <dd class="col-sm-9">
            <strong>@Model.Version</strong>
            @if (!Model.IsCurrentVersion)
            {
              <small class="text-muted">(Historical)</small>
            }
          </dd>

          @if (Model.CreatedFromChangeOrder != null)
          {
            <dt class="col-sm-3">Change Order:</dt>
            <dd class="col-sm-9">
              <a href="/ChangeOrders/Details/@Model.CreatedFromChangeOrderId" class="text-decoration-none">
                @Model.CreatedFromChangeOrder.ChangeOrderNumber
              </a>
            </dd>
          }

          @if (!string.IsNullOrEmpty(Model.AssemblyPartNumber))
          {
            <dt class="col-sm-3">Assembly P/N:</dt>
            <dd class="col-sm-9">@Model.AssemblyPartNumber</dd>
          }

          <dt class="col-sm-3">Components:</dt>
          <dd class="col-sm-9">
            <span class="badge bg-info">@(Model.BomItems?.Count ?? 0)</span>
          </dd>

          <dt class="col-sm-3">Sub-Assemblies:</dt>
          <dd class="col-sm-9">
            <span class="badge bg-secondary">@(Model.SubAssemblies?.Count ?? 0)</span>
          </dd>

          <dt class="col-sm-3">Total Cost:</dt>
          <dd class="col-sm-9">
            <strong class="text-success">@totalCost.ToString("C")</strong>
          </dd>

          <dt class="col-sm-3">Created:</dt>
          <dd class="col-sm-9">@Model.CreatedDate.ToString("MM/dd/yyyy")</dd>

          <dt class="col-sm-3">Last Modified:</dt>
          <dd class="col-sm-9">@Model.ModifiedDate.ToString("MM/dd/yyyy hh:mm tt")</dd>

          @if (Model.ParentBom != null)
          {
            <dt class="col-sm-3">Parent BOM:</dt>
            <dd class="col-sm-9">
              <a href="/Boms/Details/@Model.ParentBomId" class="text-decoration-none">
                @Model.ParentBom.BomNumber
              </a>
            </dd>
          }
        </dl>
      </div>
    </div>

    <!-- BOM Documents Section -->
    @if (Model.HasDocuments && Model.Documents?.Any() == true)
    {
      <div class="card mt-4">
        <div class="card-header">
          <h5><i class="fas fa-file-alt"></i> BOM Documents (@Model.Documents.Count)</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Document Name</th>
                  <th>Type</th>
                  <th>Size</th>
                  <th>Uploaded</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @foreach (var doc in Model.Documents.OrderBy(d => d.DocumentType).ThenBy(d => d.DocumentName))
                {
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <i class="@doc.FileTypeIcon me-2"></i>
                        <div>
                          <strong>@doc.DocumentName</strong>
                          @if (!string.IsNullOrEmpty(doc.Description))
                          {
                            <br>
                            <small class="text-muted">@doc.Description</small>
                          }
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="badge bg-secondary">@doc.DocumentType</span>
                    </td>
                    <td>@doc.FileSizeFormatted</td>
                    <td>
                      <small>@doc.UploadedDate.ToString("MM/dd/yyyy")</small>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        @{
                          var canPreview = new[] { ".pdf", ".png", ".jpg", ".jpeg", ".gif", ".bmp", ".tiff" }
                          .Contains(System.IO.Path.GetExtension(doc.FileName).ToLowerInvariant());
                        }

                        @if (canPreview)
                        {
                          <button class="btn btn-outline-info" onclick="previewDocument(@doc.Id, '@doc.DocumentName')" title="Preview">
                            <i class="fas fa-eye"></i>
                          </button>
                        }

                        <a href="/Documents/Download/@doc.Id" class="btn btn-outline-primary" title="Download">
                          <i class="fas fa-download"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    }
    else
    {
      <div class="card mt-4">
        <div class="card-header">
          <h6><i class="fas fa-file-alt"></i> BOM Documents</h6>
        </div>
        <div class="card-body text-center">
          <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
          <h6 class="text-muted">No Documents Uploaded</h6>
          <p class="text-muted">
            @if (Model.IsCurrentVersion)
            {
              <span>No documents have been uploaded for this BOM.</span>
            }
            else
            {
              <span>No documents were uploaded for Version @Model.Version</span>
            }
          </p>
        </div>
      </div>
    }

    <!-- Components Section -->
    @if (Model.BomItems?.Any() == true)
    {
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-cogs"></i> Components (@Model.BomItems.Count)</h5>
          <div>
            <small class="text-muted me-2">For Version @Model.Version</small>
            @if (Model.IsCurrentVersion)
            {
              <a href="/Boms/AddItem?bomId=@Model.Id" class="btn btn-sm btn-outline-success me-1">
                <i class="fas fa-plus"></i> Add Component
              </a>
            }
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#componentsTable" aria-expanded="true" aria-controls="componentsTable">
              <i class="fas fa-chevron-down"></i> Toggle
            </button>
          </div>
        </div>
        <div class="collapse show" id="componentsTable">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-hover" id="componentsGrid">
                <thead class="table-dark">
                  <tr>
                    <th class="sortable-col" data-col="0" style="cursor:pointer; user-select:none; white-space:nowrap;">
                      Part Number <i class="fas fa-sort sort-icon ms-1 opacity-50"></i>
                    </th>
                    <th class="sortable-col" data-col="1" style="cursor:pointer; user-select:none; white-space:nowrap;">
                      Description <i class="fas fa-sort sort-icon ms-1 opacity-50"></i>
                    </th>
                    <th class="sortable-col" data-col="2" style="cursor:pointer; user-select:none; white-space:nowrap;">
                      Quantity <i class="fas fa-sort sort-icon ms-1 opacity-50"></i>
                    </th>
                    <th class="sortable-col" data-col="3" style="cursor:pointer; user-select:none; white-space:nowrap;">
                      Unit Cost <i class="fas fa-sort sort-icon ms-1 opacity-50"></i>
                    </th>
                    <th class="sortable-col" data-col="4" style="cursor:pointer; user-select:none; white-space:nowrap;">
                      Extended Cost <i class="fas fa-sort sort-icon ms-1 opacity-50"></i>
                    </th>
                    <th class="sortable-col" data-col="5" style="cursor:pointer; user-select:none; white-space:nowrap;">
                      Reference <i class="fas fa-sort sort-icon ms-1 opacity-50"></i>
                    </th>
                    @if (Model.IsCurrentVersion)
                    {
                      <th style="width:80px;">Actions</th>
                    }
                  </tr>
                </thead>
                <tbody>
                  @foreach (var bomItem in Model.BomItems.OrderBy(bi => bi.Item.PartNumber))
                  {
                    <tr>
                      <td>
                        <a href="/Items/Details/@bomItem.Item.Id" class="text-decoration-none">
                          @bomItem.Item.PartNumber
                        </a>
                      </td>
                      <td>@bomItem.Item.Description</td>
                      <td data-sort="@bomItem.Quantity">@bomItem.Quantity</td>
                      <td data-sort="@bomItem.UnitCost">@bomItem.UnitCost.ToString("C")</td>
                      <td data-sort="@bomItem.ExtendedCost">@bomItem.ExtendedCost.ToString("C")</td>
                      <td>@bomItem.ReferenceDesignator</td>
                      @if (Model.IsCurrentVersion)
                      {
                        <td>
                          <form method="post" action="/Boms/RemoveItem"
                                onsubmit="return confirm('Remove @bomItem.Item.PartNumber from this BOM?');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="bomItemId" value="@bomItem.Id" />
                            <input type="hidden" name="bomId" value="@Model.Id" />
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove from BOM">
                              <i class="fas fa-times"></i>
                            </button>
                          </form>
                        </td>
                      }
                    </tr>
                  }
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th colspan="@(Model.IsCurrentVersion ? 4 : 4)">Total Direct Component Cost:</th>
                    <th>
                      <strong class="text-success">@(Model.BomItems.Sum(bi => bi.ExtendedCost).ToString("C"))</strong>
                    </th>
                    <th></th>
                    @if (Model.IsCurrentVersion)
                    {
                      <th></th>
                    }
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    }
    else
    {
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6><i class="fas fa-cogs"></i> Components</h6>
          <div>
            @if (Model.IsCurrentVersion)
            {
              <a href="/Boms/AddItem?bomId=@Model.Id" class="btn btn-sm btn-outline-success me-1">
                <i class="fas fa-plus"></i> Add Component
              </a>
            }
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#componentsEmpty" aria-expanded="true" aria-controls="componentsEmpty">
              <i class="fas fa-chevron-down"></i> Toggle
            </button>
          </div>
        </div>
        <div class="collapse show" id="componentsEmpty">
          <div class="card-body text-center">
            <i class="fas fa-cogs fa-3x text-muted mb-2"></i>
            <p class="text-muted mb-3">
              @if (Model.IsCurrentVersion)
              {
                <span>No components have been added to this BOM.</span>
              }
              else
              {
                <span>No components were added to Version @Model.Version</span>
              }
            </p>
            @if (Model.IsCurrentVersion)
            {
              <a href="/Boms/AddItem?bomId=@Model.Id" class="btn btn-outline-success">
                <i class="fas fa-plus"></i> Add First Component
              </a>
            }
          </div>
        </div>
      </div>
    }

    <!-- Sub-Assemblies Section -->
    @if (Model.SubAssemblies?.Any() == true)
    {
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-layer-group"></i> Sub-Assemblies (@Model.SubAssemblies.Count)</h5>
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#subAssembliesTable" aria-expanded="true" aria-controls="subAssembliesTable">
            <i class="fas fa-chevron-down"></i> Toggle
          </button>
        </div>
        <div class="collapse show" id="subAssembliesTable">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead class="table-dark">
                  <tr>
                    <th>Sub-Assembly Name</th>
                    <th>Assembly P/N</th>
                    <th>Version</th>
                    <th>Components</th>
                    <th>Sub-Assembly Cost</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @{
                    var subAssemblyCosts = ViewBag.SubAssemblyCosts as Dictionary<int, decimal> ?? new Dictionary<int, decimal>();
                    decimal totalSubAssemblyCost = 0;
                  }
                  @foreach (var subAssembly in Model.SubAssemblies)
                  {
                    var cost = subAssemblyCosts.ContainsKey(subAssembly.Id) ? subAssemblyCosts[subAssembly.Id] : 0;
                    totalSubAssemblyCost += cost;
                    <tr>
                      <td>
                        <a href="/Boms/Details/@subAssembly.Id" class="text-decoration-none">
                          <strong>@subAssembly.BomNumber</strong>
                        </a>
                        <br>
                        <small class="text-muted">@subAssembly.Description</small>
                      </td>
                      <td>@subAssembly.AssemblyPartNumber</td>
                      <td>
                        <span class="badge bg-info">@subAssembly.Version</span>
                      </td>
                      <td>
                        <span class="badge bg-secondary">@subAssembly.BomItems.Count</span>
                        <small class="text-muted">components</small>
                      </td>
                      <td>
                        <strong class="text-success">@cost.ToString("C")</strong>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a href="/Boms/Details/@subAssembly.Id" class="btn btn-outline-primary" title="View Details">
                            <i class="fas fa-eye"></i>
                          </a>
                          <a href="/Boms/CostReport/@subAssembly.Id" class="btn btn-outline-success" title="Cost Report">
                            <i class="fas fa-dollar-sign"></i>
                          </a>
                          <a href="/Boms/Visualize/@subAssembly.Id" class="btn btn-outline-info" title="Visualize">
                            <i class="fas fa-sitemap"></i>
                          </a>
                          <a href="/Boms/DetachSubAssembly?subAssemblyId=@subAssembly.Id&parentBomId=@Model.Id"
                             class="btn btn-outline-warning"
                             title="Remove from this BOM (keeps the sub-assembly BOM)">
                            <i class="fas fa-unlink"></i>
                          </a>
                          <a href="/Boms/Delete/@subAssembly.Id"
                             class="btn btn-outline-danger"
                             title="Permanently delete sub-assembly BOM">
                            <i class="fas fa-trash-alt"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th colspan="4">Total Sub-Assembly Cost:</th>
                    <th><strong class="text-success">@totalSubAssemblyCost.ToString("C")</strong></th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <!-- Cost Summary -->
            <div class="row mt-3">
              @{
                var directComponentsCost = Model.BomItems?.Sum(bi => bi.ExtendedCost) ?? 0;
              }
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body text-center py-2">
                    <h6 class="card-title text-primary mb-1">Direct Components</h6>
                    <h5 class="text-primary mb-0">@directComponentsCost.ToString("C")</h5>
                    <small class="text-muted">@(Model.BomItems?.Count ?? 0) items</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body text-center py-2">
                    <h6 class="card-title text-info mb-1">Sub-Assemblies</h6>
                    <h5 class="text-info mb-0">@totalSubAssemblyCost.ToString("C")</h5>
                    <small class="text-muted">@Model.SubAssemblies.Count assemblies</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-success text-white">
                  <div class="card-body text-center py-2">
                    <h6 class="card-title mb-1">Total BOM Cost</h6>
                    <h5 class="mb-0">@((directComponentsCost + totalSubAssemblyCost).ToString("C"))</h5>
                    <small>Complete assembly</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    }
    else
    {
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6><i class="fas fa-layer-group"></i> Sub-Assemblies</h6>
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#subAssembliesEmpty" aria-expanded="true" aria-controls="subAssembliesEmpty">
            <i class="fas fa-chevron-down"></i> Toggle
          </button>
        </div>
        <div class="collapse show" id="subAssembliesEmpty">
          <div class="card-body text-center">
            <p class="text-muted mb-3">No sub-assemblies have been added to this BOM.</p>
          </div>
        </div>
      </div>
    }
  </div>

  <div class="col-md-4">
    @if (Model.HasImage)
    {
      <div class="card mb-3">
        <div class="card-header">
          <h6><i class="fas fa-image"></i> BOM Thumbnail</h6>
        </div>
        <div class="card-body text-center p-2">
          <img src="/Boms/GetImage/@Model.Id"
               alt="@Model.BomNumber thumbnail"
               style="max-width:100%; max-height:260px; object-fit:contain; border-radius:4px;" />
        </div>
      </div>
    }

    <!-- Quick Material Check Section -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6><i class="fas fa-exclamation-triangle text-warning"></i> Material Check</h6>
        <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#materialCheck" aria-expanded="false">
          <i class="fas fa-eye"></i> Check
        </button>
      </div>
      <div class="collapse" id="materialCheck">
        <div class="card-body">
          <p class="text-muted small">Check if sufficient materials are available for this BOM:</p>
          @if (Model.BomItems?.Any() == true)
          {
            <div class="list-group list-group-flush">
              @foreach (var bomItem in Model.BomItems.Take(5))
              {
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                  <small>
                    <strong>@bomItem.Item.PartNumber</strong><br>
                    Need: @bomItem.Quantity
                  </small>
                  <span class="badge bg-@(bomItem.Item.CurrentStock >= bomItem.Quantity ? "success" : "danger")">
                    @bomItem.Item.CurrentStock
                  </span>
                </div>
              }
              @if (Model.BomItems.Count > 5)
              {
                <div class="list-group-item text-center">
                  <small class="text-muted">... and @(Model.BomItems.Count - 5) more items</small>
                </div>
              }
            </div>
          }
          else
          {
            <p class="text-muted text-center">No components to check</p>
          }
        </div>
      </div>
    </div>

    <!-- BOM Statistics -->
    <div class="card mt-3">
      <div class="card-header">
        <h6><i class="fas fa-chart-bar"></i> BOM Statistics</h6>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-6">
            <div class="border-end">
              <h5 class="text-primary">@(Model.BomItems?.Count ?? 0)</h5>
              <small class="text-muted">Components</small>
            </div>
          </div>
          <div class="col-6">
            <h5 class="text-info">@(Model.SubAssemblies?.Count ?? 0)</h5>
            <small class="text-muted">Sub-Assemblies</small>
          </div>
        </div>
        <hr>
        <div class="row text-center">
          <div class="col-12">
            <h6 class="text-success">@totalCost.ToString("C")</h6>
            <small class="text-muted">Total Material Cost</small>
          </div>
        </div>
        @if (Model.BomItems?.Any() == true)
        {
          <hr>
          <div class="row text-center">
            <div class="col-12">
              <small class="text-muted">
                Avg Cost per Component:
                <strong>@((totalCost / Model.BomItems.Count).ToString("C"))</strong>
              </small>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Version History Card -->
    @if (ViewBag.BomVersions != null && ((IEnumerable<dynamic>)ViewBag.BomVersions).Count() > 1)
    {
      <div class="card mt-3">
        <div class="card-header">
          <h6><i class="fas fa-history"></i> Version History</h6>
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            @foreach (var version in (IEnumerable<dynamic>)ViewBag.BomVersions)
            {
              <div class="list-group-item d-flex justify-content-between align-items-center @(version.Version == Model.Version ? "active" : "")">
                <div>
                  <strong>@version.Version</strong>
                  @if (version.IsCurrentVersion)
                  {
                    <span class="badge bg-success ms-2">Current</span>
                  }
                  <br>
                  <small class="text-muted">@version.CreatedDate.ToString("MM/dd/yyyy")</small>
                </div>
                @if (version.Version != Model.Version)
                {
                  <a href="/Boms/Details/@version.Id" class="btn btn-sm btn-outline-primary">View</a>
                }
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>
</div>

<div class="mt-3">
  <a href="/Boms" class="btn btn-secondary">Back to BOMs</a>
</div>

@* Document Preview Modal *@
<div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalTitle">Document Preview</h5>
        <div class="btn-group btn-group-sm">
          <button type="button" class="btn btn-outline-secondary" onclick="zoomOut()">
            <i class="fas fa-search-minus"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" onclick="resetZoom()">
            <i class="fas fa-compress-arrows-alt"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" onclick="zoomIn()">
            <i class="fas fa-search-plus"></i>
          </button>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div id="previewLoading" class="text-center p-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading document...</p>
        </div>
        <iframe id="previewIframe" style="width: 100%; height: 70vh; border: none; display: none;"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a id="downloadLink" href="#" class="btn btn-primary">
          <i class="fas fa-download"></i> Download
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Pending Change Orders Modal -->
<div class="modal fade" id="pendingChangeOrdersModal" tabindex="-1" aria-labelledby="pendingChangeOrdersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="pendingChangeOrdersModalLabel">
          <i class="fas fa-exclamation-triangle"></i> Cannot Create Change Order
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning" role="alert">
          <p class="mb-3" id="pendingModalMessage">
            <!-- Message will be populated by JavaScript -->
          </p>
        </div>

        <h6><i class="fas fa-list"></i> Pending Change Orders:</h6>
        <div id="pendingChangeOrdersList">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Close
        </button>
        <button type="button" class="btn btn-primary" onclick="refreshPage()">
          <i class="fas fa-refresh"></i> Refresh Page
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentZoom = 1;

  function previewDocument(documentId, documentName) {
    const modal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
    const iframe = document.getElementById('previewIframe');
    const loading = document.getElementById('previewLoading');

    document.getElementById('previewModalTitle').textContent = `Preview: ${documentName}`;
    document.getElementById('downloadLink').href = `/Documents/Download/${documentId}`;
    loading.style.display = 'block';
    iframe.style.display = 'none';
    iframe.src = `/Documents/View/${documentId}`;
    modal.show();

    iframe.onload = function () { loading.style.display = 'none'; iframe.style.display = 'block'; };
    iframe.onerror = function () {
      loading.innerHTML = `<div class="text-center p-4">
        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
        <h5>Preview Not Available</h5>
        <a href="/Documents/Download/${documentId}" class="btn btn-primary"><i class="fas fa-download"></i> Download Document</a>
      </div>`;
    };
  }

  function zoomIn() { currentZoom += 0.25; applyZoom(); }
  function zoomOut() { if (currentZoom > 0.5) { currentZoom -= 0.25; applyZoom(); } }
  function resetZoom() { currentZoom = 1; applyZoom(); }
  function applyZoom() {
    const iframe = document.getElementById('previewIframe');
    iframe.style.transform = `scale(${currentZoom})`;
    iframe.style.transformOrigin = 'top left';
  }

  document.getElementById('documentPreviewModal').addEventListener('hidden.bs.modal', function () {
    currentZoom = 1; applyZoom();
    document.getElementById('previewIframe').src = '';
  });

  function showCreateVersionModal(entityType, entityId) {
    const button = event?.target;
    if (button) { button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...'; }

    fetch(`/ChangeOrders/CreateModal/${entityType}/${entityId}`, {
      method: 'GET',
      headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'text/html,application/json' }
    })
    .then(response => {
      if (!response.ok) return response.text().then(t => { throw new Error(`HTTP ${response.status}: ${response.statusText}`); });
      const ct = response.headers.get('content-type');
      return ct?.includes('application/json') ? response.json() : response.text();
    })
    .then(result => {
      if (typeof result === 'string') {
        const existing = document.getElementById('changeOrderModal');
        if (existing) existing.remove();
        document.body.insertAdjacentHTML('beforeend', result);
        new bootstrap.Modal(document.getElementById('changeOrderModal')).show();
      } else if (result.success === false) {
        result.pendingChangeOrders ? showPendingChangeOrdersModal(result) : alert(`Error: ${result.message || result.error}`);
      }
    })
    .catch(error => alert(`Error loading change order form: ${error.message}`))
    .finally(() => {
      if (button) { button.disabled = false; button.innerHTML = '<i class="fas fa-code-branch"></i> New Version'; }
    });
  }

  function showPendingChangeOrdersModal(errorData) {
    const msg = document.getElementById('pendingModalMessage');
    if (msg) msg.textContent = errorData.message;

    const list = document.getElementById('pendingChangeOrdersList');
    if (list) {
      list.innerHTML = errorData.pendingChangeOrders?.length
        ? errorData.pendingChangeOrders.map(co => `
            <div class="card mb-2"><div class="card-body py-2">
              <div class="d-flex justify-content-between align-items-center">
                <div><strong>${co.changeOrderNumber}</strong><span class="badge bg-warning ms-2">Version ${co.newVersion}</span></div>
                <div class="text-end"><small class="text-muted">Created: ${co.createdDate}</small><br><small class="text-muted">By: ${co.createdBy}</small></div>
              </div>
              <div class="mt-2"><a href="/ChangeOrders/Details/${co.id}" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i> View Details</a></div>
            </div></div>`).join('')
        : '<p class="text-muted">No pending change orders found.</p>';
    }

    const modal = document.getElementById('pendingChangeOrdersModal');
    if (modal) new bootstrap.Modal(modal).show();
    else alert(errorData.message);
  }

  function refreshPage() { location.reload(); }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.collapse').forEach(element => {
      const btn = document.querySelector(`[data-bs-target="#${element.id}"]`);
      if (!btn) return;
      const icon = btn.querySelector('.fas');
      element.addEventListener('shown.bs.collapse', () => { if (icon) { icon.classList.replace('fa-chevron-down', 'fa-chevron-up'); } });
      element.addEventListener('hidden.bs.collapse', () => { if (icon) { icon.classList.replace('fa-chevron-up', 'fa-chevron-down'); } });
    });
  });

  document.addEventListener('hidden.bs.modal', function (event) {
    if (event.target.id === 'changeOrderModal') event.target.remove();
  });
</script>

@section Scripts {
  <style>
    .btn-group-sm .btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
    .table th { border-top: none; font-weight: 600; font-size: 0.875rem; }
    .badge { font-size: 0.75rem; }
    .collapse { transition: height 0.35s ease; }
    /* Sortable column headers */
    #componentsGrid thead th.sortable-col:hover { background-color: #343a40; opacity: 0.9; }
    #componentsGrid thead th.sort-asc  .sort-icon,
    #componentsGrid thead th.sort-desc .sort-icon { opacity: 1 !important; color: #ffc107; }
  </style>
  <script>
    (function () {
      const table = document.getElementById('componentsGrid');
      if (!table) return;

      // Track current sort: { col: index, asc: bool }
      let sortState = { col: 0, asc: true };   // default: Part Number asc (already rendered that way)

      // Mark the default header as sorted
      const headers = table.querySelectorAll('thead th.sortable-col');
      updateHeaderIcons(headers, 0, true);

      headers.forEach(th => {
        th.addEventListener('click', function () {
          const col = parseInt(this.dataset.col);
          const asc = (sortState.col === col) ? !sortState.asc : true;
          sortState = { col, asc };
          sortTable(col, asc);
          updateHeaderIcons(headers, col, asc);
        });
      });

      function sortTable(colIndex, asc) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
          const cellA = a.cells[colIndex];
          const cellB = b.cells[colIndex];

          // Use data-sort attribute for numeric columns (Quantity, Unit Cost, Extended Cost)
          const rawA = cellA.dataset.sort ?? cellA.textContent.trim();
          const rawB = cellB.dataset.sort ?? cellB.textContent.trim();

          const numA = parseFloat(rawA);
          const numB = parseFloat(rawB);
          const isNumeric = !isNaN(numA) && !isNaN(numB);

          let cmp = isNumeric
            ? numA - numB
            : rawA.localeCompare(rawB, undefined, { sensitivity: 'base', numeric: true });

          return asc ? cmp : -cmp;
        });

        rows.forEach(r => tbody.appendChild(r));
      }

      function updateHeaderIcons(headers, activeCol, asc) {
        headers.forEach(th => {
          const icon = th.querySelector('.sort-icon');
          th.classList.remove('sort-asc', 'sort-desc');
          if (icon) {
            icon.classList.remove('fa-sort-up', 'fa-sort-down');
            icon.classList.add('fa-sort');
            icon.classList.add('opacity-50');
          }
          if (parseInt(th.dataset.col) === activeCol) {
            th.classList.add(asc ? 'sort-asc' : 'sort-desc');
            if (icon) {
              icon.classList.remove('fa-sort', 'opacity-50');
              icon.classList.add(asc ? 'fa-sort-up' : 'fa-sort-down');
            }
          }
        });
      }
    })();
  </script>
}
