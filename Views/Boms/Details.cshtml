@model InventorySystem.Models.Bom
@{
	ViewData["Title"] = "BOM Details";
	var totalCost = ViewBag.TotalCost as decimal? ?? 0;
}

<div class="d-flex justify-content-between align-items-center mb-4">
	<div class="d-flex align-items-center">
		<h1 class="me-3"><i class="fas fa-layer-group"></i> @Model.Name</h1>
		<!-- Version Dropdown -->
		@if (ViewBag.BomVersions != null)
		{
			@await Html.PartialAsync("_VersionDropdown", ViewBag.BomVersions, new ViewDataDictionary(ViewData)
			{
			["CurrentVersion"] = Model.Version,
				["EntityType"] = "Boms",
				["EntityId"] = Model.BaseBomId ?? Model.Id
				})
				}
	</div>
	<div class="btn-group">
		@if (Model.IsCurrentVersion)
		{
			<a href="/Boms/Edit/@Model.Id" class="btn btn-outline-primary">
				<i class="fas fa-edit"></i> Edit
			</a>
			<a href="/Boms/AddItem?bomId=@Model.Id" class="btn btn-success">
				<i class="fas fa-plus"></i> Add Component
			</a>
		}
		<a href="/Boms/CostReport/@Model.Id" class="btn btn-outline-info">
			<i class="fas fa-dollar-sign"></i> Cost Report
		</a>
		@if (Model.IsCurrentVersion)
		{
			<a href="/Boms/Create?parentBomId=@Model.Id" class="btn btn-outline-secondary">
				<i class="fas fa-layer-group"></i> Add Sub-Assembly
			</a>
		}
		<!-- Create New Version Button -->
		<button type="button" class="btn btn-outline-warning" onclick="showCreateVersionModal('BOM', @(Model.BaseBomId ?? Model.Id))">
			<i class="fas fa-code-branch"></i> New Version
		</button>
	</div>
</div>

<div class="row">
	<div class="col-md-8">
		<div class="card">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5><i class="fas fa-info-circle"></i> BOM Details</h5>
				<!-- Version Status Badge -->
				@if (Model.IsCurrentVersion)
				{
					<span class="badge bg-success">Current Version</span>
				}
				else
				{
					<span class="badge bg-secondary">Historical Version</span>
				}
			</div>
			<div class="card-body">
				<dl class="row">
					<dt class="col-sm-3">Description:</dt>
					<dd class="col-sm-9">@Model.Description</dd>

					<!-- Version Information -->
					<dt class="col-sm-3">Version:</dt>
					<dd class="col-sm-9">
						<strong>@Model.Version</strong>
						@if (!Model.IsCurrentVersion)
						{
							<small class="text-muted">(Historical)</small>
						}
					</dd>

					@if (Model.CreatedFromChangeOrder != null)
					{
						<dt class="col-sm-3">Change Order:</dt>
						<dd class="col-sm-9">
							<a href="/ChangeOrders/Details/@Model.CreatedFromChangeOrderId" class="text-decoration-none">
								@Model.CreatedFromChangeOrder.ChangeOrderNumber
							</a>
						</dd>
					}

					@if (!string.IsNullOrEmpty(Model.AssemblyPartNumber))
					{
						<dt class="col-sm-3">Assembly P/N:</dt>
						<dd class="col-sm-9">@Model.AssemblyPartNumber</dd>
					}

					<dt class="col-sm-3">Components:</dt>
					<dd class="col-sm-9">
						<span class="badge bg-info">@Model.BomItems.Count</span>
					</dd>

					<dt class="col-sm-3">Sub-Assemblies:</dt>
					<dd class="col-sm-9">
						<span class="badge bg-secondary">@Model.SubAssemblies.Count</span>
					</dd>

					<dt class="col-sm-3">Total Cost:</dt>
					<dd class="col-sm-9">
						<strong class="text-success">@totalCost.ToString("C")</strong>
					</dd>

					<dt class="col-sm-3">Created:</dt>
					<dd class="col-sm-9">@Model.CreatedDate.ToString("MM/dd/yyyy")</dd>

					<dt class="col-sm-3">Last Modified:</dt>
					<dd class="col-sm-9">@Model.ModifiedDate.ToString("MM/dd/yyyy hh:mm tt")</dd>

					@if (Model.ParentBom != null)
					{
						<dt class="col-sm-3">Parent BOM:</dt>
						<dd class="col-sm-9">
							<a href="/Boms/Details/@Model.ParentBomId" class="text-decoration-none">
								@Model.ParentBom.Name
							</a>
						</dd>
					}
				</dl>
			</div>
		</div>

		<!-- Components Section with Version Context -->
		@if (Model.BomItems?.Any() == true)
		{
			<div class="card mt-4">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5><i class="fas fa-cogs"></i> Components (@Model.BomItems.Count)</h5>
					<div>
						<small class="text-muted me-2">For Version @Model.Version</small>
						@if (Model.IsCurrentVersion)
						{
							<a href="/Boms/AddItem?bomId=@Model.Id" class="btn btn-sm btn-success">
								<i class="fas fa-plus"></i> Add Component
							</a>
						}
						else
						{
							<span class="text-muted small">Historical - Read Only</span>
						}
					</div>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-sm">
							<thead>
								<tr>
									<th>Part Number</th>
									<th>Description</th>
									<th>Quantity</th>
									<th>Unit Cost</th>
									<th>Extended Cost</th>
									<th>Reference</th>
									@if (Model.IsCurrentVersion)
									{
										<th>Actions</th>
									}
								</tr>
							</thead>
							<tbody>
								@foreach (var bomItem in Model.BomItems)
								{
									<tr>
										<td>
											<a href="/Items/Details/@bomItem.Item.Id" class="text-decoration-none">
												@bomItem.Item.PartNumber
											</a>
										</td>
										<td>@bomItem.Item.Description</td>
										<td>@bomItem.Quantity</td>
										<td>@bomItem.UnitCost.ToString("C")</td>
										<td>@bomItem.ExtendedCost.ToString("C")</td>
										<td>@bomItem.ReferenceDesignator</td>
										@if (Model.IsCurrentVersion)
										{
											<td>
												<div class="btn-group btn-group-sm">
													<form asp-action="RemoveItem" method="post" style="display:inline;">
														<input type="hidden" name="bomItemId" value="@bomItem.Id" />
														<input type="hidden" name="bomId" value="@Model.Id" />
														<button type="submit" class="btn btn-outline-danger"
																		onclick="return confirm('Remove this item from the BOM?')"
																		title="Remove Item">
															<i class="fas fa-trash"></i>
														</button>
													</form>
												</div>
											</td>
										}
									</tr>
								}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		}
		else
		{
			<div class="card mb-4">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5><i class="fas fa-cogs"></i> Components</h5>
					@if (Model.IsCurrentVersion)
					{
						<a href="/Boms/AddItem?bomId=@Model.Id" class="btn btn-sm btn-success">
							<i class="fas fa-plus"></i> Add Component
						</a>
					}
				</div>
				<div class="card-body text-center">
					<i class="fas fa-cogs fa-3x text-muted mb-3"></i>
					<h5 class="text-muted">No Components Added</h5>
					<p class="text-muted">
						@if (Model.IsCurrentVersion)
						{
							<span>Start building your BOM by adding components.</span>
						}
						else
						{
							<span>No components were added to Version @Model.Version</span>
						}
					</p>
					@if (Model.IsCurrentVersion)
					{
						<a href="/Boms/AddItem?bomId=@Model.Id" class="btn btn-success">
							<i class="fas fa-plus"></i> Add First Component
						</a>
					}
				</div>
			</div>
		}

		<!-- Sub-Assemblies Section -->
		@if (Model.SubAssemblies.Any())
		{
			<div class="card mb-4">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5><i class="fas fa-layer-group"></i> Sub-Assemblies (@Model.SubAssemblies.Count)</h5>
					@if (Model.IsCurrentVersion)
					{
						<a href="/Boms/Create?parentBomId=@Model.Id" class="btn btn-sm btn-outline-secondary">
							<i class="fas fa-plus"></i> Add Sub-Assembly
						</a>
					}
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-sm">
							<thead>
								<tr>
									<th>Sub-Assembly Name</th>
									<th>Assembly P/N</th>
									<th>Version</th>
									<th>Components</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var subAssembly in Model.SubAssemblies)
								{
									<tr>
										<td><a href="/Boms/Details/@subAssembly.Id">@subAssembly.Name</a></td>
										<td>@subAssembly.AssemblyPartNumber</td>
										<td>@subAssembly.Version</td>
										<td><span class="badge bg-info">@subAssembly.BomItems.Count</span></td>
										<td>
											<div class="btn-group btn-group-sm">
												<a href="/Boms/Details/@subAssembly.Id" class="btn btn-outline-primary" title="View Details">
													<i class="fas fa-eye"></i>
												</a>
												<a href="/Boms/CostReport/@subAssembly.Id" class="btn btn-outline-success" title="Cost Report">
													<i class="fas fa-dollar-sign"></i>
												</a>
											</div>
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		}
	</div>

	<div class="col-md-4">
		<div class="card">
			<div class="card-header">
				<h5><i class="fas fa-info-circle"></i> BOM Summary</h5>
			</div>
			<div class="card-body">
				<dl class="row">
					<dt class="col-sm-5">Created:</dt>
					<dd class="col-sm-7">@Model.CreatedDate.ToString("MM/dd/yyyy")</dd>

					<!-- Version Information -->
					<dt class="col-sm-5">Version:</dt>
					<dd class="col-sm-7">
						<span class="badge bg-primary">@Model.Version</span>
						@if (!Model.IsCurrentVersion)
						{
							<br>
						
							<small class="text-muted">Historical Version</small>
						}
					</dd>

					<dt class="col-sm-5">Total Versions:</dt>
					<dd class="col-sm-7">
						<span class="badge bg-info">@(ViewBag.BomVersions?.Count() ?? 1)</span>
					</dd>

					<dt class="col-sm-5">Components:</dt>
					<dd class="col-sm-7">
						<span class="badge bg-info">@Model.BomItems.Count</span>
					</dd>

					<dt class="col-sm-5">Sub-Assemblies:</dt>
					<dd class="col-sm-7">
						<span class="badge bg-secondary">@Model.SubAssemblies.Count</span>
					</dd>

					<dt class="col-sm-5">Total Cost:</dt>
					<dd class="col-sm-7">
						<strong class="text-success">@totalCost.ToString("C")</strong>
					</dd>

					<dt class="col-sm-5">Last Modified:</dt>
					<dd class="col-sm-7">@Model.ModifiedDate.ToString("MM/dd/yyyy")</dd>
				</dl>
			</div>
		</div>

		<!-- Version History Card -->
		@if (ViewBag.BomVersions != null && ((IEnumerable<dynamic>)ViewBag.BomVersions).Count() > 1)
		{
			<div class="card mt-3">
				<div class="card-header">
					<h6><i class="fas fa-history"></i> Version History</h6>
				</div>
				<div class="card-body">
					<div class="list-group list-group-flush">
						@foreach (var version in (IEnumerable<dynamic>)ViewBag.BomVersions)
						{
							<div class="list-group-item d-flex justify-content-between align-items-center @(version.Version == Model.Version ? "active" : "")">
								<div>
									<strong>@version.Version</strong>
									@if (version.IsCurrentVersion)
									{
										<span class="badge bg-success ms-2">Current</span>
									}
									<br>
									<small class="text-muted">@version.CreatedDate.ToString("MM/dd/yyyy")</small>
								</div>
								@if (version.Version != Model.Version)
								{
									<a href="/Boms/Details/@version.Id" class="btn btn-sm btn-outline-primary">View</a>
								}
							</div>
						}
					</div>
				</div>
			</div>
		}

		<!-- Quick Material Check Section -->
		<div class="card mt-4">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5><i class="fas fa-exclamation-triangle text-warning"></i> Material Check</h5>
				<button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#materialCheck" aria-expanded="false">
					<i class="fas fa-eye"></i> Check
				</button>
			</div>
			<div class="collapse" id="materialCheck">
				<div class="card-body">
					<p class="text-muted small">Check if sufficient materials are available for this BOM:</p>
					@if (Model.BomItems.Any())
					{
						<div class="list-group list-group-flush">
							@foreach (var bomItem in Model.BomItems.Take(5))
							{
								<div class="list-group-item d-flex justify-content-between align-items-center py-2">
									<small>
										<strong>@bomItem.Item.PartNumber</strong><br>
										Need: @bomItem.Quantity
									</small>
									<span class="badge bg-@(bomItem.Item.CurrentStock >= bomItem.Quantity ? "success" : "danger")">
										@bomItem.Item.CurrentStock
									</span>
								</div>
							}
							@if (Model.BomItems.Count > 5)
							{
								<div class="list-group-item text-center">
									<small class="text-muted">... and @(Model.BomItems.Count - 5) more items</small>
								</div>
							}
						</div>
					}
					else
					{
						<p class="text-muted text-center">No components to check</p>
					}
				</div>
			</div>
		</div>
	</div>
</div>

<div class="mt-3">
	<a href="/Boms" class="btn btn-secondary">Back to BOMs</a>
</div>

<script>
	function showCreateVersionModal(entityType, entityId) {
		console.log(`Attempting to load modal for ${entityType} ID: ${entityId}`);

		// Load the change order modal
		fetch(`/ChangeOrders/Create/${entityType}/${entityId}`)
			.then(response => {
				console.log(`Response status: ${response.status}`);
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				return response.text();
			})
			.then(html => {
				console.log('Modal HTML loaded successfully');
				document.body.insertAdjacentHTML('beforeend', html);
				const modal = new bootstrap.Modal(document.getElementById('changeOrderModal'));
				modal.show();
			})
			.catch(error => {
				console.error('Error loading modal:', error);
				alert('Error loading change order form: ' + error.message);
			});
	}

	// Clean up modal when closed
	document.addEventListener('hidden.bs.modal', function (event) {
		if (event.target.id === 'changeOrderModal') {
			event.target.remove();
		}
	});
</script>