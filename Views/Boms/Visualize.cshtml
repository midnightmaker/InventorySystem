@model InventorySystem.Models.Bom
@{
    ViewData["Title"] = $"BOM Visualization - {Model.BomNumber}";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-sitemap"></i> BOM Visualization - @Model.BomNumber</h1>
    <div class="btn-group">
        <a href="/Boms/Details/@Model.Id" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Details
        </a>
        <button onclick="exportDiagram()" class="btn btn-outline-primary">
            <i class="fas fa-download"></i> Export PNG
        </button>
        <a href="/Boms/ExportExcel/@Model.Id" class="btn btn-outline-success" data-loading-ignore>
            <i class="fas fa-file-excel"></i> Export Excel
        </a>
        <button onclick="printDiagram()" class="btn btn-outline-info">
            <i class="fas fa-print"></i> Print
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <h5><i class="fas fa-project-diagram"></i> Interactive BOM Tree</h5>
                <div class="btn-group btn-group-sm">
                    <button onclick="expandAll()" class="btn btn-outline-success">
                        <i class="fas fa-expand"></i> Expand All
                    </button>
                    <button onclick="collapseAll()" class="btn btn-outline-warning">
                        <i class="fas fa-compress"></i> Collapse All
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="bomDiagram" style="width: 100%; height: 600px; border: 1px solid #ddd; overflow: auto; padding-bottom: 50px;">
                    <!-- BOM tree will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> BOM Summary</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-6">BOM:</dt>
                    <dd class="col-6">@Model.BomNumber</dd>
                    
                    <dt class="col-6">Version:</dt>
                    <dd class="col-6">@Model.Version</dd>
                    
                    <dt class="col-6">Components:</dt>
                    <dd class="col-6">@Model.BomItems.Count</dd>
                    
                    <dt class="col-6">Sub-BOMs:</dt>
                    <dd class="col-6">@Model.SubAssemblies.Count</dd>
                </dl>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-palette"></i> Display Options</h6>
            </div>
            <div class="card-body">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="showQuantities" checked>
                    <label class="form-check-label" for="showQuantities">
                        Show Quantities
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="showPartNumbers" checked>
                    <label class="form-check-label" for="showPartNumbers">
                        Show Part Numbers
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="showCosts">
                    <label class="form-check-label" for="showCosts">
                        Show Costs
                    </label>
                </div>
                <hr>
                <label class="form-label">Zoom Level</label>
                <input type="range" class="form-range" id="zoomRange" min="0.5" max="2" step="0.1" value="1">
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-list"></i> Component Legend</h6>
            </div>
            <div class="card-body">
                <div class="legend-item mb-2">
                    <i class="fas fa-cube text-primary"></i> <small>Assembly</small>
                </div>
                <div class="legend-item mb-2">
                    <i class="fas fa-layer-group text-info"></i> <small>Sub-Assembly</small>
                </div>
                <div class="legend-item mb-2">
                    <i class="fas fa-cube text-success"></i> <small>Inventoried Item</small>
                </div>
                <div class="legend-item mb-2">
                    <i class="fas fa-microchip text-info"></i> <small>Non-Inventoried</small>
                </div>
                <div class="legend-item mb-2">
                    <i class="fas fa-tools text-warning"></i> <small>Service</small>
                </div>
                <div class="legend-item">
                    <i class="fas fa-cloud text-primary"></i> <small>Virtual</small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .bom-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bom-node:hover {
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .assembly-node {
            border-left: 3px solid #007bff;
            padding-left: 15px;
            margin: 5px 0;
        }
        
        .sub-assembly-node {
            border-left: 3px solid #17a2b8;
            padding-left: 15px;
            margin: 5px 0;
        }
        
        .component-node {
            border-left: 2px solid #28a745;
            padding-left: 15px;
            margin: 3px 0;
        }
        
        .node-content {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: white;
            margin-bottom: 5px;
        }
        
        .node-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }
        
        .node-details {
            flex-grow: 1;
        }
        
        .node-title {
            font-weight: 600;
            color: #495057;
        }
        
        .node-subtitle {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .node-quantity {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .node-cost {
            display: none; /* hidden by default — matches showCosts checkbox starting unchecked */
        }
        
        .collapsible {
            background: none;
            border: none;
            outline: none;
            color: #007bff;
            font-size: 0.9em;
            margin-left: 5px;
            cursor: pointer;
        }
        
        .collapsible:hover {
            color: #0056b3;
        }
        
        .hidden {
            display: none !important;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #bomDiagram {
            transform-origin: top left;
            transition: transform 0.3s ease;
        }
        
        .bom-end-indicator {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            color: #6c757d;
            font-style: italic;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .bom-end-indicator i {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }
    </style>
}

@section Scripts {
<script type="text/javascript">
    (function() {
        'use strict';

        if (window.bomVisualizationLoaded) return;
        window.bomVisualizationLoaded = true;

        // BOM data from server
        let bomData = {};

        try {
            bomData = @Html.Raw(ViewBag.JsonData ?? "{}");
        } catch (error) {
            bomData = {
                id: @Model.Id,
                bomNumber: '@Html.Raw(Model.BomNumber ?? "")',
                description: '@Html.Raw(Model.Description ?? "")',
                version: '@Html.Raw(Model.Version ?? "")',
                bomItems: [],
                subAssemblies: []
            };
        }

        function renderBomTree() {
            const container = document.getElementById('bomDiagram');
            if (!container) return;

            if (!bomData || (!bomData.bomItems && !bomData.subAssemblies)) {
                container.innerHTML = `
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h5>No BOM Data Available</h5>
                        <p>This BOM has no components or sub-assemblies to display.</p>
                        <a href="/Boms/Edit/@Model.Id" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Components
                        </a>
                    </div>
                `;
                return;
            }

            try {
                const endIndicator = `
                    <div class="bom-end-indicator">
                        <i class="fas fa-flag-checkered"></i>
                        <strong>End of BOM</strong><br>
                        <small>Complete Bill of Materials for ${bomData.bomNumber || 'Assembly'}</small>
                    </div>
                `;
                container.innerHTML = generateTreeHTML(bomData) + endIndicator;
                setupCollapsibleHandlers();
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                        <h5>Error Loading BOM Diagram</h5>
                        <p>There was an error loading the BOM visualization.</p>
                        <p><small>${error.message}</small></p>
                        <button onclick="location.reload()" class="btn btn-primary">
                            <i class="fas fa-refresh"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        function setupCollapsibleHandlers() {
            document.querySelectorAll('.collapsible').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const target = document.getElementById(this.getAttribute('data-target'));
                    if (target) {
                        const isHidden = target.classList.contains('hidden');
                        target.classList.toggle('hidden');
                        this.innerHTML = isHidden ? '<i class="fas fa-minus"></i>' : '<i class="fas fa-plus"></i>';
                    }
                });
            });
        }

        function generateTreeHTML(bom, level = 0, parentId = '') {
            if (!bom) return '<div class="alert alert-warning">No BOM data available</div>';

            const nodeId = `node_${parentId}_${bom.id || Date.now()}`;
            const hasChildren = (bom.bomItems && bom.bomItems.length > 0) ||
                                (bom.subAssemblies && bom.subAssemblies.length > 0);

            let html = '';

            if (level === 0) {
                html += `
                    <div class="assembly-node">
                        <div class="node-content">
                            <i class="fas fa-cube node-icon text-primary"></i>
                            <div class="node-details">
                                <div class="node-title">${bom.bomNumber || 'Main Assembly'}</div>
                                <div class="node-subtitle">${bom.description || ''}</div>
                                ${bom.version ? `<small class="text-muted">Version: ${bom.version}</small>` : ''}
                            </div>
                            ${hasChildren ? `<button class="collapsible" data-target="${nodeId}_children"><i class="fas fa-minus"></i></button>` : ''}
                        </div>
                `;
            }

            if (hasChildren) {
                html += `<div id="${nodeId}_children" class="ms-3">`;

                if (bom.subAssemblies && Array.isArray(bom.subAssemblies)) {
                    bom.subAssemblies.forEach((subAssembly, index) => {
                        if (subAssembly) {
                            const subNodeId = `${nodeId}_sub_${index}`;
                            const subHasChildren = (subAssembly.bomItems && subAssembly.bomItems.length > 0) ||
                                                   (subAssembly.subAssemblies && subAssembly.subAssemblies.length > 0);
                            html += `
                                <div class="sub-assembly-node mt-2">
                                    <div class="node-content">
                                        <i class="fas fa-layer-group node-icon text-info"></i>
                                        <div class="node-details">
                                            <div class="node-title">${subAssembly.bomNumber || 'Sub-Assembly'}</div>
                                            <div class="node-subtitle">${subAssembly.description || ''}</div>
                                        </div>
                                        ${subHasChildren ? `<button class="collapsible" data-target="${subNodeId}_children"><i class="fas fa-minus"></i></button>` : ''}
                                    </div>
                                    ${subHasChildren ? `<div id="${subNodeId}_children" class="ms-3">${generateTreeHTML(subAssembly, level + 1, subNodeId)}</div>` : ''}
                                </div>
                            `;
                        }
                    });
                }

                if (bom.bomItems && Array.isArray(bom.bomItems)) {
                    bom.bomItems.forEach((item, index) => {
                        if (item && item.item) {
                            try {
                                const iconClass = getComponentIcon(item.item?.itemType);
                                // Render all optional fields unconditionally — visibility is
                                // controlled live via data-display attributes, not at build time.
                                const hasCost     = item.unitCost != null;
                                const hasPartNum  = !!item.item?.partNumber;

                                html += `
                                    <div class="component-node">
                                        <div class="node-content">
                                            <i class="${iconClass} node-icon"></i>
                                            <div class="node-details">
                                                <div class="node-title">${item.item?.description || 'Component'}</div>
                                                ${hasPartNum ? `<div class="node-subtitle node-part-number">PN: ${item.item.partNumber}</div>` : ''}
                                                ${hasCost ? `<div class="node-subtitle node-cost">Cost: $${Number(item.unitCost).toFixed(2)}</div>` : ''}
                                                ${item.referenceDesignator ? `<small class="text-muted">Ref: ${item.referenceDesignator}</small>` : ''}
                                            </div>
                                            <span class="node-quantity">Qty: ${item.quantity || 0}</span>
                                        </div>
                                    </div>
                                `;
                            } catch (error) {
                                html += `
                                    <div class="component-node">
                                        <div class="node-content">
                                            <i class="fas fa-cube text-muted node-icon"></i>
                                            <div class="node-details">
                                                <div class="node-title">${item.item?.description || 'Component'}</div>
                                                <div class="node-subtitle text-danger">Error loading component data</div>
                                            </div>
                                            <span class="node-quantity">Qty: ${item.quantity || 0}</span>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    });
                }

                html += '</div>';
            }

            if (level === 0) html += '</div>';

            return html;
        }

        // Apply the current checkbox states to the already-rendered tree without rebuilding it.
        function applyDisplayOptions() {
            const showQty      = document.getElementById('showQuantities')?.checked ?? true;
            const showPartNum  = document.getElementById('showPartNumbers')?.checked ?? true;
            const showCost     = document.getElementById('showCosts')?.checked ?? false;

            document.querySelectorAll('#bomDiagram .node-quantity').forEach(el => {
                el.style.display = showQty ? 'inline-block' : 'none';
            });
            document.querySelectorAll('#bomDiagram .node-part-number').forEach(el => {
                el.style.display = showPartNum ? 'block' : 'none';
            });
            document.querySelectorAll('#bomDiagram .node-cost').forEach(el => {
                el.style.display = showCost ? 'block' : 'none';
            });
        }

        function getCheckboxState(id, defaultValue) {
            const element = document.getElementById(id);
            return element ? element.checked : defaultValue;
        }

        function getComponentIcon(itemType) {
            if (itemType === null || itemType === undefined) return 'fas fa-cube text-muted';

            let itemTypeStr = '';
            if (typeof itemType === 'number') {
                switch (itemType) {
                    case 0: itemTypeStr = 'inventoried'; break;
                    case 1: itemTypeStr = 'noninventoried'; break;
                    case 2: itemTypeStr = 'service'; break;
                    case 3: itemTypeStr = 'virtual'; break;
                    default: itemTypeStr = 'unknown'; break;
                }
            } else if (typeof itemType === 'string') {
                itemTypeStr = itemType.toLowerCase();
            } else {
                itemTypeStr = 'unknown';
            }

            switch (itemTypeStr) {
                case 'inventoried':
                case 'inventoried item':
                case 'physical':
                    return 'fas fa-cube text-success';
                case 'noninventoried':
                case 'non-inventoried':
                case 'firmware':
                case 'software':
                    return 'fas fa-microchip text-info';
                case 'service':
                case 'labor':
                    return 'fas fa-tools text-warning';
                case 'virtual':
                case 'license':
                case 'digital':
                    return 'fas fa-cloud text-primary';
                case 'electronic':
                    return 'fas fa-microchip text-warning';
                case 'mechanical':
                    return 'fas fa-cog text-success';
                case 'hardware':
                    return 'fas fa-tools text-secondary';
                case 'cable':
                    return 'fas fa-plug text-info';
                default:
                    return 'fas fa-cube text-muted';
            }
        }

        function expandAll() {
            document.querySelectorAll('#bomDiagram [id$="_children"]').forEach(el => {
                el.classList.remove('hidden');
            });
            document.querySelectorAll('#bomDiagram .collapsible').forEach(btn => {
                btn.innerHTML = '<i class="fas fa-minus"></i>';
            });
        }

        function collapseAll() {
            const rootChildrenId = `node__${bomData.id || ''}_children`;
            document.querySelectorAll('#bomDiagram [id$="_children"]').forEach(el => {
                if (el.id !== rootChildrenId) el.classList.add('hidden');
            });
            document.querySelectorAll('#bomDiagram .collapsible').forEach(btn => {
                const targetId = btn.getAttribute('data-target');
                if (targetId && targetId !== rootChildrenId) btn.innerHTML = '<i class="fas fa-plus"></i>';
            });
        }

        function exportDiagram() {
            const diagram = document.getElementById('bomDiagram');
            if (!diagram) return;

            // Remember which children were hidden so we can restore them
            const hiddenIds = Array.from(diagram.querySelectorAll('[id$="_children"].hidden'))
                .map(el => el.id);

            // Remember the current scroll position and transform
            const scrollTop  = diagram.scrollTop;
            const scrollLeft = diagram.scrollLeft;
            const prevTransform = diagram.style.transform;

            // Temporarily expand everything and remove scroll constraints for full capture
            diagram.querySelectorAll('[id$="_children"]').forEach(el => el.classList.remove('hidden'));
            diagram.querySelectorAll('.collapsible').forEach(btn => {
                btn.innerHTML = '<i class="fas fa-minus"></i>';
            });
            diagram.style.transform  = 'none';
            diagram.style.height     = 'auto';
            diagram.style.overflow   = 'visible';

            const bomNumber = (bomData.bomNumber || 'BOM').replace(/[^a-zA-Z0-9_-]/g, '_');
            const fileName  = `BOM_${bomNumber}_${new Date().toISOString().slice(0, 10)}.png`;

            // Small delay so the DOM reflows before capture
            setTimeout(() => {
                html2canvas(diagram, {
                    backgroundColor: '#ffffff',
                    scale: 2,           // 2× for sharper output
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0
                }).then(canvas => {
                    // Trigger download
                    const link = document.createElement('a');
                    link.download = fileName;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => {
                    alert('Export failed: ' + err.message);
                }).finally(() => {
                    // Restore original state
                    hiddenIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('hidden');
                    });
                    diagram.querySelectorAll('.collapsible').forEach(btn => {
                        const targetId = btn.getAttribute('data-target');
                        if (targetId && hiddenIds.includes(targetId)) {
                            btn.innerHTML = '<i class="fas fa-plus"></i>';
                        }
                    });
                    diagram.style.transform = prevTransform;
                    diagram.style.height    = '600px';
                    diagram.style.overflow  = 'auto';
                    diagram.scrollTop  = scrollTop;
                    diagram.scrollLeft = scrollLeft;
                });
            }, 100);
        }

        function printDiagram() {
            window.print();
        }

        window.expandAll = expandAll;
        window.collapseAll = collapseAll;
        window.exportDiagram = exportDiagram;
        window.printDiagram = printDiagram;

        document.addEventListener('DOMContentLoaded', function() {
            renderBomTree();

            // Apply initial display options (costs hidden by default)
            applyDisplayOptions();

            // Update display in-place when options change — no re-render needed
            ['showQuantities', 'showPartNumbers', 'showCosts'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.addEventListener('change', applyDisplayOptions);
            });

            const zoomElement = document.getElementById('zoomRange');
            if (zoomElement) {
                zoomElement.addEventListener('input', function() {
                    document.getElementById('bomDiagram').style.transform = `scale(${this.value})`;
                });
            }
        });

    })();
</script>
}